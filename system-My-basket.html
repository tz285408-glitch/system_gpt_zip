<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title> Ù†Ø¸Ø§Ù…   Ø³Ù„ØªÙŠ ğŸ›’</title>
<script src="https://unpkg.com/html5-qrcode"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Tajawal&display=swap');
body{font-family:"Tajawal",sans-serif;direction:rtl;background:#f0f8ff;margin:0;padding:0;}
h2,h3{text-align:center;color:#0d6efd;margin:15px 0;}
.container{width:95%;max-width:1200px;margin:auto;padding:15px;}
input, button{padding:10px;border-radius:8px;border:1px solid #ccc;font-size:16px;}
button{cursor:pointer;background:#0d6efd;color:#fff;border:none;}
button:hover{background:#084298;}
table{width:100%;border-collapse:collapse;margin-top:15px;font-size:14px;}
th,td{border:1px solid #ccc;padding:8px;text-align:center;white-space:normal;overflow-wrap:break-word;}
th{background:#0d6efd;color:#fff;cursor:pointer;}
tr:nth-child(even){background:#e7f1ff;}
.table-container{overflow-x:auto;width:100%;}
#reader,#readerCart{width:100%;margin:10px auto;display:none;}
.autocomplete{border:1px solid #ccc;border-radius:8px;max-height:150px;overflow-y:auto;background:#fff;position:absolute;z-index:1000;width:95%;}
.autocomplete div{padding:8px;cursor:pointer;}
.autocomplete div:hover{background:#d0e4ff;}
#cartMessage{color:#155724;background:#d4edda;padding:10px;margin-top:10px;border-radius:8px;display:none;text-align:center;}

header {
  background: #007bff;
  color: white;
  padding: 15px;
  text-align: center;
}
nav {
  background: #e9ecef;
  display: flex;
  justify-content: space-around;
  padding: 10px;
}
nav button {
  padding: 10px 20px;
  border: none;
  background: #007bff;
  color: white;
  border-radius: 5px;
  cursor: pointer;
  transition: background 0.3s;
}
nav button:hover {
  background: #0056b3;
}
.content {
  padding: 20px;
}
.form-section {
  display: none;
  background: white;
  padding: 20px;
  border-radius: 10px;
  box-shadow: 0 0 5px #ccc;
  margin-top: 20px;
}
label {
  display: block;
  margin-top: 10px;
}
input, select {
  width: 100%;
  padding: 8px;
  margin-top: 5px;
  border: 1px solid #ccc;
  border-radius: 5px;
}

/* ===== ØªØ­Ø³ÙŠÙ† Ù…Ø¸Ù‡Ø± Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù„Ù„Ù‡ÙˆØ§ØªÙ ===== */
.table-container {
  overflow-x: auto;
  width: 100%;
}
table {
  width: 100%;
  border-collapse: collapse;
  font-size: 12px;
  margin-top: 5px;
}
td, th {
  padding: 5px;
  border: 1px solid #ddd;
  text-align: center;
}
/* Ø§Ù„ØªÙØ§Ù Ø§Ù„Ù†Øµ */
td {
  white-space: normal;
  word-wrap: break-word;
}
/* Ø¶Ø¨Ø· Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© */
#cartTable td:nth-child(1) { width: 200px; }
#cartTable td:nth-child(2) { width: 150px; word-break: break-all; }
#cartTable th:nth-child(3), #cartTable td:nth-child(3) { width: 80px; white-space: nowrap; }
</style>
</head>
<body>
<header>
  <h2>ğŸ‘¨â€ğŸ’» Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³/Ø¹Ø±ÙØ§Øª Ø§Ø­Ù…Ø¯ Ø§Ù„Ø¯Ø¨ÙˆØ§Ù†ÙŠ</h2>
</header>

<nav>
  <button onclick="showSection('ahmad')">Ø³Ù„ØªÙŠ ğŸ›’</button>
</nav>

<div class="container">

  <!-- Ø§Ù„Ø³Ù„Ø© -->
  <section id="ahmad" class="form-section">
    <div style="position:relative; display:flex; gap:10px; align-items:center;">
      <input type="text" id="searchCart" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ØµÙ†Ù Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ø±Ù…Ø²" style="flex:1;">
      <button type="button" id="scanCartBtn">ğŸ“· Ù…Ø³Ø­ Ø±Ù…Ø²</button>
      <div id="autocompleteCart" class="autocomplete" style="right:0;"></div>
    </div>

    <div id="readerCart" style="margin-top:10px; display:none;"></div>

    <div id="itemInfoCart" style="display:none;margin-top:10px;">
      <p>Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù: <span id="infoNameCart"></span></p>
      <p>Ø±Ù…Ø² Ø§Ù„ØµÙ†Ù: <span id="infoCodeCart"></span></p>
      <p>Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹: <span id="infoPriceCart"></span></p>
      <label>Ø§Ù„ÙƒÙ…ÙŠØ©:</label>
      <input type="number" id="itemQtyCart" value="1" min="1" style="width:120px;">
      <button id="addCartBtn" style="margin-top:6px;">â• Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø¹Ø±Ø¨Ø©</button>
    </div>

    <button id="newCartBtn" style="background:#28a745;margin-top:10px;">ğŸ†• Ø³Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>
    <div id="cartMessage"></div>

    <div class="table-container" style="margin-top:10px;">
      <table id="cartTable">
        <thead>
          <tr>
            <th>Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù</th>
            <th>Ø±Ù…Ø² Ø§Ù„ØµÙ†Ù</th>
            <th>Ø§Ù„Ø³Ø¹Ø±</th>
            <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
            <th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
            <th>Ø­Ø°Ù</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div id="summary" style="margin-top:10px;">Ø¹Ø¯Ø¯ Ø§Ù„Ù‚Ø·Ø¹: 0 | Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: 0</div>
  </section>

</div>

<script>
// ===== Ø¯Ø§Ù„Ø© ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø¨Ø¥Ø¶Ø§ÙØ© ÙÙˆØ§ØµÙ„ Ø§Ù„Ø¢Ù„Ø§Ù (Ù…Ø«Ø§Ù„: 1000 -> "1,000") =====
function formatWithThousandsSeparator(value) {
  // Ù†Ø­Ø§ÙØ¸ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø¯Ø§Ø®Ù„ Ø§Ù„ÙƒÙˆØ¯ ÙƒØ£Ø±Ù‚Ø§Ù… Ù„ÙƒÙ† Ù†Ø¹Ø±Ø¶Ù‡Ø§ ÙƒØ³Ù„Ø§Ø³Ù„ Ø¨Ù…Ø­Ø¯Ø¯ Ø¢Ù„Ø§Ù
  const num = Number(value);
  if (!isFinite(num)) return String(value);
  const parts = String(num).split('.');
  const intPart = parts[0];
  const decPart = parts[1] ? '.' + parts[1] : '';
  const intWithSep = intPart.replace(/\B(?=(\d{3})+(?!\d))/g, ',');
  return intWithSep + decPart;
}

// ================= Ù…Ø§Ø³Ø­ QR Ù„Ù„Ø³Ù„Ø© =================
let isScanningCart = false;
const readerCart = document.getElementById("readerCart");
const scanCartBtn = document.getElementById("scanCartBtn");
const qrCart = new Html5Qrcode("readerCart");

scanCartBtn.onclick = async () => {
  if (!isScanningCart) {
    try {
      const cams = await Html5Qrcode.getCameras();
      if (!cams.length) return alert("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ÙƒØ§Ù…ÙŠØ±Ø§");
      let cam = cams.find(c => c.label && c.label.toLowerCase().includes("back"))?.id || cams[0].id;
      readerCart.style.display = "block";
      await qrCart.start(cam, { fps: 15, qrbox: { width: 200, height: 120 } },
        (decoded) => {
          try {
            const itemsList = JSON.parse(localStorage.getItem("itemsList") || "[]");
            const item = itemsList.find(i => String(i.code) === String(decoded));
            if (item) showCartItem(item);
            else alert("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„ØµÙ†Ù Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø±Ù…Ø²");
          } catch (e) {
            alert("Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: " + e.message);
          }
          qrCart.stop().catch(() => {});
          readerCart.style.display = "none";
          scanCartBtn.textContent = "ğŸ“· Ù…Ø³Ø­";
          isScanningCart = false;
        },
        (error) => {}
      );
      isScanningCart = true;
      scanCartBtn.textContent = "â¹ï¸ Ø¥ÙŠÙ‚Ø§Ù";
    } catch (e) {
      alert("Ø®Ø·Ø£ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§: " + (e.message || e));
      readerCart.style.display = "none";
    }
  } else {
    qrCart.stop().catch(() => {});
    readerCart.style.display = "none";
    scanCartBtn.textContent = "ğŸ“· Ù…Ø³Ø­";
    isScanningCart = false;
  }
};

// ================ Ø¹Ø±Ø¶ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… =================
function showSection(id) {
  document.querySelectorAll('.form-section').forEach(s => s.style.display = 'none');
  const el = document.getElementById(id);
  if (el) el.style.display = 'block';
}

// ================= Ø§Ù„Ø³Ù„Ø© =================
let cart = [];
const searchCart = document.getElementById("searchCart");
const autocompleteCart = document.getElementById("autocompleteCart");
const itemInfoCart = document.getElementById("itemInfoCart");
const infoNameCart = document.getElementById("infoNameCart");
const infoCodeCart = document.getElementById("infoCodeCart");
const infoPriceCart = document.getElementById("infoPriceCart");
const itemQtyCart = document.getElementById("itemQtyCart");
const addCartBtn = document.getElementById("addCartBtn");
const cartTableBody = document.querySelector("#cartTable tbody");
const summary = document.getElementById("summary");
const newCartBtn = document.getElementById("newCartBtn");
const cartMessage = document.getElementById("cartMessage");
let selectedCartItem = null;

function showCartItem(item) {
  selectedCartItem = item;
  itemInfoCart.style.display = "block";
  infoNameCart.textContent = item.name || "";
  infoCodeCart.textContent = item.code || "";
  // Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¹Ø± Ù…Ù†Ø³Ù‚Ù‹Ø§ Ø¨ÙÙˆØ§ØµÙ„ Ø§Ù„Ø¢Ù„Ø§Ù (Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙˆØ¬ÙˆØ¯Ù‹Ø§)
  infoPriceCart.textContent = (item.price != null) ? formatWithThousandsSeparator(item.price) : "";
  itemQtyCart.value = 1;
}

searchCart.addEventListener("input", () => {
  const val = (searchCart.value || "").toLowerCase().trim();
  autocompleteCart.innerHTML = "";
  if (!val) return;
  const itemsList = JSON.parse(localStorage.getItem("itemsList") || "[]");
  itemsList.filter(i => (i.name || "").toLowerCase().includes(val) || String(i.code).includes(val))
  .forEach(i => {
    const div = document.createElement("div");
    div.textContent = `${i.name} (${i.code})`;
    div.onclick = () => {
      showCartItem(i);
      autocompleteCart.innerHTML = "";
      searchCart.value = "";
    };
    autocompleteCart.appendChild(div);
  });
});

addCartBtn.addEventListener("click", () => {
  if (!selectedCartItem) return alert("Ø§Ø®ØªØ± ØµÙ†ÙØ§Ù‹ Ø£ÙˆÙ„Ø§Ù‹");
  const qty = Number(itemQtyCart.value) || 0; if (qty < 1) return alert("Ø§Ù„ÙƒÙ…ÙŠØ© ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† 1 Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„");
  // ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ø³Ø¹Ø± Ù‚ÙŠÙ…Ø© Ø±Ù‚Ù…ÙŠØ©
  const price = Number(selectedCartItem.price) || 0;
  const exists = cart.find(c => String(c.code) === String(selectedCartItem.code));
  if (exists) {
    exists.qty += qty;
  } else {
    cart.push({ ...selectedCartItem, qty, price });
  }
  updateCartTable();
  hideCartItem();
});

function updateCartTable() {
  cartTableBody.innerHTML = "";
  let totalQty = 0, totalPrice = 0;
  cart.forEach((c, i) => {
    const price = Number(c.price) || 0;
    const subtotal = price * (Number(c.qty) || 0);
    totalQty += Number(c.qty) || 0;
    totalPrice += subtotal;
    const row = document.createElement("tr");
    row.innerHTML = `<td>${c.name || ""}</td>
      <td>${c.code || ""}</td>
      <td>${formatWithThousandsSeparator(price)}</td>
      <td><input type="number" value="${c.qty}" min="1" onchange="changeQty(${i},this.value)" style="width:70px;"></td>
      <td>${formatWithThousandsSeparator(subtotal)}</td>
      <td><button onclick="deleteCartItem(${i})" style="background:#dc3545;">ğŸ—‘ï¸</button></td>`;
    cartTableBody.appendChild(row);
  });
  summary.textContent = `Ø¹Ø¯Ø¯ Ø§Ù„Ù‚Ø·Ø¹: ${totalQty} | Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${formatWithThousandsSeparator(totalPrice)}`;
}

function changeQty(i, v) { v = Number(v); if (v < 1) return; cart[i].qty = v; updateCartTable(); }
function deleteCartItem(i) { cart.splice(i, 1); updateCartTable(); }

function hideCartItem() {
  selectedCartItem = null;
  itemInfoCart.style.display = "none";
  infoNameCart.textContent = "";
  infoCodeCart.textContent = "";
  infoPriceCart.textContent = "";
  itemQtyCart.value = 1;
}

newCartBtn.addEventListener("click", () => {
  if (confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ù†Ø´Ø§Ø¡ Ø³Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©ØŸ")) {
    cart = []; updateCartTable();
    cartMessage.style.display = "block";
    cartMessage.textContent = "âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø³Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©!";
    setTimeout(() => { cartMessage.style.display = "none"; }, 3000);
  }
});

// Ø¹Ø±Ø¶ Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
window.addEventListener('DOMContentLoaded', () => {
  showSection('ahmad');
});
</script>
</body>
</html>
