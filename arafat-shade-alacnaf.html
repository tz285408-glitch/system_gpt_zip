<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Ù†Ø¸Ø§Ù… Ø§Ù„Ø£ØµÙ†Ø§Ù ÙˆØ§Ù„Ø³Ù„Ø© - Ù…Ø­Ø³Ù† (Firestore)</title>

<!-- Ù…ÙƒØªØ¨Ø§Øª Ø®Ø§Ø±Ø¬ÙŠØ© -->
<script src="https://unpkg.com/html5-qrcode"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>

<style>
@import url('https://fonts.googleapis.com/css2?family=Tajawal&display=swap');
body{font-family:"Tajawal",sans-serif;direction:rtl;background:#f0f8ff;margin:0;padding:0;}
h2,h3{text-align:center;color:#0d6efd;margin:15px 0;}
.container{width:95%;max-width:1200px;margin:auto;padding:15px;}
input, button{padding:10px;border-radius:8px;border:1px solid #ccc;font-size:16px;}
button{cursor:pointer;background:#0d6efd;color:#fff;border:none;}
button:hover{background:#084298;}

table{width:100%;border-collapse:collapse;margin-top:15px;font-size:14px;}
th,td{border:1px solid #ccc;padding:8px;text-align:center;white-space:normal;overflow-wrap:break-word;}
th{background:#0d6efd;color:#fff;cursor:pointer;}

tr:nth-child(even){background:#e7f1ff;}
.table-container{overflow-x:auto;width:100%;}
#reader,#readerCart{width:100%;margin:10px auto;display:none;}
.autocomplete{border:1px solid #ccc;border-radius:8px;max-height:150px;overflow-y:auto;background:#fff;position:absolute;z-index:1000;width:95%;}
.autocomplete div{padding:8px;cursor:pointer;}
.autocomplete div:hover{background:#d0e4ff;}
#cartMessage{color:#155724;background:#d4edda;padding:10px;margin-top:10px;border-radius:8px;display:none;text-align:center;}



Â Â Â  header {
Â Â Â Â Â  background: #007bff;
Â Â Â Â Â  color: white;
Â Â Â Â Â  padding: 15px;
Â Â Â Â Â  text-align: center;
Â Â Â  }
Â Â Â  nav {
Â Â Â Â Â  background: #e9ecef;
Â Â Â Â Â  display: flex;
Â Â Â Â Â  justify-content: space-around;
Â Â Â Â Â  padding: 10px;
Â Â Â  }
Â Â Â  nav button {
Â Â Â Â Â  padding: 10px 20px;
Â Â Â Â Â  border: none;
Â Â Â Â Â  background: #007bff;
Â Â Â Â Â  color: white;
Â Â Â Â Â  border-radius: 5px;
Â Â Â Â Â  cursor: pointer;
Â Â Â Â Â  transition: background 0.3s;
Â Â Â  }
Â Â Â  nav button:hover {
Â Â Â Â Â  background: #0056b3;
Â Â Â  }
Â Â Â  .content {
Â Â Â Â Â  padding: 20px;
Â Â Â  }
Â Â Â  .form-section {
Â Â Â Â Â  display: none;
Â Â Â Â Â  background: white;
Â Â Â Â Â  padding: 20px;
Â Â Â Â Â  border-radius: 10px;
Â Â Â Â Â  box-shadow: 0 0 5px #ccc;
Â Â Â Â Â  margin-top: 20px;
Â Â Â  }
Â Â Â  label {
Â Â Â Â Â  display: block;
Â Â Â Â Â  margin-top: 10px;
Â Â Â  }
Â Â Â  input, select {
Â Â Â Â Â  width: 100%;
Â Â Â Â Â  padding: 8px;
Â Â Â Â Â  margin-top: 5px;
Â Â Â Â Â  border: 1px solid #ccc;
Â Â Â Â Â  border-radius: 5px;
Â Â Â  }

</style>
</head>
<body>
<nav>
Â  <button onclick="showSection('ahmad2')">Ø¯Ø®ÙˆÙ„ğŸ›¸</button>
</nav>
Â  
<div class="clasarafat">
<section id="ahmad2" class="form-section">
<h2>ğŸ“¦ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£ØµÙ†Ø§Ù ğŸ›’ Ø§Ù„Ø³Ù„Ø©</h2>
<nav>
Â  <button onclick="showSection('arafat')">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£ØµÙ†Ø§Ù</button>
</nav>
</section>
</div>

<div class="container">
<section id="arafat" class="form-section">
<h3>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£ØµÙ†Ø§Ù</h3>
<div id="reader"></div>

<form id="itemForm">
<div style="margin-top:5px; display:flex; gap:10px; flex-wrap:wrap;">
Â  <div style="flex:1 1 240px; min-width:200px;">
Â Â Â  <label>Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù:</label>
Â Â Â  <input type="text" id="itemName" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù" required>
Â  </div>

<div id="itemMessage" style="
Â  display:none;
Â  color:#856404;
Â  background:#fff3cd;
Â  padding:15px 20px;
Â  margin:50px auto;
Â  border-radius:10px;
Â  text-align:center;
Â  font-size:24px;
Â  font-weight:bold;
Â  width:fit-content;
Â  box-shadow: 0 0 10px rgba(0,0,3,0.2);
">
</div>
Â  
Â  <div style="flex:1 1 240px; min-width:200px;">
Â Â Â  <label>Ø±Ù…Ø² Ø§Ù„ØµÙ†Ù:</label>
Â Â Â  <div style="display:flex; gap:8px;">
Â Â Â Â Â  <input type="text" id="itemCode" placeholder="Ø§Ù…Ø³Ø­ Ø£Ùˆ Ø§ÙƒØªØ¨ Ø§Ù„Ø±Ù…Ø²" required style="flex:1;">
Â Â Â Â Â  <button type="button" id="scanItemBtn">ğŸ“· Ù…Ø³Ø­ Ø±Ù…Ø² Ø§Ù„ØµÙ†Ù</button>
Â Â Â  </div>
Â  </div>
<div style="display:flex; flex-direction:column; gap:15px;">

Â  <div>
Â Â Â  <label>Ø§Ù„ÙˆØ­Ø¯Ø©:</label>
Â Â Â  <input type="text" id="itemUnit" placeholder="Ø§Ù„ÙˆØ­Ø¯Ø© Ù…Ø«Ù„: Ø­Ø¨Ø©ØŒ ÙƒÙŠÙ„ÙˆØŒ Ù„ØªØ±"
Â Â Â Â Â Â Â Â Â Â  required style="width:100%; margin-top:5px;">
Â  </div>

Â  <div style="display:flex; gap:10px;">
Â Â Â  <div style="flex:1;">
Â Â Â Â Â  <label>Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡:</label>
Â Â Â Â Â  <input type="text" inputmode="decimal" id="itemCost" placeholder="Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡"
Â Â Â Â Â Â Â Â Â Â Â Â  style="width:100%; margin-top:5px;">
Â Â Â  </div>

Â Â Â  <div style="flex:1;">
Â Â Â Â Â  <label>Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹:</label>
Â Â Â Â Â  <input type="text" inputmode="decimal" id="itemPrice" placeholder="Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹"
Â Â Â Â Â Â Â Â Â Â Â Â  style="width:100%; margin-top:5px;">
Â Â Â  </div>
Â  </div>

Â  <div style="display:flex; gap:10px; justify-content:center; margin-top:10px;">
Â Â Â  <button type="submit">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØµÙ†Ù</button>
Â Â Â  <button type="button" id="cancelItemBtn" style="background:#dc3545;">âŒ Ø¥Ù„ØºØ§Ø¡</button>
Â  </div>

</div>
</form>

<div style="margin-top:5px; display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
Â  <select id="sortSelect">
Â Â Â  <option value="">-- ÙØ±Ø² Ø­Ø³Ø¨ --</option>
Â Â Â  <option value="name-asc">Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù ØªØµØ§Ø¹Ø¯ÙŠ</option>
Â Â Â  <option value="name-desc">Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù ØªÙ†Ø§Ø²Ù„ÙŠ</option>
Â Â Â  <option value="code-asc">Ø±Ù…Ø² Ø§Ù„ØµÙ†Ù ØªØµØ§Ø¹Ø¯ÙŠ</option>
Â Â Â  <option value="code-desc">Ø±Ù…Ø² Ø§Ù„ØµÙ†Ù ØªÙ†Ø§Ø²Ù„ÙŠ</option>
Â Â Â  <option value="cost-asc">Ø£Ù‚Ù„ Ø³Ø¹Ø± Ø´Ø±Ø§Ø¡</option>
Â Â Â  <option value="cost-desc">Ø£Ø¹Ù„Ù‰ Ø³Ø¹Ø± Ø´Ø±Ø§Ø¡</option>
Â Â Â  <option value="price-asc">Ø£Ù‚Ù„ Ø³Ø¹Ø± Ø¨ÙŠØ¹</option>
Â Â Â  <option value="price-desc">Ø£Ø¹Ù„Ù‰ Ø³Ø¹Ø± Ø¨ÙŠØ¹</option>
Â  </select>
Â  <button id="exportExcelBtn">ğŸ“¤ Excel</button> 
Â  <input type="file" id="importExcel" accept=".xlsx,.xls">
Â  <input type="text" id="searchInput" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¹Ù† Ø£ÙŠ ØµÙ†Ù" style="flex:1;">
</div>

<div id="itemsCount" style="text-align:center; font-weight:bold; margin-bottom:10px;">
Â  Ø¹Ø¯Ø¯ Ø§Ù„Ø£ØµÙ†Ø§Ù: 0
</div>

<div class="table-container">
<table id="itemsTable">
Â  <thead>
Â Â Â  <tr>
Â Â Â Â Â  <th>Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù</th>
Â Â Â Â Â  <th>Ø±Ù…Ø² Ø§Ù„ØµÙ†Ù</th>
Â Â Â Â Â  <th>Ø§Ù„ÙˆØ­Ø¯Ø©</th>
Â Â Â Â Â  <th>Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡</th>
Â Â Â Â Â  <th>Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹</th>
Â Â Â Â Â  <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
Â Â Â  </tr>
Â  </thead>
Â  <tbody></tbody>
</table>
</div>
<hr>
</section>
</div>

<!-- Ø±Ø³Ø§Ù„Ø© ØªÙ… Ø­ÙØ¶ Ø§Ù„ØµÙ†Ù Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ -->
<div id="saveMessage" style="
Â  display:none;
Â  position:fixed;
Â  top:50%;
Â  left:50%;
Â  transform:translate(-50%, -50%);
Â  background:#d4edda;
Â  color:#155724;
Â  border:2px solid #28a745;
Â  padding:20px 40px;
Â  font-size:24px;
Â  font-weight:bold;
Â  border-radius:10px;
Â  box-shadow:0 0 15px rgba(0,0,0,0.2);
Â  z-index:9999;
Â  text-align:center;
">
Â  ØªÙ… Ø§Ù„Ø­ÙØ¸ âœ…
</div>

<!-- =============== Firebase (Firestore) via modular SDK =============== -->
<script type="module">
  // Ø§Ø³ØªØ¨Ø¯Ù„ Ø§Ù„Ù‚ÙŠÙ… ÙÙŠ firebaseConfig Ø¨Ù‚ÙŠÙ… Ù…Ø´Ø±ÙˆØ¹Ùƒ Ù…Ù† Ù„ÙˆØ­Ø© Firebase
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js';
  import {
    getFirestore, collection, getDocs, addDoc, doc, updateDoc, deleteDoc, query, where
  } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js';

  const firebaseConfig = {
    apiKey: "REPLACE_WITH_YOUR_API_KEY",
    authDomain: "REPLACE_WITH_YOUR_PROJECT.firebaseapp.com",
    projectId: "REPLACE_WITH_YOUR_PROJECT_ID",
    storageBucket: "REPLACE_WITH_YOUR_PROJECT.appspot.com",
    messagingSenderId: "REPLACE",
    appId: "REPLACE"
  };

  // ØªÙ‡ÙŠØ¦Ø© Firebase Ùˆ Firestore
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const itemsCol = collection(db, "items");

  // *************** ÙƒÙˆØ¯ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ (ÙŠØªÙƒØ§Ù…Ù„ Ù…Ø¹ Ø¨Ù‚ÙŠØ© Ø§Ù„Ø³ÙƒØ±Ø¨Øª) ***************
  // Ø³Ù†ØµØ¯Ø± Ø¨Ø¹Ø¶ Ø§Ù„Ø¯ÙˆØ§Ù„ Ù„Ù„ÙˆØµÙˆÙ„ Ù…Ù† Ø³ÙƒØ±Ø¨Øª ØºÙŠØ± module Ø¥Ù† Ø§Ø­ØªØ¬Ù†Ø§ (Ù„ÙƒÙ† Ù‡Ù†Ø§ ÙƒÙ„ Ø´ÙŠØ¡ Ø¯Ø§Ø®Ù„ module)
  window.firestoreAPI = {
    db, itemsCol,
    async fetchAllItems() {
      const snap = await getDocs(itemsCol);
      return snap.docs.map(d => ({ id: d.id, ...d.data() }));
    },
    async addItem(item) {
      return await addDoc(itemsCol, item);
    },
    async updateItem(id, item) {
      const d = doc(db, "items", id);
      return await updateDoc(d, item);
    },
    async deleteItem(id) {
      const d = doc(db, "items", id);
      return await deleteDoc(d);
    },
    async findByCode(code) {
      if (!code) return [];
      const q = query(itemsCol, where("code", "==", code));
      const snap = await getDocs(q);
      return snap.docs.map(d => ({ id: d.id, ...d.data() }));
    }
  };
</script>

<script>
/* Ø§Ù„Ø¬Ø²Ø¡ ØºÙŠØ±-module: Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ÙˆØ§Ù„Ù…Ù†Ø·Ù‚ Ø§Ù„Ø¹Ø§Ù… */
const itemForm = document.getElementById("itemForm");
const itemMessage = document.getElementById("itemMessage");
const itemName = document.getElementById("itemName");
const itemCode = document.getElementById("itemCode");
const itemUnit = document.getElementById("itemUnit");
const itemCost = document.getElementById("itemCost");
const itemPrice = document.getElementById("itemPrice");
const itemsTableBody = document.querySelector("#itemsTable tbody");
let editId = null; // Ø³ÙŠØ®Ø²Ù† id Ø§Ù„Ù…Ø³ØªÙ†Ø¯ ÙÙŠ Firestore Ø¹Ù†Ø¯ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
let itemsCache = []; // Ù…ØµÙÙˆÙØ© Ø§Ù„ÙƒØ§Ø¦Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù…Ù„Ø©

// ---------- Ø¯ÙˆØ§Ù„ ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… ----------
function formatWithCommas(val) {
  if (val === undefined || val === null || val === "") return "";
  const s = String(val).replace(/,/g, "");
  if (s === "") return "";
  const n = Number(s);
  if (isNaN(n)) return String(val);
  return n.toLocaleString(); // ÙŠØ¶ÙŠÙ ÙÙˆØ§ØµÙ„ Ø§Ù„Ø¢Ù„Ø§Ù
}

function stripCommas(val) {
  if (val === undefined || val === null) return "";
  return String(val).replace(/,/g, "").trim();
}

// ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„
function bindNumberFormatting(input) {
  input.addEventListener('input', () => {
    const original = input.value;
    let cleaned = String(original).replace(/[^\d\.\-]/g, "");
    const parts = cleaned.split('.');
    if (parts.length > 2) {
      cleaned = parts.shift() + '.' + parts.join('');
    }
    const [intPart, decPart] = cleaned.split('.');
    let intClean = intPart ? intPart.replace(/^0+(?=\d)/, '') : '';
    if (intClean === "") intClean = intPart && intPart.includes('0') ? "0" : "";
    const formattedInt = intClean === "" ? "" : Number(intClean).toLocaleString();
    input.value = decPart !== undefined ? (formattedInt + '.' + decPart) : formattedInt;
  });
  input.addEventListener('blur', () => {
    if (input.value.trim() === "") return;
    const raw = stripCommas(input.value);
    input.value = formatWithCommas(raw);
  });
}

bindNumberFormatting(itemCost);
bindNumberFormatting(itemPrice);

// ================= Firestore integration functions (calls to module API) =================
async function fetchItems() {
  try {
    const res = await window.firestoreAPI.fetchAllItems();
    // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø¥Ù„Ù‰ Ø³Ù„Ø§Ø³Ù„ Ø¨Ø³ÙŠØ·Ø© Ù„Ù„ØªÙˆØ§ÙÙ‚
    return res.map(r => ({
      id: r.id,
      name: r.name || "",
      code: r.code || "",
      unit: r.unit || "",
      cost: r.cost === undefined || r.cost === null ? "" : String(r.cost),
      price: r.price === undefined || r.price === null ? "" : String(r.price)
    }));
  } catch (err) {
    console.error("fetchItems error:", err);
    alert("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø£ØµÙ†Ø§Ù Ù…Ù† Firestore. ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙÙŠ firebaseConfig.");
    return [];
  }
}

async function loadItems() {
  const sortValue = document.getElementById("sortSelect").value;
  itemsTableBody.innerHTML = "";
  itemsCache = await fetchItems();

  if (sortValue) {
    const [field, order] = sortValue.split("-");
    itemsCache.sort((a,b) => {
      if (field === "name" || field === "code") return order === "asc" ? a[field].localeCompare(b[field]) : b[field].localeCompare(a[field]);
      const an = Number(stripCommas(a[field] || 0));
      const bn = Number(stripCommas(b[field] || 0));
      return order === "asc" ? an - bn : bn - an;
    });
  }

  itemsCache.forEach((it, i) => {
    const tr = document.createElement("tr");
    const costDisplay = formatWithCommas(it.cost);
    const priceDisplay = formatWithCommas(it.price);
    tr.innerHTML = `<td>${escapeHtml(it.name)}</td><td>${escapeHtml(it.code)}</td><td>${escapeHtml(it.unit)}</td>
      <td>${costDisplay||''}</td><td>${priceDisplay||''}</td>
      <td><div style="display:flex; gap:1px;">
      <button onclick="editItem(${i})">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
      <button onclick="deleteItem(${i})" style="background:#dc3545;">ğŸ—‘ï¸ Ø­Ø°Ù</button>
      </div></td>`;
    itemsTableBody.appendChild(tr);
  });
  updateItemsCount();
}

// Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø£ÙˆÙ„ÙŠ Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
loadItems();

// Ø¯ÙˆØ§Ù„ Ø£Ù…Ø§Ù† ØµØºÙŠØ±Ø©
function escapeHtml(s) {
  if (!s) return "";
  return String(s).replace(/[&<>"]/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[ch]));
}

// ØªÙˆØ¬ÙŠÙ‡ Ø§Ù„ØªØ±ÙƒÙŠØ² Ù„Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„ÙØ§Ø±ØºØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
function focusFirstEmptyField() {
  const required = [
    {el: itemName, name: "Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù"},
    {el: itemCode, name: "Ø±Ù…Ø² Ø§Ù„ØµÙ†Ù"},
    {el: itemUnit, name: "Ø§Ù„ÙˆØ­Ø¯Ø©"}
  ];
  for (let f of required) {
    if (!f.el.value || !String(f.el.value).trim()) {
      f.el.focus();
      f.el.style.border = "2px solid #dc3545";
      f.el.style.background = "#f8d7da";
      return {found:true, name:f.name};
    }
  }
  return {found:false};
}

// Ø­ÙØ¸ (Ø¥Ø¶Ø§ÙØ© Ø£Ùˆ ØªØ­Ø¯ÙŠØ«) ÙÙŠ Firestore
itemForm.addEventListener("submit", async (e) => {
  e.preventDefault();
  const emptyCheck = focusFirstEmptyField();
  if (emptyCheck.found) {
    alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø­Ù‚Ù„: " + emptyCheck.name);
    return;
  }

  // ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªÙƒØ±Ø§Ø± ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø­Ø³Ø¨ Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ø±Ù…Ø²
  // (Ù†Ù‚ÙˆÙ… Ø¨Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù…Ù† Ø§Ù„ÙƒØ§Ø´ itemsCache)
  const nameExists = itemsCache.some(it => it.name === itemName.value && it.id !== editId);
  if (nameExists && !confirm("âš ï¸ Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹! Ø§Ø³ØªÙ…Ø± Ø£Ù… Ø±Ø¬ÙˆØ¹ØŸ")) return;
  const codeExists = itemsCache.some(it => it.code === itemCode.value && it.id !== editId);
  if (codeExists) { alert("âš ï¸ Ø§Ù„Ø±Ù…Ø² Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ù‹Ø§!"); return; }

  const rawCost = stripCommas(itemCost.value);
  const rawPrice = stripCommas(itemPrice.value);

  const newItem = {
    name: itemName.value,
    code: itemCode.value,
    unit: itemUnit.value,
    cost: rawCost,
    price: rawPrice
  };

  try {
    if (editId) {
      await window.firestoreAPI.updateItem(editId, newItem);
      editId = null;
    } else {
      await window.firestoreAPI.addItem(newItem);
    }
    itemForm.reset();
    [itemName, itemCode, itemUnit, itemCost, itemPrice].forEach(inp => { inp.style.background = ""; inp.style.border = ""; });
    loadItems();
    const saveMessage = document.getElementById("saveMessage");
    saveMessage.style.display = "block";
    setTimeout(() => saveMessage.style.display = "none", 2500);
  } catch (err) {
    console.error("save error:", err);
    alert("ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸ Ø¥Ù„Ù‰ Firestore. ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¨Ø§Ù„ÙƒÙˆÙ†Ø³ÙˆÙ„.");
  }
});

// Ø¹Ø¯Ø§Ø¯ Ø¹Ø¯Ø¯ Ø§Ù„Ø§ØµÙ†Ø§Ù
function updateItemsCount() {
  document.getElementById("itemsCount").textContent = `Ø¹Ø¯Ø¯ Ø§Ù„Ø£ØµÙ†Ø§Ù: ${itemsCache.length}`;
}

window.editItem = (index) => {
  const it = itemsCache[index];
  if (!it) return;
  itemName.value = it.name || "";
  itemCode.value = it.code || "";
  itemUnit.value = it.unit || "";
  itemCost.value = formatWithCommas(it.cost || "");
  itemPrice.value = formatWithCommas(it.price || "");
  editId = it.id || null;
};

window.deleteItem = async (index) => {
  const it = itemsCache[index];
  if (!it) return;
  if (!confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„ØµÙ†ÙØŸ")) return;
  try {
    await window.firestoreAPI.deleteItem(it.id);
    await loadItems();
  } catch (err) {
    console.error("delete error:", err);
    alert("ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„Ø¹Ù†ØµØ± Ù…Ù† Firestore.");
  }
};

document.getElementById("searchInput").addEventListener("input", () => {
  const val = document.getElementById("searchInput").value.toLowerCase();
  document.querySelectorAll("#itemsTable tbody tr").forEach(r => r.style.display = r.innerText.toLowerCase().includes(val) ? "" : "none");
});
document.getElementById("sortSelect").addEventListener("change", loadItems);

// Ø¹Ø±Ø¶ Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø¹Ù†Ø¯ ØªØ¹Ø¯ÙŠÙ„
function showItem(item) {
  itemName.value = item.name || "";
  itemCode.value = item.code || "";
  itemUnit.value = item.unit || "";
  itemCost.value = formatWithCommas(item.cost || "");
  itemPrice.value = formatWithCommas(item.price || "");
  editId = item.id || null;
}

// ================= Ù…Ø§Ø³Ø­ QR =================
let isScanning = false;
const reader = document.getElementById("reader");
const scanItemBtn = document.getElementById("scanItemBtn");
const qr = new Html5Qrcode("reader");

scanItemBtn.onclick = async () => {
  if (!isScanning) {
    const cams = await Html5Qrcode.getCameras();
    if (!cams.length) return alert("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ÙƒØ§Ù…ÙŠØ±Ø§");
    let cam = cams.find(c => c.label.toLowerCase().includes("back"))?.id || cams[0].id;
    reader.style.display = "block";
    qr.start(cam, { fps: 15, qrbox: { width: 280, height: 160 } },
      (decoded) => {
        const item = itemsCache.find(i => i.code === decoded);
        if (item) {
          showItem(item);
          itemMessage.style.display = "block";
          itemMessage.textContent = "âš ï¸ Ø§Ù„ØµÙ†Ù Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹!";
          setTimeout(()=>{ itemMessage.style.display = "none"; }, 3000);
        } else {
          itemCode.value = decoded;
          itemName.value = ""; itemUnit.value = ""; itemCost.value = ""; itemPrice.value = "";
          itemMessage.style.display = "none";
        }
        reader.style.display = "none";
        qr.stop();
        isScanning = false;
        scanItemBtn.textContent = "ğŸ“· Ù…Ø³Ø­";
      }
    );
    isScanning = true;
    scanItemBtn.textContent = "â¹ï¸ Ø¥ÙŠÙ‚Ø§Ù";
  } else {
    qr.stop();
    reader.style.display = "none";
    scanItemBtn.textContent = "ğŸ“· Ù…Ø³Ø­";
    isScanning = false;
  }
};

// ØªÙØ±ÙŠØº Ø§Ù„Ø­Ù‚ÙˆÙ„
function clearItemFields() {
  [itemName, itemCode, itemUnit, itemCost, itemPrice].forEach(i => i.value = "");
  editId = null;
  itemMessage.style.display = "none";
  [itemName, itemCode, itemUnit, itemCost, itemPrice].forEach(inp=>{ inp.style.background = ""; inp.style.border = ""; });
}
document.getElementById("cancelItemBtn").addEventListener("click", clearItemFields);

// ================= Ø§Ø³ØªÙŠØ±Ø§Ø¯ Excel -> Firestore =================
const importExcelInput = document.getElementById("importExcel");
function getCellValue(obj, keys) {
  for (let k of keys) {
    if (obj[k] !== undefined && obj[k] !== null) return String(obj[k]).trim();
  }
  return "";
}

importExcelInput.addEventListener("change", async function (e) {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = async function (evt) {
    let workbook;
    try {
      workbook = XLSX.read(evt.target.result, { type: "binary" });
    } catch {
      workbook = XLSX.read(new Uint8Array(evt.target.result), { type: "array" });
    }
    const sheet = workbook.Sheets[workbook.SheetNames[0]];
    if (!sheet) return alert("âŒ Ø§Ù„Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­");
    let rows = XLSX.utils.sheet_to_json(sheet, { defval: "" });
    if (!rows.length) return alert("âŒ Ù…Ù„Ù Excel ÙØ§Ø±Øº");

    const mapped = rows.map(row => {
      if (Array.isArray(row)) {
        return {
          name: String(row[0] || "").trim(),
          code: String(row[1] || "").trim(),
          unit: String(row[2] || "").trim(),
          cost: String(row[3] || "").trim(),
          price: String(row[4] || "").trim(),
        };
      } else {
        return {
          name: getCellValue(row, ["name","Ø§Ø³Ù…","Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù"]),
          code: getCellValue(row, ["code","Ø±Ù…Ø²","Ø±Ù…Ø² Ø§Ù„ØµÙ†Ù"]),
          unit: getCellValue(row, ["unit","Ø§Ù„ÙˆØ­Ø¯Ø©"]),
          cost: getCellValue(row, ["cost","Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡"]),
          price: getCellValue(row, ["price","Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹"]),
        };
      }
    });

    try {
      for (const im of mapped) {
        if (!im.code) continue;
        // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…Ø³ØªÙ†Ø¯ Ø¨Ù†ÙØ³ Ø§Ù„Ø±Ù…Ø²
        const found = await window.firestoreAPI.findByCode(im.code);
        const newItem = {
          name: im.name, code: im.code, unit: im.unit, cost: im.cost, price: im.price
        };
        if (found.length > 0) {
          // ÙŠØ­Ø¯Ø« Ø£ÙˆÙ„ Ù…Ø·Ø§Ø¨Ù‚ (ÙŠÙ…ÙƒÙ† ØªÙˆØ³ÙŠØ¹ Ø§Ù„Ù…Ù†Ø·Ù‚ Ù„Ø¹Ø¯Ø© Ù…Ø·Ø§Ø¨Ù‚Ø©)
          await window.firestoreAPI.updateItem(found[0].id, newItem);
        } else {
          await window.firestoreAPI.addItem(newItem);
        }
      }
      await loadItems();
      showImportMessage("âœ”ï¸ ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù…Ù„Ù ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£ØµÙ†Ø§Ù");
      importExcelInput.value = "";
    } catch (err) {
      console.error("import error:", err);
      alert("ÙØ´Ù„ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù…Ù„Ù Ø¥Ù„Ù‰ Firestore.");
    }
  };
  reader.readAsBinaryString(file);
});

function showImportMessage(text) {
  const msg = document.createElement("div");
  msg.textContent = text;
  msg.style = `
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: #28a745;
    color: white;
    padding: 12px 20px;
    border-radius: 8px;
    font-size: 16px;
    z-index: 9999;
  `;
  document.body.appendChild(msg);
  setTimeout(() => msg.remove(), 3000);
}

// ================= ØªØµØ¯ÙŠØ± Excel (ÙŠØ³Ø­Ø¨ Ù…Ù† Firestore) =================
document.getElementById("exportExcelBtn").addEventListener("click", async function () {
  try {
    const items = await fetchItems();
    if (items.length === 0) {
      alert("âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù„Ù„ØªØµØ¯ÙŠØ±");
      return;
    }
    // Ù†ÙØ­ÙˆÙ„ Ù„Ù†Ø³Ø®Ø© Ø¨Ø¯ÙˆÙ† id ÙƒÙŠ ÙŠÙØµØ¯Ø± Ø¨Ø´ÙƒÙ„ Ù…Ù†Ø§Ø³Ø¨
    const data = items.map(it => ({ name: it.name, code: it.code, unit: it.unit, cost: it.cost, price: it.price }));
    const worksheet = XLSX.utils.json_to_sheet(data);
    const workbook = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(workbook, worksheet, "Items");
    XLSX.writeFile(workbook, "items.xlsx");
    showExportMessage("âœ”ï¸ ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø¥Ù„Ù‰ Excel");
  } catch (err) {
    console.error("export error:", err);
    alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØµØ¯ÙŠØ± Ù…Ù† Firestore.");
  }
});

function showExportMessage(text) {
  const msg = document.createElement("div");
  msg.textContent = text;
  msg.style = `
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: #007bff;
    color: white;
    padding: 12px 20px;
    border-radius: 8px;
    font-size: 16px;
    z-index: 9999;
  `;
  document.body.appendChild(msg);
  setTimeout(() => msg.remove(), 3000);
}
</script>

</body>
</html>
