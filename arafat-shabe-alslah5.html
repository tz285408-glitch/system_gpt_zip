<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Ù†Ø¸Ø§Ù… Ø§Ù„Ø£ØµÙ†Ø§Ù - ØªØ®Ø²ÙŠÙ† Ø³Ø­Ø§Ø¨ÙŠ (Firebase)</title>

<!-- QR, Excel, PDF libraries -->
<script src="https://unpkg.com/html5-qrcode"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>

<!-- Firebase (v8 compat - Ø£Ø¨Ø³Ø· Ù„Ù…Ù„ÙØ§Øª HTML Ù…Ø³ØªÙ‚Ù„Ø©) -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

<style>
@import url('https://fonts.googleapis.com/css2?family=Tajawal&display=swap');
body{font-family:"Tajawal",sans-serif;direction:rtl;background:#f0f8ff;margin:0;padding:0;}
h2,h3{text-align:center;color:#0d6efd;margin:15px 0;}
.container{width:95%;max-width:1200px;margin:auto;padding:15px;}
input, button{padding:10px;border-radius:8px;border:1px solid #ccc;font-size:16px;}
button{cursor:pointer;background:#0d6efd;color:#fff;border:none;}
button:hover{background:#084298;}

table{width:100%;border-collapse:collapse;margin-top:15px;font-size:14px;}
th,td{border:1px solid #ccc;padding:8px;text-align:center;white-space:normal;overflow-wrap:break-word;}
th{background:#0d6efd;color:#fff;cursor:pointer;}

tr:nth-child(even){background:#e7f1ff;}
.table-container{overflow-x:auto;width:100%;}
#reader,#readerCart{width:100%;margin:10px auto;display:none;}
.autocomplete{border:1px solid #ccc;border-radius:8px;max-height:150px;overflow-y:auto;background:#fff;position:absolute;z-index:1000;width:95%;}
.autocomplete div{padding:8px;cursor:pointer;}
.autocomplete div:hover{background:#d0e4ff;}
#cartMessage{color:#155724;background:#d4edda;padding:10px;margin-top:10px;border-radius:8px;display:none;text-align:center;}

header {
Â  background: #007bff;
Â  color: white;
Â  padding: 15px;
Â  text-align: center;
}
nav {
Â  background: #e9ecef;
Â  display: flex;
Â  justify-content: space-around;
Â  padding: 10px;
}
nav button {
Â  padding: 10px 20px;
Â  border: none;
Â  background: #007bff;
Â  color: white;
Â  border-radius: 5px;
Â  cursor: pointer;
Â  transition: background 0.3s;
}
nav button:hover {
Â  background: #0056b3;
}
.content {
Â  padding: 20px;
}
.form-section {
Â  display: none;
Â  background: white;
Â  padding: 20px;
Â  border-radius: 10px;
Â  box-shadow: 0 0 5px #ccc;
Â  margin-top: 20px;
}
label {
Â  display: block;
Â  margin-top: 10px;
}
input, select {
Â  width: 100%;
Â  padding: 8px;
Â  margin-top: 5px;
Â  border: 1px solid #ccc;
Â  border-radius: 5px;
}
#syncStatus {
Â  font-weight: bold;
Â  text-align: center;
Â  margin: 8px 0;
}
button.small { padding: 8px 10px; font-size: 14px; }
</style>
</head>
<body>

<header role="banner">
Â  <h1 style="margin:0; font-size:20px;">Ù†Ø¸Ø§Ù… Ø§Ù„Ø£ØµÙ†Ø§Ù - ØªØ®Ø²ÙŠÙ† Ø³Ø­Ø§Ø¨ÙŠ</h1>
</header>

<nav role="navigation" aria-label="Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªÙ†Ù‚Ù„">
Â  <button type="button" onclick="showSection('arafat')">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£ØµÙ†Ø§Ù</button>
</nav>

<main class="container" role="main">
Â  <section id="arafat" class="form-section" aria-hidden="true">
Â Â Â  <h3>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£ØµÙ†Ø§Ù (Ù…Ø²Ø§Ù…Ù†Ø© Ø³Ø­Ø§Ø¨ÙŠØ©)</h3>

Â Â Â  <div id="reader" aria-hidden="true"></div>

Â Â Â  <form id="itemForm" aria-label="Ù†Ù…ÙˆØ°Ø¬ Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù">
Â Â Â Â Â  <div style="margin-top:5px; display:flex; gap:10px; flex-wrap:wrap;">
Â Â Â Â Â Â Â  <div style="flex:1 1 240px; min-width:200px;">
Â Â Â Â Â Â Â Â Â  <label for="itemName">Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù:</label>
Â Â Â Â Â Â Â Â Â  <input type="text" id="itemName" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù" required aria-required="true">
Â Â Â Â Â Â Â  </div>

Â Â Â Â Â Â Â  <div style="flex:1 1 240px; min-width:200px;">
Â Â Â Â Â Â Â Â Â  <label for="itemCode">Ø±Ù…Ø² Ø§Ù„ØµÙ†Ù:</label>
Â Â Â Â Â Â Â Â Â  <div style="display:flex; gap:8px;">
Â Â Â Â Â Â Â Â Â Â Â  <input type="text" id="itemCode" placeholder="Ø§Ù…Ø³Ø­ Ø£Ùˆ Ø§ÙƒØªØ¨ Ø§Ù„Ø±Ù…Ø²" required style="flex:1;">
Â Â Â Â Â Â Â Â Â Â Â  <button type="button" id="scanItemBtn" class="small" aria-pressed="false">ğŸ“· Ù…Ø³Ø­</button>
Â Â Â Â Â Â Â Â Â  </div>
Â Â Â Â Â Â Â  </div>

Â Â Â Â Â Â Â  <div style="flex:1 1 240px; min-width:200px;">
Â Â Â Â Â Â Â Â Â  <label for="itemUnit">Ø§Ù„ÙˆØ­Ø¯Ø©:</label>
Â Â Â Â Â Â Â Â Â  <input type="text" id="itemUnit" placeholder="Ø§Ù„ÙˆØ­Ø¯Ø© Ù…Ø«Ù„: Ø­Ø¨Ø©ØŒ ÙƒÙŠÙ„ÙˆØŒ Ù„ØªØ±" required>
Â Â Â Â Â Â Â  </div>

Â Â Â Â Â Â Â  <div style="display:flex; gap:10px; width:100%;">
Â Â Â Â Â Â Â Â Â  <div style="flex:1;">
Â Â Â Â Â Â Â Â Â Â Â  <label for="itemCost">Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡:</label>
Â Â Â Â Â Â Â Â Â Â Â  <input type="text" inputmode="decimal" id="itemCost" placeholder="Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡">
Â Â Â Â Â Â Â Â Â  </div>

Â Â Â Â Â Â Â Â Â  <div style="flex:1;">
Â Â Â Â Â Â Â Â Â Â Â  <label for="itemPrice">Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹:</label>
Â Â Â Â Â Â Â Â Â Â Â  <input type="text" inputmode="decimal" id="itemPrice" placeholder="Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹">
Â Â Â Â Â Â Â Â Â  </div>
Â Â Â Â Â Â Â  </div>

Â Â Â Â Â Â Â  <div style="display:flex; gap:10px; justify-content:center; margin-top:10px; width:100%;">
Â Â Â Â Â Â Â Â Â  <button type="submit">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØµÙ†Ù</button>
Â Â Â Â Â Â Â Â Â  <button type="button" id="cancelItemBtn" style="background:#dc3545;">âŒ Ø¥Ù„ØºØ§Ø¡</button>
Â Â Â Â Â Â Â  </div>

Â Â Â Â Â  </div>
Â Â Â  </form>

Â Â Â  <div id="itemMessage" role="status" aria-live="polite" style="
Â Â Â Â Â  display:none;
Â Â Â Â Â  color:#856404;
Â Â Â Â Â  background:#fff3cd;
Â Â Â Â Â  padding:15px 20px;
Â Â Â Â Â  margin:20px auto;
Â Â Â Â Â  border-radius:10px;
Â Â Â Â Â  text-align:center;
Â Â Â Â Â  font-size:18px;
Â Â Â Â Â  font-weight:bold;
Â Â Â Â Â  width:fit-content;
Â Â Â Â Â  box-shadow: 0 0 10px rgba(0,0,3,0.2);
Â Â Â  "></div>

Â Â Â  <div id="syncStatus">Ø¬Ø§Ø±Ù Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ù…Ø®Ø¯Ù…...</div>

Â Â Â  <div style="margin-top:5px; display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
Â Â Â Â Â  <select id="sortSelect" aria-label="ÙØ±Ø² Ø§Ù„Ø£ØµÙ†Ø§Ù">
Â Â Â Â Â Â Â  <option value="">-- ÙØ±Ø² Ø­Ø³Ø¨ --</option>
Â Â Â Â Â Â Â  <option value="name-asc">Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù ØªØµØ§Ø¹Ø¯ÙŠ</option>
Â Â Â Â Â Â Â  <option value="name-desc">Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù ØªÙ†Ø§Ø²Ù„ÙŠ</option>
Â Â Â Â Â Â Â  <option value="code-asc">Ø±Ù…Ø² Ø§Ù„ØµÙ†Ù ØªØµØ§Ø¹Ø¯ÙŠ</option>
Â Â Â Â Â Â Â  <option value="code-desc">Ø±Ù…Ø² Ø§Ù„ØµÙ†Ù ØªÙ†Ø§Ø²Ù„ÙŠ</option>
Â Â Â Â Â Â Â  <option value="cost-asc">Ø£Ù‚Ù„ Ø³Ø¹Ø± Ø´Ø±Ø§Ø¡</option>
Â Â Â Â Â Â Â  <option value="cost-desc">Ø£Ø¹Ù„Ù‰ Ø³Ø¹Ø± Ø´Ø±Ø§Ø¡</option>
Â Â Â Â Â Â Â  <option value="price-asc">Ø£Ù‚Ù„ Ø³Ø¹Ø± Ø¨ÙŠØ¹</option>
Â Â Â Â Â Â Â  <option value="price-desc">Ø£Ø¹Ù„Ù‰ Ø³Ø¹Ø± Ø¨ÙŠØ¹</option>
Â Â Â Â Â  </select>
Â Â Â Â Â  <button id="exportExcelBtn" class="small">ğŸ“¤ Excel</button>
Â Â Â Â Â  <input type="file" id="importExcel" accept=".xlsx,.xls" aria-label="Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ù„Ù Excel">
Â Â Â Â Â  <input type="text" id="searchInput" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¹Ù† Ø£ÙŠ ØµÙ†Ù" style="flex:1;">
Â Â Â  </div>

Â Â Â  <div id="itemsCount" style="text-align:center; font-weight:bold; margin-bottom:10px;">
Â Â Â Â Â  Ø¹Ø¯Ø¯ Ø§Ù„Ø£ØµÙ†Ø§Ù: 0
Â Â Â  </div>

Â Â Â  <div class="table-container" role="region" aria-label="Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£ØµÙ†Ø§Ù">
Â Â Â Â Â  <table id="itemsTable" role="table">
Â Â Â Â Â Â Â  <thead>
Â Â Â Â Â Â Â Â Â  <tr>
Â Â Â Â Â Â Â Â Â Â Â  <th scope="col">Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù</th>
Â Â Â Â Â Â Â Â Â Â Â  <th scope="col">Ø±Ù…Ø² Ø§Ù„ØµÙ†Ù</th>
Â Â Â Â Â Â Â Â Â Â Â  <th scope="col">Ø§Ù„ÙˆØ­Ø¯Ø©</th>
Â Â Â Â Â Â Â Â Â Â Â  <th scope="col">Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡</th>
Â Â Â Â Â Â Â Â Â Â Â  <th scope="col">Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹</th>
Â Â Â Â Â Â Â Â Â Â Â  <th scope="col">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
Â Â Â Â Â Â Â Â Â  </tr>
Â Â Â Â Â Â Â  </thead>
Â Â Â Â Â Â Â  <tbody></tbody>
Â Â Â Â Â  </table>
Â Â Â  </div>
Â Â Â  <hr>
Â  </section>
</main>

<div id="saveMessage" role="status" aria-live="polite" style="
Â  display:none;
Â  position:fixed;
Â  top:50%;
Â  left:50%;
Â  transform:translate(-50%, -50%);
Â  background:#d4edda;
Â  color:#155724;
Â  border:2px solid #28a745;
Â  padding:20px 40px;
Â  font-size:24px;
Â  font-weight:bold;
Â  border-radius:10px;
Â  box-shadow:0 0 15px rgba(0,0,0,0.2);
Â  z-index:9999;
Â  text-align:center;
">
Â  ØªÙ… Ø§Ù„Ø­ÙØ¸ âœ…
</div>

<script>
/*
Â  Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù…Ù‡Ù…Ø© Ù‚Ø¨Ù„ Ø§Ù„ØªØ´ØºÙŠÙ„:
Â  1) Ø£Ù†Ø´Ø¦ Ù…Ø´Ø±ÙˆØ¹ Firebase Ø¬Ø¯ÙŠØ¯: https://console.firebase.google.com/
Â  2) ÙØ¹Ù‘Ù„ Firestore (Database > Firestore) ÙˆØ§Ø®ØªØ± ÙˆØ¶Ø¹ Ù‚ÙˆØ§Ø¹Ø¯ Ù…Ù†Ø§Ø³Ø¨ (ÙŠÙØ¶Ù„ Ù‚ÙˆØ§Ø¹Ø¯ Ù…Ø¤Ù…Ù†Ø©).
Â  3) Ø¶Ø¹ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªÙ‡ÙŠØ¦Ø© (firebaseConfig) Ø£Ø¯Ù†Ø§Ù‡ Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ø´Ø±ÙˆØ¹Ùƒ.
Â  4) Ù…Ù† Ø§Ù„Ù…Ø³ØªØ­Ø³Ù† ØªÙØ¹ÙŠÙ„ Ù…ØµØ§Ø¯Ù‚Ø© (Auth) â€” ÙŠÙ…ÙƒÙ† Ø§Ø³ØªØ®Ø¯Ø§Ù… anonymous auth Ù„Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ø³Ø±ÙŠØ¹.
*/

/* ====== Ø¥Ø¹Ø¯Ø§Ø¯ Firebase: Ø§Ø³ØªØ¨Ø¯Ù„ Ø§Ù„Ù‚ÙŠÙ… Ø¨Ø§Ù„Ù‚ÙŠÙ… Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ø´Ø±ÙˆØ¹Ùƒ ====== */
const firebaseConfig = {
Â  apiKey: "REPLACE_API_KEY",
Â  authDomain: "REPLACE_PROJECT.firebaseapp.com",
Â  projectId: "REPLACE_PROJECT",
Â  // Ø¥Ø°Ø§ Ø£Ø±Ø¯Øª: storageBucket, messagingSenderId, appId...
};
// ØªÙ‡ÙŠØ¦Ø© Firebase
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
// Ù…Ø­Ø§ÙˆÙ„Ø© ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ (persistence) Ù„ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø¹Ù…Ù„ Ø£ÙˆÙÙ„Ø§ÙŠÙ†
db.enablePersistence?.().catch(function(err) {
Â  // Ù‚Ø¯ ØªÙØ´Ù„ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø£Ùˆ Ø¥Ù† ÙƒØ§Ù†Øª Ø¬Ù„Ø³Ø© Ù…ØªØ²Ø§Ù…Ù†Ø©
Â  console.warn('enablePersistence failed:', err && err.message);
});

// ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø¬Ù‡ÙˆÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ (ÙŠØ³Ù…Ø­ Ø¨Ù…Ø²Ø§Ù…Ù†Ø© Ø¢Ù…Ù†Ø© Ø¥Ù† Ø¬Ø¹Ù„Øª Ù‚ÙˆØ§Ø¹Ø¯ Firestore ØªÙ‚Ø¨Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…ÙˆØ«Ù‚ÙŠÙ† ÙÙ‚Ø·)
auth.signInAnonymously().catch(err => {
Â  console.warn('Anonymous auth failed:', err && err.message);
});

/* ====== Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø­Ù„ÙŠØ© ====== */
const itemsTableBody = document.querySelector("#itemsTable tbody");
const itemForm = document.getElementById("itemForm");
const itemName = document.getElementById("itemName");
const itemCode = document.getElementById("itemCode");
const itemUnit = document.getElementById("itemUnit");
const itemCost = document.getElementById("itemCost");
const itemPrice = document.getElementById("itemPrice");
const itemMessage = document.getElementById("itemMessage");
const syncStatus = document.getElementById("syncStatus");

let itemsCache = [];Â Â Â Â Â Â Â Â Â  // Ù…ØµÙÙˆÙØ© Ø§Ù„Ø£ØµÙ†Ø§Ù Ø§Ù„Ø­Ø§Ù„ÙŠØ© (Ù…Ø²Ø§Ù…Ù†Ø© Ù…Ø¹ Ø§Ù„Ø³Ø­Ø§Ø¨Ø©)
let originalDocId = null;Â Â Â Â  // Ø¹Ù†Ø¯ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªÙ†Ø¯ Ø§Ù„Ø£ØµÙ„ÙŠ (doc id)
const itemsCollection = db.collection('items'); // Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ø£ØµÙ†Ø§Ù ÙÙŠ Firestore

/* ====== Ù…Ø³Ø§Ø¹Ø¯Ø©: ØªØ­ÙˆÙŠÙ„ Ø±Ù…Ø² Ø§Ù„ØµÙ†Ù Ù„Ù…Ø¹Ø±ÙØ© Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªÙ†Ø¯ Ø§Ù„Ø¢Ù…Ù† ====== */
function docIdForCode(code) {
Â  if (!code) return null;
Â  // encodeURIComponent ÙŠÙƒÙÙ„ Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ø´Ø±Ø·Ø§Øª Ù…ÙØ³Ø¯Ø© Ù…Ø«Ù„ '/'
Â  return encodeURIComponent(String(code));
}

/* ====== ØªÙ†Ø³ÙŠÙ‚ ÙˆØ§Ø±Ù‚Ø§Ù… helpers ====== */
function formatWithCommas(val) {
Â  if (val === undefined || val === null || val === "") return "";
Â  const s = String(val).replace(/,/g, "");
Â  if (s === "") return "";
Â  const n = Number(s);
Â  if (isNaN(n)) return String(val);
Â  return n.toLocaleString();
}
function stripCommas(val) {
Â  if (val === undefined || val === null) return "";
Â  return String(val).replace(/,/g, "").trim();
}

/* ====== Ø§Ø³ØªÙ…Ø¹ Ù„Ù„ØªØºÙŠÙŠØ±Ø§Øª ÙÙŠ Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ø£ØµÙ†Ø§Ù (ØªØ­Ø¯ÙŠØ« Ù…Ø¨Ø§Ø´Ø± Ø¨ÙŠÙ† Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©) ====== */
let unsubscribeSnapshot = null;
function startRealtimeSync() {
Â  // Ø§Ø³ØªÙ…Ø¹ ÙÙ‚Ø· Ø¨Ø¹Ø¯ ØªÙˆØ«ÙŠÙ‚ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ø£Ùˆ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø¯ÙˆÙ† ØªÙˆØ«ÙŠÙ‚ Ø¨ØªØºÙŠÙŠØ± Ù‚ÙˆØ§Ø¹Ø¯ Firestore)
Â  auth.onAuthStateChanged(user => {
Â Â Â  // Ø¹Ø±Ø¶ Ø­Ø§Ù„Ø© Ø¨Ø³ÙŠØ·Ø©
Â Â Â  syncStatus.textContent = user ? 'Ù…ØªØµÙ„ Ø¨Ø§Ù„Ù…Ø®Ø¯Ù… - Ù…Ø²Ø§Ù…Ù†Ø© ÙØ¹Ù‘Ø§Ù„Ø©' : 'ØºÙŠØ± Ù…ÙˆØ«Ù‘Ù‚ Ø¨Ø¹Ø¯ - Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©...';

Â Â Â  // Ø¥Ù„ØºØ§Ø¡ Ø£ÙŠ Ù…Ø³ØªÙ…Ø¹ Ø³Ø§Ø¨Ù‚
Â Â Â  if (unsubscribeSnapshot) { unsubscribeSnapshot(); unsubscribeSnapshot = null; }

Â Â Â  // Ø§Ø´ØªØ±Ùƒ ÙÙŠ ØªØ­Ø¯ÙŠØ«Ø§Øª Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© (ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© ØªØ±ØªÙŠØ¨ Ø§ÙØªØ±Ø§Ø¶ÙŠ)
Â Â Â  unsubscribeSnapshot = itemsCollection.onSnapshot(snapshot => {
Â Â Â Â Â  const docs = [];
Â Â Â Â Â  snapshot.forEach(doc => {
Â Â Â Â Â Â Â  docs.push({ id: doc.id, ...doc.data() });
Â Â Â Â Â  });
Â Â Â Â Â  // Ø®Ø²Ù‘Ù† Ù…Ø­Ù„ÙŠÙ‹Ø§ ÙƒÙ†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©
Â Â Â Â Â  itemsCache = docs;
Â Â Â Â Â  localStorage.setItem('itemsList', JSON.stringify(itemsCache));
Â Â Â Â Â  renderItemsFromCache();
Â Â Â Â Â  syncStatus.textContent = 'Ù…ØªØµÙ„ Ø¨Ø§Ù„Ù…Ø®Ø¯Ù… - Ø§Ù„ØªØ­Ø¯ÙŠØ« ØªÙ„Ù‚Ø§Ø¦ÙŠ';
Â Â Â  }, err => {
Â Â Â Â Â  console.error('Snapshot error:', err);
Â Â Â Â Â  syncStatus.textContent = 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© (Ø§Ù†Ø¸Ø± Ø§Ù„ÙƒÙˆÙ†Ø³ÙˆÙ„) â€” Ø³ÙŠØªÙ… Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø®Ø¨Ø£Ø© Ù…Ø­Ù„ÙŠÙ‹Ø§';
Â Â Â Â Â  // Ø¥Ù† ØªØ¹Ø°Ø± Ø§Ù„Ø§ØªØµØ§Ù„ØŒ Ø­Ø§ÙˆÙ„ ØªØ­Ù…ÙŠÙ„ Ù…Ù† Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ
Â Â Â Â Â  loadItemsFromLocalStorage();
Â Â Â  });
Â  });
}
startRealtimeSync();

/* ====== Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù…Ù† itemsCache ====== */
function renderItemsFromCache() {
Â  const sortValue = document.getElementById("sortSelect").value;
Â  let items = [...itemsCache];
Â  if (sortValue) {
Â Â Â  const [field, order] = sortValue.split("-");
Â Â Â  items.sort((a,b) => {
Â Â Â Â Â  if (field === "name" || field === "code") {
Â Â Â Â Â Â Â  return order === "asc" ? (a[field]||"").localeCompare(b[field]||"") : (b[field]||"").localeCompare(a[field]||"");
Â Â Â Â Â  }
Â Â Â Â Â  const an = Number(stripCommas(a[field] || 0));
Â Â Â Â Â  const bn = Number(stripCommas(b[field] || 0));
Â Â Â Â Â  return order === "asc" ? an - bn : bn - an;
Â Â Â  });
Â  }

Â  itemsTableBody.innerHTML = "";
Â  items.forEach((it, i) => {
Â Â Â  const costDisplay = formatWithCommas(it.cost);
Â Â Â  const priceDisplay = formatWithCommas(it.price);
Â Â Â  const tr = document.createElement('tr');
Â Â Â  tr.innerHTML = `<td>${escapeHtml(it.name)}</td><td>${escapeHtml(it.code)}</td><td>${escapeHtml(it.unit)}</td><td>${costDisplay||''}</td><td>${priceDisplay||''}</td>
Â Â Â Â Â  <td><div style="display:flex; gap:4px; justify-content:center;">
Â Â Â Â Â  <button type="button" onclick="editItem(${i})">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
Â Â Â Â Â  <button type="button" onclick="deleteItem(${i})" style="background:#dc3545;">ğŸ—‘ï¸ Ø­Ø°Ù</button>
Â Â Â Â Â  </div></td>`;
Â Â Â  itemsTableBody.appendChild(tr);
Â  });
Â  updateItemsCount();
}
function escapeHtml(text) {
Â  if (!text && text !== 0) return "";
Â  return String(text).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;');
}

/* ====== Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø£ØµÙ†Ø§Ù (Ù…Ù† Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø®Ø¨Ø£ Ø£Ùˆ itemsCache) ====== */
function updateItemsCount() {
Â  const n = itemsCache.length;
Â  document.getElementById("itemsCount").textContent = `Ø¹Ø¯Ø¯ Ø§Ù„Ø£ØµÙ†Ø§Ù: ${n}`;
}

/* ====== ØªØ­Ù…ÙŠÙ„ Ù…Ù† Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ ÙƒÙ†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© ====== */
function loadItemsFromLocalStorage() {
Â  try {
Â Â Â  const local = JSON.parse(localStorage.getItem('itemsList') || "[]");
Â Â Â  itemsCache = local;
Â Â Â  renderItemsFromCache();
Â  } catch (e) {
Â Â Â  console.warn('local load failed', e);
Â  }
}
// ÙÙŠ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© Ø­Ø§ÙˆÙ„ Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ø®Ø¨Ø£ Ø­ØªÙ‰ ÙŠØ¸Ù‡Ø± Ø´ÙŠØ¡ Ø¨Ø³Ø±Ø¹Ø©
loadItemsFromLocalStorage();

/* ====== Ø¥Ø¶Ø§ÙØ© / ØªØ¹Ø¯ÙŠÙ„ ØµÙ†Ù (Ø¨ÙƒØªØ§Ø¨Ø© Ù…Ø¨Ø§Ø´Ø±Ø© Ø¥Ù„Ù‰ Firestore) ====== */
let editIndex = null; // Ù„Ù… ÙŠØ¹Ø¯ ÙŠØ³ØªØ®Ø¯Ù… Ù„Ø±Ø¨Ø· Ù…ÙˆÙ‚Ø¹ Ù…Ø­Ù„ÙŠ ÙÙ‚Ø·ØŒ Ù†Ø³ØªØ®Ø¯Ù… originalDocId
itemForm.addEventListener("submit", async (e) => {
Â  e.preventDefault();

Â  // ØªØ­Ù‚Ù‚ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¥Ù„Ø²Ø§Ù…ÙŠØ©
Â  if (!itemName.value.trim() || !itemCode.value.trim() || !itemUnit.value.trim()) {
Â Â Â  alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©: Ø§Ø³Ù… Ø§Ù„ØµÙ†ÙØŒ Ø±Ù…Ø² Ø§Ù„ØµÙ†ÙØŒ Ø§Ù„ÙˆØ­Ø¯Ø©');
Â Â Â  return;
Â  }

Â  const name = itemName.value.trim();
Â  const code = itemCode.value.trim();
Â  const unit = itemUnit.value.trim();
Â  const cost = stripCommas(itemCost.value);
Â  const price = stripCommas(itemPrice.value);

Â  const docId = docIdForCode(code);
Â  const newItem = { name, code, unit, cost, price, updatedAt: firebase.firestore.FieldValue.serverTimestamp() };

Â  try {
Â Â Â  // Ø¥Ø°Ø§ ÙƒÙ†Ø§ ÙÙŠ ÙˆØ¶Ø¹ ØªØ¹Ø¯ÙŠÙ„ ÙˆØ±Ù…Ø² Ø§Ù„ØµÙ†Ù ØªØºÙŠÙ‘Ø±ØŒ Ø§Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªÙ†Ø¯ Ø§Ù„Ù‚Ø¯ÙŠÙ… Ø£ÙˆÙ„Ø§Ù‹
Â Â Â  if (originalDocId && originalDocId !== docId) {
Â Â Â Â Â  await itemsCollection.doc(originalDocId).delete().catch(()=>{});
Â Â Â  }
Â Â Â  // Ø§Ø­ÙØ¸/Ø­Ø¯Ù‘Ø« Ø§Ù„Ù…Ø³ØªÙ†Ø¯ Ø¨Ø§Ù„Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø¨Ù†ÙŠ Ù…Ù† Ø§Ù„Ø±Ù…Ø²
Â Â Â  await itemsCollection.doc(docId).set(newItem, { merge: true });

Â Â Â  // Ø¥Ø¹Ø§Ø¯Ø© ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø­Ù‚ÙˆÙ„
Â Â Â  itemForm.reset();
Â Â Â  originalDocId = null;

Â Â Â  document.getElementById("saveMessage").style.display = 'block';
Â Â Â  setTimeout(()=> document.getElementById("saveMessage").style.display = 'none', 1600);

Â  } catch (err) {
Â Â Â  console.error('Save error:', err);
Â Â Â  alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸ØŒ Ø³ÙŠØªÙ… Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ù…Ø­Ù„ÙŠÙ‹Ø§ Ø«Ù… Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù„Ø§Ø­Ù‚Ù‹Ø§.');
Â Â Â  // ÙƒØ®Ø·Ø© Ø¨Ø¯ÙŠÙ„Ø©: Ø®Ø²Ù‘Ù† ÙÙŠ localStorage ÙƒØ¯Ø¹Ù… Ø£ÙˆÙÙ„Ø§ÙŠÙ†
Â Â Â  const items = JSON.parse(localStorage.getItem('itemsList') || "[]");
Â Â Â  const idx = items.findIndex(it => it.code === code);
Â Â Â  if (idx !== -1) items[idx] = { name, code, unit, cost, price };
Â Â Â  else items.push({ name, code, unit, cost, price });
Â Â Â  localStorage.setItem('itemsList', JSON.stringify(items));
Â Â Â  loadItemsFromLocalStorage();
Â  }
});

/* ====== ØªØ¹Ø¯ÙŠÙ„ / Ø­Ø°Ù Ø¹Ù†Ø§ØµØ± Ù…Ù† Ø§Ù„Ù…ØµÙÙˆÙØ© Ø§Ù„Ù…Ø­Ù„ÙŠØ© Ø§Ù„ØªÙŠ ØªÙ… Ø¬Ù„Ø¨Ù‡Ø§ Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø© ====== */
window.editItem = function(i) {
Â  const it = itemsCache[i];
Â  if (!it) return;
Â  itemName.value = it.name || "";
Â  itemCode.value = it.code || "";
Â  itemUnit.value = it.unit || "";
Â  itemCost.value = formatWithCommas(it.cost || "");
Â  itemPrice.value = formatWithCommas(it.price || "");
Â  originalDocId = docIdForCode(it.code);
};

window.deleteItem = async function(i) {
Â  const it = itemsCache[i];
Â  if (!it) return;
Â  if (!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„ØµÙ†ÙØŸ')) return;
Â  const id = docIdForCode(it.code);
Â  try {
Â Â Â  await itemsCollection.doc(id).delete();
Â Â Â  // ÙÙŠ Ø­Ø§Ù„ Ø¹Ø¯Ù… Ø§Ù„Ù‚Ø¯Ø±Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø­Ø°Ù Ø³ØªØ­ØµÙ„ Ø¹Ù„Ù‰ Ø§Ø³ØªÙ…Ø§Ø¹ snapshot Ø§Ù„Ø°ÙŠ Ø³ÙŠØ­Ø¯Ù‘Ø« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø¹Ù†Ø¯Ù…Ø§ ÙŠØ¹ÙˆØ¯ Ø§Ù„Ø§ØªØµØ§Ù„
Â  } catch (err) {
Â Â Â  console.error('Delete error:', err);
Â Â Â  alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­Ø°Ù. ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„ Ø£Ùˆ Ø¬Ø±Ø¨ Ù„Ø§Ø­Ù‚Ù‹Ø§.');
Â  }
};

/* ====== QR Scanner (Ù†ÙØ³ Ù…Ù† Ù‚Ø¨Ù„ Ù„ÙƒÙ† Ù„Ø§ ÙŠØ²Ø§Ù„ ÙŠØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Firestore Ø¹Ù†Ø¯ Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø±Ù…Ø²) ====== */
let isScanning = false;
const qrReaderEl = document.getElementById("reader");
const scanItemBtn = document.getElementById("scanItemBtn");
let qrScanner = null;
async function ensureQrScanner() {
Â  if (!qrScanner) qrScanner = new Html5Qrcode("reader");
Â  return qrScanner;
}
scanItemBtn.onclick = async () => {
Â  try {
Â Â Â  if (!isScanning) {
Â Â Â Â Â  const scanner = await ensureQrScanner();
Â Â Â Â Â  let cams = [];
Â Â Â Â Â  try { cams = await Html5Qrcode.getCameras(); } catch (err) { cams = []; }
Â Â Â Â Â  if (!cams.length) return alert("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ÙƒØ§Ù…ÙŠØ±Ø§");
Â Â Â Â Â  let cam = cams.find(c => c.label && c.label.toLowerCase().includes("back"))?.id || cams[0].id;
Â Â Â Â Â  qrReaderEl.style.display = "block";
Â Â Â Â Â  scanItemBtn.textContent = "â¹ï¸ Ø¥ÙŠÙ‚Ø§Ù";
Â Â Â Â Â  scanItemBtn.setAttribute("aria-pressed", "true");
Â Â Â Â Â  isScanning = true;

Â Â Â Â Â  await scanner.start(cam, { fps: 15, qrbox: { width: 280, height: 160 } },
Â Â Â Â Â Â Â  async (decoded) => {
Â Â Â Â Â Â Â Â Â  // Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø³Ø­Ø§Ø¨Ø© Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø±Ù…Ø²
Â Â Â Â Â Â Â Â Â  try {
Â Â Â Â Â Â Â Â Â Â Â  const doc = await itemsCollection.doc(docIdForCode(decoded)).get();
Â Â Â Â Â Â Â Â Â Â Â  if (doc.exists) {
Â Â Â Â Â Â Â Â Â Â Â Â Â  const item = doc.data();
Â Â Â Â Â Â Â Â Â Â Â Â Â  itemMessage.style.display = 'block';
Â Â Â Â Â Â Â Â Â Â Â Â Â  itemMessage.textContent = 'âš ï¸ Ø§Ù„ØµÙ†Ù Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹!';
Â Â Â Â Â Â Â Â Â Â Â Â Â  showItem(item);
Â Â Â Â Â Â Â Â Â Â Â Â Â  setTimeout(()=> itemMessage.style.display='none', 2500);
Â Â Â Â Â Â Â Â Â Â Â  } else {
Â Â Â Â Â Â Â Â Â Â Â Â Â  // ØªØ¹Ø¨Ø¦Ø© Ø±Ù…Ø² ÙÙ‚Ø· Ù„Ø§Ø¶Ø§ÙØ© ØµÙ†Ù Ø¬Ø¯ÙŠØ¯
Â Â Â Â Â Â Â Â Â Â Â Â Â  itemCode.value = decoded;
Â Â Â Â Â Â Â Â Â Â Â Â Â  itemName.value = "";
Â Â Â Â Â Â Â Â Â Â Â Â Â  itemUnit.value = "";
Â Â Â Â Â Â Â Â Â Â Â Â Â  itemCost.value = "";
Â Â Â Â Â Â Â Â Â Â Â Â Â  itemPrice.value = "";
Â Â Â Â Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â Â Â  } catch (err) {
Â Â Â Â Â Â Â Â Â Â Â  console.warn('QR lookup error', err);
Â Â Â Â Â Â Â Â Â Â Â  // ÙÙŠ Ø­Ø§Ù„ Ø¹Ø¯Ù… ØªÙˆÙØ± Ø§Ù„Ø´Ø¨ÙƒØ©: Ø­Ø§ÙˆÙ„ Ù…Ù† Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ
Â Â Â Â Â Â Â Â Â Â Â  const local = JSON.parse(localStorage.getItem('itemsList') || "[]");
Â Â Â Â Â Â Â Â Â Â Â  const found = local.find(i => i.code === String(decoded));
Â Â Â Â Â Â Â Â Â Â Â  if (found) showItem(found);
Â Â Â Â Â Â Â Â Â Â Â  else {
Â Â Â Â Â Â Â Â Â Â Â Â Â  itemCode.value = decoded;
Â Â Â Â Â Â Â Â Â Â Â Â Â  itemName.value = "";
Â Â Â Â Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â Â Â  } finally {
Â Â Â Â Â Â Â Â Â Â Â  // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø§Ø³Ø­ Ø¨Ø¹Ø¯ Ù‚Ø±Ø§Ø¡Ø© Ù†Ø§Ø¬Ø­Ø©
Â Â Â Â Â Â Â Â Â Â Â  await stopScanner().catch(()=>{});
Â Â Â Â Â Â Â Â Â  }
Â Â Â Â Â Â Â  },
Â Â Â Â Â Â Â  (err) => { /* ØªØ¬Ø§Ù‡Ù„ Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© */ }
Â Â Â Â Â  );
Â Â Â  } else {
Â Â Â Â Â  await stopScanner();
Â Â Â  }
Â  } catch (err) {
Â Â Â  console.error(err);
Â Â Â  alert('Ø®Ø·Ø£ ÙÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ø§Ø³Ø­: ' + (err && err.message || err));
Â Â Â  try { await stopScanner(); } catch(e){}
Â  }
};
async function stopScanner() {
Â  if (!qrScanner) return;
Â  try { await qrScanner.stop(); } catch(e){}
Â  qrReaderEl.style.display = "none";
Â  scanItemBtn.textContent = "ğŸ“· Ù…Ø³Ø­";
Â  scanItemBtn.setAttribute("aria-pressed", "false");
Â  isScanning = false;
}

/* ====== ÙˆØ¸Ø§Ø¦Ù Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù…Ù„ÙØ§Øª Excel: Ø§Ø³ØªÙŠØ±Ø§Ø¯ ÙˆØªØµØ¯ÙŠØ± (ØªØªØ²Ø§Ù…Ù† Ù…Ø¹ Ø§Ù„Ø³Ø­Ø§Ø¨Ø©) ====== */
const importExcelInput = document.getElementById("importExcel");

function getCellValue(obj, keys) {
Â  for (let k of keys) {
Â Â Â  if (obj[k] !== undefined && obj[k] !== null) return String(obj[k]).trim();
Â  }
Â  return "";
}
importExcelInput.addEventListener("change", function(e) {
Â  const file = e.target.files[0];
Â  if (!file) return;
Â  const reader = new FileReader();
Â  reader.onload = async function(evt) {
Â Â Â  let workbook;
Â Â Â  try { workbook = XLSX.read(evt.target.result, { type: "binary" }); }
Â Â Â  catch { workbook = XLSX.read(new Uint8Array(evt.target.result), { type: "array" }); }
Â Â Â  const sheet = workbook.Sheets[workbook.SheetNames[0]];
Â Â Â  if (!sheet) return alert("âŒ Ø§Ù„Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­");
Â Â Â  let rows = XLSX.utils.sheet_to_json(sheet, { defval: "" });
Â Â Â  if (!rows.length) return alert("âŒ Ù…Ù„Ù Excel ÙØ§Ø±Øº");

Â Â Â  const mapped = rows.map(row => {
Â Â Â Â Â  if (Array.isArray(row)) {
Â Â Â Â Â Â Â  return {
Â Â Â Â Â Â Â Â Â  name: String(row[0] || "").trim(),
Â Â Â Â Â Â Â Â Â  code: String(row[1] || "").trim(),
Â Â Â Â Â Â Â Â Â  unit: String(row[2] || "").trim(),
Â Â Â Â Â Â Â Â Â  cost: String(row[3] || "").trim(),
Â Â Â Â Â Â Â Â Â  price: String(row[4] || "").trim(),
Â Â Â Â Â Â Â  };
Â Â Â Â Â  } else {
Â Â Â Â Â Â Â  return {
Â Â Â Â Â Â Â Â Â  name: getCellValue(row, ["name","Ø§Ø³Ù…","Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù"]),
Â Â Â Â Â Â Â Â Â  code: getCellValue(row, ["code","Ø±Ù…Ø²","Ø±Ù…Ø² Ø§Ù„ØµÙ†Ù"]),
Â Â Â Â Â Â Â Â Â  unit: getCellValue(row, ["unit","Ø§Ù„ÙˆØ­Ø¯Ø©"]),
Â Â Â Â Â Â Â Â Â  cost: getCellValue(row, ["cost","Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡"]),
Â Â Â Â Â Â Â Â Â  price: getCellValue(row, ["price","Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹"]),
Â Â Â Â Â Â Â  };
Â Â Â Â Â  }
Â Â Â  });

Â Â Â  // Ø§Ø±ÙØ¹ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙÙˆÙ Ø¥Ù„Ù‰ Ø§Ù„Ø³Ø­Ø§Ø¨Ø© (Ø­Ø³Ø¨ Ø§Ù„Ø±Ù…Ø² ÙƒÙ…Ø¹Ø±Ù Ù…Ø³ØªÙ†Ø¯)
Â Â Â  try {
Â Â Â Â Â  const promises = mapped.map(im => {
Â Â Â Â Â Â Â  if (!im.code) return Promise.resolve();
Â Â Â Â Â Â Â  const id = docIdForCode(im.code);
Â Â Â Â Â Â Â  const docData = { name: im.name, code: im.code, unit: im.unit, cost: im.cost, price: im.price, updatedAt: firebase.firestore.FieldValue.serverTimestamp() };
Â Â Â Â Â Â Â  return itemsCollection.doc(id).set(docData, { merge: true });
Â Â Â Â Â  });
Â Â Â Â Â  await Promise.all(promises);
Â Â Â Â Â  showImportMessage('âœ”ï¸ ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù…Ù„Ù ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£ØµÙ†Ø§Ù ÙÙŠ Ø§Ù„Ø³Ø­Ø§Ø¨Ø©');
Â Â Â  } catch (err) {
Â Â Â Â Â  console.error('Import error', err);
Â Â Â Â Â  showImportMessage('âš ï¸ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯. ØªÙ… Ø­ÙØ¸ Ù†Ø³Ø®Ø© Ù…Ø­Ù„ÙŠÙ‹Ø§');
Â Â Â Â Â  // ÙƒÙ†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ù…Ø­Ù„ÙŠØ©
Â Â Â Â Â  const items = JSON.parse(localStorage.getItem('itemsList') || "[]");
Â Â Â Â Â  mapped.forEach(im => {
Â Â Â Â Â Â Â  if (!im.code) return;
Â Â Â Â Â Â Â  const idx = items.findIndex(it => it.code === im.code);
Â Â Â Â Â Â Â  const newItem = { name: im.name, code: im.code, unit: im.unit, cost: im.cost, price: im.price };
Â Â Â Â Â Â Â  if (idx !== -1) items[idx] = newItem; else items.push(newItem);
Â Â Â Â Â  });
Â Â Â Â Â  localStorage.setItem('itemsList', JSON.stringify(items));
Â Â Â Â Â  loadItemsFromLocalStorage();
Â Â Â  } finally {
Â Â Â Â Â  importExcelInput.value = '';
Â Â Â  }
Â  };
Â  reader.readAsBinaryString(file);
});

function showImportMessage(text) {
Â  const msg = document.createElement("div");
Â  msg.textContent = text;
Â  msg.style = `
Â Â Â  position: fixed;
Â Â Â  bottom: 20px;
Â Â Â  left: 50%;
Â Â Â  transform: translateX(-50%);
Â Â Â  background: #28a745;
Â Â Â  color: white;
Â Â Â  padding: 12px 20px;
Â Â Â  border-radius: 8px;
Â Â Â  font-size: 16px;
Â Â Â  z-index: 9999;
Â  `;
Â  document.body.appendChild(msg);
Â  setTimeout(() => msg.remove(), 3000);
}

/* ====== ØªØµØ¯ÙŠØ± Excel ====== */
document.getElementById("exportExcelBtn").addEventListener("click", function () {
Â  if (!itemsCache.length) return alert('âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±');
Â  const worksheet = XLSX.utils.json_to_sheet(itemsCache.map(i => ({ name: i.name, code: i.code, unit: i.unit, cost: i.cost, price: i.price })));
Â  const workbook = XLSX.utils.book_new();
Â  XLSX.utils.book_append_sheet(workbook, worksheet, "Items");
Â  XLSX.writeFile(workbook, "items.xlsx");
Â  showExportMessage("âœ”ï¸ ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø¥Ù„Ù‰ Excel");
});
function showExportMessage(text) {
Â  const msg = document.createElement("div");
Â  msg.textContent = text;
Â  msg.style = `
Â Â Â  position: fixed;
Â Â Â  bottom: 20px;
Â Â Â  left: 50%;
Â Â Â  transform: translateX(-50%);
Â Â Â  background: #007bff;
Â Â Â  color: white;
Â Â Â  padding: 12px 20px;
Â Â Â  border-radius: 8px;
Â Â Â  font-size: 16px;
Â Â Â  z-index: 9999;
Â  `;
Â  document.body.appendChild(msg);
Â  setTimeout(() => msg.remove(), 3000);
}

/* ====== ÙˆØ¸Ø§Ø¦Ù Ù…Ø³Ø§Ø¹Ø¯Ø© Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ====== */
function showItem(item) {
Â  itemName.value = item.name || "";
Â  itemCode.value = item.code || "";
Â  itemUnit.value = item.unit || "";
Â  itemCost.value = formatWithCommas(item.cost || "");
Â  itemPrice.value = formatWithCommas(item.price || "");
Â  originalDocId = docIdForCode(item.code);
}

function clearItemFields() {
Â  itemForm.reset();
Â  originalDocId = null;
Â  itemMessage.style.display = 'none';
Â  [itemName, itemCode, itemUnit, itemCost, itemPrice].forEach(inp => inp.style.background = '');
}
document.getElementById("cancelItemBtn").addEventListener("click", clearItemFields);

/* ØªÙ„ÙˆÙŠÙ† Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø¹Ù†Ø¯ Ø§Ù„ÙƒØªØ§Ø¨Ø© */
const fields = ["itemName","itemCode","itemUnit","itemCost","itemPrice"];
fields.forEach(id => {
Â  const input = document.getElementById(id);
Â  input.addEventListener("input", () => {
Â Â Â  if (input.value.trim() !== "") { input.style.background = "#d4edda"; input.style.border = "2px solid #28a745"; }
Â Â Â  else { input.style.background = ""; input.style.border = ""; }
Â  });
});

/* Ø±Ø¨Ø· Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„ÙØ±Ø² */
document.getElementById("searchInput").addEventListener("input", ()=>{
Â  const val = document.getElementById("searchInput").value.trim().toLowerCase();
Â  document.querySelectorAll("#itemsTable tbody tr").forEach(r=>{
Â Â Â  r.style.display = r.innerText.toLowerCase().includes(val) ? "" : "none";
Â  });
});
document.getElementById("sortSelect").addEventListener("change", renderItemsFromCache);

/* Ø¥Ø¨Ù‚Ø§Ø¡ Ø§Ù„Ù‚Ø³Ù… Ø¸Ø§Ù‡Ø±Ù‹Ø§ */
function showSection(id) {
Â  document.querySelectorAll('.form-section').forEach(s => s.style.display='none');
Â  const el = document.getElementById(id);
Â  if (el) el.style.display='block';
}
showSection('arafat');

/* Ø­Ù…Ø§ÙŠØ© Ù…Ù† Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù…Ø³Ø­ */
window.addEventListener('beforeunload', (e) => {
Â  if (isScanning) {
Â Â Â  e.preventDefault(); e.returnValue = '';
Â  }
});
</script>
</body>
</html>

