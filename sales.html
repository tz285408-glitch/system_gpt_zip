<!DOCTYPE html>
<html lang="ar">
<head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</title><link rel="stylesheet" href="css/style.css"></head>
<body>
<div class="logo card"><img src="assets/logo.png" onerror="this.src='https://via.placeholder.com/48'"><span>ğŸ’³ Ù…Ø¨ÙŠØ¹Ø§Øª</span></div>
<div class="app">
  <div class="sidebar card"><a href="index.html">â—€ Ø±Ø¬ÙˆØ¹</a></div>
  <div class="main">
    <div class="card">
      <div style="display:flex;gap:8px;align-items:center">
        <label>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</label>
        <select id="salePayType"><option>Ù†Ù‚Ø¯</option><option>Ø¨Ù†Ùƒ</option><option>Ø¢Ø¬Ù„</option></select>
        <label>Ø§Ù„Ø¹Ù…ÙŠÙ„ (Ø¥Ù† ÙƒØ§Ù† Ø¢Ø¬Ù„)</label>
        <select id="selectCustomer"></select>
        <label>ØªØ§Ø±ÙŠØ® Ø§Ù„ÙØ§ØªÙˆØ±Ø©</label><input id="saleDate" type="datetime-local">
      </div>
      <hr>
      <div style="display:flex;gap:8px;align-items:center">
        <select id="salesItemSelect"></select>
        <input id="salesQty" type="number" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ©" style="width:110px">
        <input id="salesPrice" type="number" placeholder="Ø§Ù„Ø³Ø¹Ø± (ØªÙ„Ù‚Ø§Ø¦ÙŠ)" style="width:140px">
        <button onclick="addSalesLine()">â• Ø¥Ø¶Ø§ÙØ© Ù„Ù„ØµÙ†Ù</button>
        <button onclick="openPickItemModal('sale')">ğŸ” Ø§Ø®ØªÙŠØ§Ø± ØµÙ†Ù</button>
      </div>
    </div>

    <div class="card">
      <h4>Ø³Ø·Ø± Ø§Ù„ÙØ§ØªÙˆØ±Ø©</h4>
      <table id="saleLines"><thead><tr><th>#</th><th>Ø±Ù‚Ù… Ø§Ù„ØµÙ†Ù</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„ÙˆØ­Ø¯Ø©</th><th>Ø§Ù„ÙƒÙ…ÙŠØ©</th><th>Ø§Ù„Ø³Ø¹Ø±</th><th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th><th>ØªØ­ÙƒÙ…</th></tr></thead><tbody></tbody></table>
      <div style="display:flex;gap:8px;align-items:center;justify-content:flex-end">
        <label>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹:<span id="saleSubtotal">0.00</span></label>
        <label>Ø§Ù„Ø®ØµÙ…:<input id="saleDiscount" type="number" value="0"></label>
        <label>Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©:<input id="saleTax" type="number" value="0"></label>
        <label>Ø§Ù„Ù†Ù‚Ù„:<input id="saleShip" type="number" value="0"></label>
        <label>ØµØ§ÙÙŠ:<span id="saleNet">0.00</span></label>
        <button onclick="saveSalesInvoiceUI()">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø©</button>
      </div>
    </div>

    <div class="card">
      <h4>Ù…Ø±ØªØ¬Ø¹Ø§Øª Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</h4>
      <table id="srTable"><thead><tr><th>#</th><th>Ø±Ù‚Ù…</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th></tr></thead><tbody></tbody></table>
    </div>
  </div>
</div>

<script src="js/firebase-config.js"></script>
<script src="js/app.js"></script>
<script>
function renderCustomersSelect(){ const el=document.getElementById('selectCustomer'); el.innerHTML=''; const arr=DB.getCustomers(); arr.forEach(c=>{ const o=document.createElement('option'); o.value=c.id; o.text=`${c.id} - ${c.name}`; el.appendChild(o); }); }
function addSalesLine(){
  const itemId = Number(document.getElementById('salesItemSelect').value);
  const qty = Number(document.getElementById('salesQty').value||0);
  const price = Number(document.getElementById('salesPrice').value||0);
  if(!itemId || qty<=0) return alert('Ø§Ø®ØªØ± Ø§Ù„ØµÙ†Ù ÙˆØ§Ø¯Ø®Ù„ ÙƒÙ…ÙŠØ© ØµØ­ÙŠØ­Ø©');
  const item = DB.getItems().find(x=>x.id==itemId);
  const tbody=document.querySelector('#saleLines tbody');
  const tr=document.createElement('tr'); const idx=tbody.rows.length+1;
  tr.innerHTML=`<td>${idx}</td><td>${itemId}</td><td>${item.name}</td><td>${item.unit}</td><td><input class="line-qty" type="number" value="${qty}"></td><td><input class="line-price" type="number" value="${price}"></td><td class="line-sum">${(qty*price).toFixed(2)}</td><td><button onclick="this.closest('tr').remove(); updateSaleTotals()">âœ–</button></td>`;
  tbody.appendChild(tr); updateSaleTotals();
  tr.querySelector('.line-qty').addEventListener('input', updateSaleTotals); tr.querySelector('.line-price').addEventListener('input', updateSaleTotals);
  document.getElementById('salesQty').value=''; document.getElementById('salesPrice').value='';
}
function updateSaleTotals(){
  const tbody=document.querySelector('#saleLines tbody'); let subtotal=0; Array.from(tbody.rows).forEach(r=>{ const q=Number(r.querySelector('.line-qty').value||0); const p=Number(r.querySelector('.line-price').value||0); r.querySelector('.line-sum').textContent=(q*p).toFixed(2); subtotal += q*p; }); document.getElementById('saleSubtotal').textContent=subtotal.toFixed(2);
  const disc=Number(document.getElementById('saleDiscount').value||0); const tax=Number(document.getElementById('saleTax').value||0); const ship=Number(document.getElementById('saleShip').value||0); document.getElementById('saleNet').textContent=(subtotal - disc + tax + ship).toFixed(2);
}
function saveSalesInvoiceUI(){
  const lines = Array.from(document.querySelectorAll('#saleLines tbody tr')).map(r=>({ itemId:Number(r.cells[1].innerText), name:r.cells[2].innerText, unit:r.cells[3].innerText, qty:Number(r.querySelector('.line-qty').value||0), price:Number(r.querySelector('.line-price').value||0) }));
  const payType = document.getElementById('salePayType').value;
  const customerId = Number(document.getElementById('selectCustomer').value)||null;
  const discount = Number(document.getElementById('saleDiscount').value||0); const tax=Number(document.getElementById('saleTax').value||0); const ship=Number(document.getElementById('saleShip').value||0);
  const res = App.saveSalesInvoice({payType, customerId, lines, discount, tax, shipping:ship});
  if(res.ok){ alert('ØªÙ… Ø­ÙØ¸ ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª'); document.querySelector('#saleLines tbody').innerHTML=''; updateSaleTotals(); renderSalesReturns(); App.populateAllSelects(); } else alert(res.msg||'Ø®Ø·Ø£');
}
function renderSalesReturns(){ const tbody=document.querySelector('#srTable tbody'); tbody.innerHTML=''; const arr=DB.getSalesReturns(); arr.forEach((r,i)=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${i+1}</td><td>${r.invoiceNo}</td><td>${Number(r.subtotal).toFixed(2)}</td><td>${r.date||r.savedAt}</td>`; tbody.appendChild(tr);}); }
initApp().then(()=>{ renderCustomersSelect(); renderSalesReturns(); });
</script>
</body>
</html>
