<!doctype html>
<html lang="ar">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>نظام مطاعم - POS (Sunmi) — نسخة معدلة</title>
<style>
  :root{
    --bg:#f5f7fa; --card:#ffffff; --muted:#6b7280; --accent:#0d9488;
    --table-head:#083344; --table-row:#e6f7f7; --danger:#b00020; --success:#006400;
    --header-grad: linear-gradient(180deg,#e6f7f7,#dff3f2);
  }
  body{font-family:"Noto Naskh Arabic", Tahoma, Arial; direction:rtl; margin:0; background:var(--bg); color:#111}
  .sidebar{position:fixed; left:0; top:0; bottom:0; width:220px; background:linear-gradient(180deg,#063a3a,#095959); color:#fff; padding:12px; box-sizing:border-box; display:flex; flex-direction:column; gap:8px; z-index:30}
  .sidebar h3{margin:0 0 6px 0; font-size:16px}
  .sidebtn{background:transparent;color:#fff;border:1px solid rgba(255,255,255,0.08); padding:10px;border-radius:6px; text-align:center; cursor:pointer; display:flex; justify-content:space-between; align-items:center}
  .sidebtn:hover{background:rgba(255,255,255,0.04)}
  .content{margin-right:240px; padding:14px}
  .topbar{display:flex;gap:12px;align-items:center;margin-bottom:12px; flex-wrap:wrap}
  .card{background:var(--card);padding:12px;border-radius:8px;box-shadow:0 1px 3px rgba(0,0,0,0.06);margin-bottom:12px}
  .row{display:flex;gap:8px;align-items:center}
  .controls{display:flex;gap:8px;flex-wrap:wrap}
  input,select,button,textarea{padding:8px;border:1px solid #d1d5db;border-radius:6px;font-size:14px}
  button{cursor:pointer}
  table{width:100%;border-collapse:collapse;margin-top:8px;background:var(--card); box-shadow: inset 0 0 0 1px rgba(0,0,0,0.03)}
  th,td{padding:10px;border-bottom:1px solid rgba(0,0,0,0.06); text-align:center}
  th{background:var(--header-grad); color:var(--table-head); position:sticky; top:0; z-index:5}
  tbody tr:nth-child(odd){background:#ffffff}
  tbody tr:nth-child(even){background:var(--table-row)}
  .small{font-size:12px;color:var(--muted)}
  .actions button{margin-left:6px}
  .badge{background:var(--accent);color:#fff;padding:6px 10px;border-radius:999px}
  .modal{position:fixed;inset:0; background:rgba(0,0,0,0.45); display:none; align-items:center; justify-content:center; z-index:50}
  .modal .box{width:94%; max-width:1100px; max-height:88%; overflow:auto; border-radius:8px; padding:12px; background:var(--card)}
  .table-scroll{max-height:420px; overflow:auto; border-radius:6px}
  .right-actions{display:flex; gap:6px}
  .top-actions{display:flex; gap:8px; align-items:center}
  .btn-primary{background:var(--accent); color:#fff; border:none; padding:8px 12px; border-radius:6px}
  .btn-secondary{background:#f3f4f6;border:none;padding:8px 12px;border-radius:6px}
  .btn-danger{background:var(--danger); color:#fff;border:none;padding:8px 12px;border-radius:6px}
  .fixed-header{position:sticky; top:0; background:#fff; padding:8px; z-index:10}
  .help{font-size:13px;color:#374151}
  .selected-row{outline:3px solid rgba(13,148,136,0.18)}
  @media (max-width:900px){
    .sidebar{display:none}
    .content{margin:0}
    .row{flex-direction:column; align-items:stretch}
  }
</style>
</head>
<body>

<div class="sidebar" aria-label="شريط الملاحة">
  <h3>قوائم النظام</h3>
  <button class="sidebtn" onclick="scrollTo('add_item')"><span>1</span><strong>إضافة صنف</strong></button>
  <button class="sidebtn" onclick="scrollTo('items_list')"><span>2</span><strong>قائمة الأصناف</strong></button>
  <button class="sidebtn" onclick="scrollTo('add_purchase')"><span>3</span><strong>إضافة فاتورة مشتريات</strong></button>
  <button class="sidebtn" onclick="scrollTo('pur_list')"><span>4</span><strong>قائمة مشتريات</strong></button>
  <button class="sidebtn" onclick="scrollTo('pur_report')"><span>5</span><strong>تقرير مشتريات</strong></button>
  <button class="sidebtn" onclick="scrollTo('add_sale')"><span>6</span><strong>إضافة فاتورة مبيعات</strong></button>
  <button class="sidebtn" onclick="scrollTo('sale_list')"><span>7</span><strong>قائمة مبيعات</strong></button>
  <button class="sidebtn" onclick="scrollTo('sale_report')"><span>8</span><strong>تقرير مبيعات</strong></button>

  <div style="margin-top:auto">
    <div class="small">الوضع الحالي:</div>
    <div id="side_mode" style="margin-top:6px" class="badge"></div>
  </div>
</div>

<div class="content">
  <h1>نظام مطاعم - POS (Sunmi) — نسخة معدلة</h1>

  <div class="card topbar" style="display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap">
    <div style="display:flex; gap:10px; align-items:center;">
      <label>وضع التكلفة: </label>
      <select id="mode"></select>
      <span class="small">اختر طريقة حساب تكلفة المخزون</span>
    </div>
    <div class="top-actions">
      <button onclick="exportData()" class="btn-secondary">تصدير بيانات</button>
      <button onclick="promptImport()" class="btn-secondary">استيراد بيانات</button>
      <button onclick="clearAll()" class="btn-danger">مسح كل البيانات</button>
    </div>
  </div>

  <!-- 1. Add Item -->
  <div id="add_item" class="card">
    <h2>1- إضافة صنف جديد</h2>
    <div class="row">
      <input id="item_name" placeholder="اسم الصنف" />
      <input id="item_unit" placeholder="الوحدة (مثال: حبة، صحن)" />
      <input id="item_cost" placeholder="التكلفة الافتراضية" type="number" step="0.01" />
      <input id="item_price" placeholder="السعر" type="number" step="0.01" />
      <input id="item_open_qty" placeholder="كمية أول المدة" type="number" step="1" />
      <button onclick="addItem()" class="btn-primary">إضافة صنف</button>
    </div>
    <div class="small">معرّف الصنف يُنشأ تلقائياً. تكلفة يدوية هنا تُستخدم كتكلفة افتراضية للشراء القادم (لا تغيّر دفعات سابقة).</div>
  </div>

  <!-- 2. Items List -->
  <div id="items_list" class="card">
    <h2>2- قائمة الأصناف</h2>
    <div class="row" style="justify-content:space-between">
      <div style="display:flex;gap:8px;align-items:center;">
        <input id="search_items" placeholder="بحث باسم الصنف أو رقم التعريف" oninput="renderItems()" />
        <select id="sort_items" onchange="renderItems()">
          <option value="id.asc">رقم ↑</option>
          <option value="id.desc">رقم ↓</option>
          <option value="qty.desc">أعلى مخزون</option>
          <option value="qty.asc">أقل مخزون</option>
          <option value="cost.desc">أعلى تكلفة</option>
          <option value="cost.asc">أقل تكلفة</option>
          <option value="price.desc">أعلى سعر</option>
          <option value="price.asc">أقل سعر</option>
        </select>
      </div>
      <div class="small" id="items_count"></div>
    </div>

    <div class="table-scroll">
      <table id="items_table">
        <thead>
          <tr>
            <th>قبل</th><th>ID</th><th>الاسم</th><th>الوحدة</th><th>التكلفة</th><th>السعر</th><th>فتح</th><th>مشتريات</th><th>مبيعات</th><th>المخزون(كمية)</th><th>إجمالي القيمة</th><th>إجراءات</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <div class="small">عند تعديل التكلفة اليدوية لا تُضرب فتح×التكلفة الجديدة — فتح يبقى بقيمته الأصلية من أجل حساب الأرباح.</div>
  </div>

  <!-- 3. Add Purchase -->
  <div id="add_purchase" class="card">
    <h2>3- إضافة فاتورة مشتريات</h2>
    <div class="row">
      <label style="min-width:120px">رقم الفاتورة</label>
      <input id="pur_invoice_no" readonly />
      <input id="pur_source" placeholder="المصدر / مورد" />
      <input id="pur_date" type="date" />
      <input id="pur_note" placeholder="ملاحظة" />
      <div class="right-actions">
        <button onclick="savePurchase(true)" class="btn-primary">حفظ وطباعـة</button>
        <button onclick="savePurchase(false)" class="btn-secondary">حفظ</button>
        <button onclick="clearPurchaseFields()" class="btn-secondary">تفريغ الحقول</button>
        <button onclick="scrollToTop()" class="btn-secondary">رجوع</button>
      </div>
    </div>

    <h3 style="margin-top:12px">بنود الفاتورة</h3>
    <div class="row">
      <button class="btn-secondary" onclick="openItemModal('pur')">عرض قائمة الأصناف</button>
      <select id="pur_item_select"></select>
      <input id="pur_item_unit" disabled placeholder="الوحدة" />
      <input id="pur_item_cost" placeholder="التكلفة" type="number" step="0.01" />
      <input id="pur_item_qty" placeholder="الكمية" type="number" step="1" />
      <button onclick="addPurchaseLine()" class="btn-primary">أضف للصنف</button>
    </div>

    <div class="table-scroll">
      <table id="pur_lines_table">
        <thead>
          <tr><th>#</th><th>الصنف</th><th>الوحدة</th><th>التكلفة</th><th>الكمية</th><th>الإجمالي</th><th>إجراء</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="row" style="justify-content:space-between; margin-top:8px;">
      <div class="small">عدد الأصناف: <span id="pur_lines_count">0</span></div>
      <div class="small">المجموع: <span id="pur_total">0.00</span></div>
    </div>
  </div>

  <!-- 4. Purchases List -->
  <div id="pur_list" class="card">
    <h2>4- قائمة فواتير المشتريات</h2>
    <div class="row">
      من: <input id="pur_filter_from" type="date" /> إلى: <input id="pur_filter_to" type="date" />
      <button onclick="renderPurchases()" class="btn-secondary">فلتر</button>
      <input id="pur_search" placeholder="بحث برقم الفاتورة أو المصدر" oninput="renderPurchases()" />
    </div>
    <div class="small">عدد الفواتير: <span id="pur_count">0</span> — المجموع: <span id="pur_sum">0.00</span></div>

    <div class="table-scroll">
      <table id="purchases_table">
        <thead><tr><th>رقم</th><th>تاريخ</th><th>المصدر</th><th>إجمالي</th><th>عرض</th><th>طباعة</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- 5. Purchase Report -->
  <div id="pur_report" class="card">
    <h2>5- تقرير مشتريات (حسب الأصناف)</h2>
    <div class="row">
      من: <input id="rep_pur_from" type="date" /> إلى: <input id="rep_pur_to" type="date" />
      <select id="rep_pur_sort">
        <option value="name.asc">اسم ↑</option>
        <option value="qty.desc">أعلى كمية</option>
        <option value="qty.asc">أقل كمية</option>
        <option value="cost.desc">أعلى تكلفة</option>
        <option value="cost.asc">أقل تكلفة</option>
        <option value="total.desc">أعلى إجمالي</option>
        <option value="total.asc">أقل إجمالي</option>
      </select>
      <button onclick="renderPurchaseReport()" class="btn-secondary">عرض التقرير</button>
    </div>
    <div class="small">عدد أصناف: <span id="rep_pur_count">0</span> — المجموع: <span id="rep_pur_sum">0.00</span></div>
    <div class="table-scroll">
      <table id="rep_pur_table">
        <thead><tr><th>الصنف</th><th>الوحدة</th><th>التكلفة</th><th>الكمية</th><th>الإجمالي</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- 6. Sales -->
  <div id="add_sale" class="card">
    <h2>6- مبيعات</h2>
    <div class="row">
      <label style="min-width:120px">رقم الفاتورة</label>
      <input id="sale_invoice_no" readonly />
      <input id="sale_source" placeholder="المصدر / زبون" />
      <input id="sale_date" type="date" />
      <input id="sale_note" placeholder="ملاحظة" />
      <div class="right-actions">
        <button onclick="saveSale(true)" class="btn-primary">حفظ وطباعـة</button>
        <button onclick="saveSale(false)" class="btn-secondary">حفظ</button>
        <button onclick="clearSaleFields()" class="btn-secondary">تفريغ الحقول</button>
        <button onclick="scrollToTop()" class="btn-secondary">رجوع</button>
      </div>
    </div>

    <h3 style="margin-top:12px">بنود الفاتورة</h3>
    <div class="row">
      <button class="btn-secondary" onclick="openItemModal('sale')">عرض قائمة الأصناف</button>
      <select id="sale_item_select"></select>
      <input id="sale_item_unit" disabled placeholder="الوحدة" />
      <input id="sale_item_price" placeholder="السعر" type="number" step="0.01" />
      <input id="sale_item_qty" placeholder="الكمية" type="number" step="1" />
      <button onclick="addSaleLine()" class="btn-primary">أضف للصنف</button>
    </div>

    <div class="table-scroll">
      <table id="sale_lines_table">
        <thead><tr><th>#</th><th>الصنف</th><th>الوحدة</th><th>السعر</th><th>الكمية</th><th>الإجمالي</th><th>الإجراء</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="row" style="justify-content:space-between; margin-top:8px;">
      <div class="small">عدد الأصناف: <span id="sale_lines_count">0</span></div>
      <div class="small">المجموع: <span id="sale_total">0.00</span></div>
    </div>
    <div class="small">ملاحظة: النظام يقبل الكمية مباشرة ويتيح رصيد سلبي إن لزم.</div>
  </div>

  <!-- 7. Sales list -->
  <div id="sale_list" class="card">
    <h2>7- قائمة فواتير المبيعات</h2>
    <div class="row">
      من: <input id="sale_filter_from" type="date" /> إلى: <input id="sale_filter_to" type="date" />
      <button onclick="renderSales()" class="btn-secondary">فلتر</button>
      <input id="sale_search" placeholder="بحث برقم الفاتورة أو المصدر" oninput="renderSales()" />
    </div>
    <div class="small">عدد الفواتير: <span id="sale_count">0</span> — المجموع: <span id="sale_sum">0.00</span></div>

    <div class="table-scroll">
      <table id="sales_table">
        <thead><tr><th>رقم</th><th>تاريخ</th><th>المصدر</th><th>إجمالي</th><th>الربح</th><th>عرض</th><th>طباعة</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- 8. Sales report -->
  <div id="sale_report" class="card">
    <h2>8- تقرير مبيعات (حسب الأصناف)</h2>
    <div class="row">
      من: <input id="rep_sale_from" type="date" /> إلى: <input id="rep_sale_to" type="date" />
      <select id="rep_sale_sort">
        <option value="name.asc">اسم ↑</option>
        <option value="qty.desc">أعلى كمية</option>
        <option value="qty.asc">أقل كمية</option>
        <option value="price.desc">أعلى سعر</option>
        <option value="price.asc">أقل سعر</option>
        <option value="total.desc">أعلى إجمالي</option>
        <option value="total.asc">أقل إجمالي</option>
      </select>
      <button onclick="renderSalesReport()" class="btn-secondary">عرض التقرير</button>
    </div>
    <div class="small">عدد أصناف: <span id="rep_sale_count">0</span> — المجموع: <span id="rep_sale_sum">0.00</span> — تكلفة المبيعات: <span id="rep_sale_cost_sum">0.00</span> — أرباح المبيعات: <span id="rep_sale_profit">0.00</span></div>
    <div class="table-scroll">
      <table id="rep_sale_table">
        <thead><tr><th>الصنف</th><th>الوحدة</th><th>السعر</th><th>الكمية</th><th>الإجمالي</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

</div>

<!-- Modal: items list -->
<div id="item_modal" class="modal" onclick="closeModal(event)">
  <div class="box" role="dialog" aria-modal="true" onclick="event.stopPropagation()">
    <div style="display:flex; justify-content:space-between; align-items:center; gap:8px">
      <h3>قائمة الأصناف</h3>
      <div>
        <input id="modal_search" placeholder="بحث..." oninput="renderModalItems()" />
        <button onclick="closeItemModal()" class="btn-secondary">إغلاق</button>
      </div>
    </div>
    <div class="table-scroll" style="margin-top:8px">
      <table id="modal_items_table">
        <thead>
          <tr><th>ID</th><th>الصنف</th><th>الوحدة</th><th>التكلفة</th><th>السعر</th><th>المخزون(كمية)</th><th>اختيار</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>

<script>
/* بيانات مخزنة في localStorage:
settings, items, batches, purchases, sales, nextSaleNo, nextPurNo
*/
function uid(prefix='id'){return prefix + '_' + Math.random().toString(36).slice(2,9)}
function load(key,def){ try{const v=localStorage.getItem(key); return v?JSON.parse(v):def }catch(e){return def}}
function save(key,val){ localStorage.setItem(key,JSON.stringify(val)) }

let settings = load('settings',{mode:'batch'})
let items = load('items',[])
let batches = load('batches',[])
let purchases = load('purchases',[])
let sales = load('sales',[])
let nextSaleNo = load('nextSaleNo', 1)
let nextPurNo = load('nextPurNo', 1)

function persistAll(){ save('settings',settings); save('items',items); save('batches',batches); save('purchases',purchases); save('sales',sales); save('nextSaleNo',nextSaleNo); save('nextPurNo',nextPurNo) }

/* UI init */
const modeSelect = document.getElementById('mode')
modeSelect.innerHTML = '<option value="batch">دفعات (Batch)</option><option value="average">المتوسط المرجّح (Weighted Average)</option>'
modeSelect.value = settings.mode
modeSelect.addEventListener('change', e=>{ settings.mode = e.target.value; save('settings',settings); renderItems(); document.getElementById('side_mode').textContent = settings.mode })

document.getElementById('side_mode').textContent = settings.mode

/* Invoice numbers */
function formatInvoicePrefix(type, no){
  // يمكن تعديل التنسيق هنا
  return (type==='sale'?'S-':'P-') + String(no).padStart(5,'0')
}
function setInvoiceNumbers(){
  document.getElementById('sale_invoice_no').value = formatInvoicePrefix('sale', nextSaleNo)
  document.getElementById('pur_invoice_no').value = formatInvoicePrefix('pur', nextPurNo)
}
setInvoiceNumbers()

/* Items management */
function addItem(){
  const name = document.getElementById('item_name').value.trim()
  const unit = document.getElementById('item_unit').value.trim() || 'pcs'
  const cost = parseFloat(document.getElementById('item_cost').value) || 0
  const price = parseFloat(document.getElementById('item_price').value) || 0
  const openQty = parseInt(document.getElementById('item_open_qty').value) || 0
  if(!name){ alert('ادخل اسم الصنف'); return }
  const id = uid('item')
  const item = {id,name,unit,manualCost:cost,price,openingQty:openQty,openingValue: openQty*cost,avgCost: cost}
  items.push(item)
  if(openQty>0){
    const b = {id:uid('batch'),itemId:id,qty:openQty,remainingQty:openQty,cost:cost,type:'opening',date:new Date().toISOString(),note:'opening'}
    batches.push(b)
  }
  persistAll()
  clearItemForm()
  renderItems(); fillItemSelects()
}
function clearItemForm(){ ['item_name','item_unit','item_cost','item_price','item_open_qty'].forEach(id=>document.getElementById(id).value='') }

function fillItemSelects(){
  const selIds = ['pur_item_select','sale_item_select']
  selIds.forEach(selId=>{
    const sel = document.getElementById(selId); sel.innerHTML=''
    items.forEach(it=>{
      const opt = document.createElement('option'); opt.value = it.id; opt.textContent = `${it.name} [${it.id}]`; sel.appendChild(opt)
    })
    sel.onchange = function(){
      const id = sel.value; const it = items.find(x=>x.id===id)
      if(!it) return
      if(selId==='pur_item_select'){
        document.getElementById('pur_item_unit').value = it.unit
        document.getElementById('pur_item_cost').value = it.manualCost || ''
      }else{
        document.getElementById('sale_item_unit').value = it.unit
        document.getElementById('sale_item_price').value = it.price || ''
      }
    }
  })
}
fillItemSelects()

function itemStockQty(itemId){
  return batches.filter(b=>b.itemId===itemId).reduce((s,b)=>s + (b.remainingQty||0),0)
}
function itemStockValue(itemId){
  return batches.filter(b=>b.itemId===itemId).reduce((s,b)=>s + (b.remainingQty||0)*(b.cost||0),0)
}
function renderItems(){
  const tbody = document.querySelector('#items_table tbody'); tbody.innerHTML=''
  const q = document.getElementById('search_items').value.trim().toLowerCase()
  let list = items.filter(it=>it.name.toLowerCase().includes(q) || it.id.toLowerCase().includes(q))
  const sort = document.getElementById('sort_items').value
  list.sort((a,b)=>{
    const [k,dir] = sort.split('.')
    let va, vb
    if(k==='id'){ va=a.id; vb=b.id }
    else if(k==='qty'){ va=itemStockQty(a.id); vb=itemStockQty(b.id) }
    else if(k==='cost'){ va=(a.manualCost||0); vb=(b.manualCost||0) }
    else if(k==='price'){ va=(a.price||0); vb=(b.price||0) }
    if(typeof va === 'string') return dir==='asc'? va.localeCompare(vb): vb.localeCompare(va)
    return dir==='asc'? (va-vb):(vb-va)
  })
  list.forEach(it=>{
    const tr = document.createElement('tr')
    const stockQty = itemStockQty(it.id)
    const totalVal = itemStockValue(it.id)
    const purchasesCount = purchases.reduce((s,p)=> s + p.lines.filter(l=>l.itemId===it.id).reduce((ss,l)=>ss+l.qty,0),0)
    const salesCount = sales.reduce((s,p)=> s + p.lines.filter(l=>l.itemId===it.id).reduce((ss,l)=>ss+l.qty,0),0)
    tr.innerHTML = `<td>—</td>
      <td>${it.id}</td>
      <td>${it.name}</td>
      <td>${it.unit}</td>
      <td>${formatNumber(it.manualCost)} ${settings.mode==='average'? '<br><span class="small">avg:'+formatNumber(it.avgCost||0)+'</span>':''}</td>
      <td>${formatNumber(it.price)}</td>
      <td>${it.openingQty||0}</td>
      <td>${purchasesCount}</td>
      <td>${salesCount}</td>
      <td>${stockQty}</td>
      <td>${formatNumber(totalVal)}</td>
      <td class="actions">
        <button onclick="editItem('${it.id}')" class="btn-secondary">تعديل</button>
        <button onclick="viewBatches('${it.id}')" class="btn-secondary">دفعات</button>
      </td>`
    tbody.appendChild(tr)
  })
  document.getElementById('items_count').textContent = `عرض ${list.length} من ${items.length} أصناف`
}

/* Edit / view batches */
function editItem(id){
  const it = items.find(x=>x.id===id)
  if(!it){ alert('الصنف غير موجود'); return }
  const newName = prompt('اسم الصنف', it.name); if(newName===null) return
  const newUnit = prompt('الوحدة', it.unit); if(newUnit===null) return
  const newManual = parseFloat(prompt('التكلفة اليدوية الافتراضية (لن تغيّر دفعات سابقة)', it.manualCost || 0))
  const newPrice = parseFloat(prompt('السعر', it.price || 0))
  it.name = newName || it.name
  it.unit = newUnit || it.unit
  it.manualCost = isNaN(newManual)? it.manualCost: newManual
  it.price = isNaN(newPrice)? it.price: newPrice
  persistAll(); renderItems(); fillItemSelects()
}
function viewBatches(itemId){
  const b = batches.filter(x=>x.itemId===itemId)
  if(b.length===0){ alert('لا دفعات لهذا الصنف'); return }
  let msg = 'دفعات الصنف:\n'
  b.forEach(x=> msg += `${x.id} | نوع:${x.type} | تاريخ:${(new Date(x.date)).toLocaleDateString()} | كمية:${x.qty} | متبقي:${x.remainingQty} | تكلفة:${formatNumber(x.cost)}\n`)
  alert(msg)
}

/* --- Purchases --- */
let currentPurLines = []
function addPurchaseLine(){
  const itemId = document.getElementById('pur_item_select').value
  const it = items.find(x=>x.id===itemId)
  if(!it){ alert('اختر صنف'); return }
  const unit = it.unit
  const cost = parseFloat(document.getElementById('pur_item_cost').value) || it.manualCost || 0
  const qty = parseInt(document.getElementById('pur_item_qty').value) || 0
  if(qty<=0){ alert('ادخل كمية أكبر من صفر'); return }
  const total = qty * cost
  const line = {id:uid('pline'),itemId,unit,cost,qty,total}
  currentPurLines.push(line)
  renderPurLines()
}
function renderPurLines(){
  const tbody = document.querySelector('#pur_lines_table tbody'); tbody.innerHTML=''
  currentPurLines.forEach((l,i)=>{
    const tr = document.createElement('tr')
    tr.innerHTML = `<td>${i+1}</td><td>${items.find(it=>it.id===l.itemId).name}</td><td>${l.unit}</td><td>${formatNumber(l.cost)}</td><td>${l.qty}</td><td>${formatNumber(l.total)}</td><td><button onclick="removePurLine('${l.id}')" class="btn-secondary">حذف</button></td>`
    tbody.appendChild(tr)
  })
  const total = currentPurLines.reduce((s,l)=>s+l.total,0)
  document.getElementById('pur_lines_count').textContent = currentPurLines.length
  document.getElementById('pur_total').textContent = formatNumber(total)
}
function removePurLine(id){ currentPurLines = currentPurLines.filter(l=>l.id!==id); renderPurLines() }

function savePurchase(printAfter){
  if(currentPurLines.length===0){ alert('لا توجد بنود للحفظ'); return }
  const invoiceNoStr = formatInvoicePrefix('pur', nextPurNo)
  const invoiceNo = invoiceNoStr
  const source = document.getElementById('pur_source').value.trim() || ''
  const date = document.getElementById('pur_date').value || new Date().toISOString().slice(0,10)
  const note = document.getElementById('pur_note').value || ''
  const pur = {id:uid('purchase'),invoiceNo,source,date,note,lines: JSON.parse(JSON.stringify(currentPurLines)),total: currentPurLines.reduce((s,l)=>s+l.total,0)}
  pur.lines.forEach(l=>{
    const item = items.find(it=>it.id===l.itemId)
    if(settings.mode==='batch'){
      const b = {id:uid('batch'),itemId:l.itemId,qty:l.qty,remainingQty:l.qty,cost:l.cost,type:'purchase',date:new Date().toISOString(),note:`pur:${invoiceNo}`}
      batches.push(b)
    }else{
      const currentQty = itemStockQty(l.itemId)
      const currentVal = itemStockValue(l.itemId)
      const newQty = currentQty + l.qty
      const newVal = currentVal + l.total
      const newAvg = newQty>0? (newVal/newQty): l.cost
      item.avgCost = newAvg
      const b = {id:uid('batch'),itemId:l.itemId,qty:l.qty,remainingQty:l.qty,cost:newAvg,type:'purchase',date:new Date().toISOString(),note:`pur:${invoiceNo}`}
      batches.push(b)
    }
  })
  purchases.push(pur)
  nextPurNo += 1
  persistAll()
  currentPurLines = []
  renderPurLines()
  renderPurchases()
  renderItems()
  fillItemSelects()
  clearPurchaseFields()
  setInvoiceNumbers()
  if(printAfter) printPurchase(pur.id)
  alert('حفظت فاتورة المشتريات: ' + invoiceNo)
}

/* Purchases list */
function renderPurchases(){
  const tbody = document.querySelector('#purchases_table tbody'); tbody.innerHTML=''
  const from = document.getElementById('pur_filter_from').value
  const to = document.getElementById('pur_filter_to').value
  const q = document.getElementById('pur_search').value.trim().toLowerCase()
  let list = purchases.filter(p=>{
    if(q && !(p.invoiceNo.toLowerCase().includes(q) || (p.source||'').toLowerCase().includes(q))) return false
    if(from && p.date < from) return false
    if(to && p.date > to) return false
    return true
  })
  let sum=0
  list.forEach(p=>{
    sum += p.total
    const tr = document.createElement('tr')
    tr.innerHTML = `<td>${p.invoiceNo}</td><td>${p.date}</td><td>${p.source}</td><td>${formatNumber(p.total)}</td><td><button onclick="viewPurchase('${p.id}')" class="btn-secondary">عرض</button></td><td><button onclick="printPurchase('${p.id}')" class="btn-secondary">طباعة</button></td>`
    tbody.appendChild(tr)
  })
  document.getElementById('pur_count').textContent = list.length
  document.getElementById('pur_sum').textContent = formatNumber(sum)
}
function viewPurchase(id){
  const p = purchases.find(x=>x.id===id)
  if(!p) return alert('غير موجود')
  let txt = `فاتورة مشتريات #${p.invoiceNo}\nالتاريخ: ${p.date}\nالمصدر: ${p.source}\nالمجموع: ${formatNumber(p.total)}\nبنود:\n`
  p.lines.forEach(l=> txt += `${items.find(it=>it.id===l.itemId).name} | تكلفة:${formatNumber(l.cost)} | كمية:${l.qty} | إجمالي:${formatNumber(l.total)}\n`)
  alert(txt)
}

/* Purchase report */
function renderPurchaseReport(){
  const from = document.getElementById('rep_pur_from').value
  const to = document.getElementById('rep_pur_to').value
  const sort = document.getElementById('rep_pur_sort').value
  let map = {}
  purchases.forEach(p=>{
    if(from && p.date < from) return
    if(to && p.date > to) return
    p.lines.forEach(l=>{
      if(!map[l.itemId]) map[l.itemId] = {qty:0,total:0,cost: l.cost, item: items.find(it=>it.id===l.itemId)}
      map[l.itemId].qty += l.qty
      map[l.itemId].total += l.total
    })
  })
  let arr = Object.values(map)
  arr.sort((a,b)=>{
    const [k,d] = sort.split('.')
    if(k==='name') return a.item.name.localeCompare(b.item.name)
    if(k==='qty') return d==='desc'? b.qty-a.qty: a.qty-b.qty
    if(k==='cost') return d==='desc'? b.cost-a.cost: a.cost-b.cost
    if(k==='total') return d==='desc'? b.total-a.total: a.total-b.total
    return 0
  })
  const tbody = document.querySelector('#rep_pur_table tbody'); tbody.innerHTML=''
  let sum=0
  arr.forEach(r=>{
    const tr = document.createElement('tr')
    tr.innerHTML = `<td>${r.item.name}</td><td>${r.item.unit}</td><td>${formatNumber(r.cost)}</td><td>${r.qty}</td><td>${formatNumber(r.total)}</td>`
    tbody.appendChild(tr)
    sum += r.total
  })
  document.getElementById('rep_pur_count').textContent = arr.length
  document.getElementById('rep_pur_sum').textContent = formatNumber(sum)
}

/* --- Sales --- */
let currentSaleLines = []
function addSaleLine(){
  const itemId = document.getElementById('sale_item_select').value
  const it = items.find(x=>x.id===itemId)
  if(!it){ alert('اختر صنف'); return }
  const unit = it.unit
  const price = parseFloat(document.getElementById('sale_item_price').value) || it.price || 0
  const qty = parseInt(document.getElementById('sale_item_qty').value) || 0
  if(qty<=0){ alert('ادخل كمية أكبر من صفر'); return }
  const total = qty * price
  const line = {id:uid('sline'),itemId,unit,price,qty,total}
  currentSaleLines.push(line)
  renderSaleLines()
}
function renderSaleLines(){
  const tbody = document.querySelector('#sale_lines_table tbody'); tbody.innerHTML=''
  currentSaleLines.forEach((l,i)=>{
    const tr = document.createElement('tr')
    tr.innerHTML = `<td>${i+1}</td><td>${items.find(it=>it.id===l.itemId).name}</td><td>${l.unit}</td><td>${formatNumber(l.price)}</td><td>${l.qty}</td><td>${formatNumber(l.total)}</td><td><button onclick="removeSaleLine('${l.id}')" class="btn-secondary">حذف</button></td>`
    tbody.appendChild(tr)
  })
  const total = currentSaleLines.reduce((s,l)=>s+l.total,0)
  document.getElementById('sale_lines_count').textContent = currentSaleLines.length
  document.getElementById('sale_total').textContent = formatNumber(total)
}
function removeSaleLine(id){ currentSaleLines = currentSaleLines.filter(l=>l.id!==id); renderSaleLines() }

function saveSale(printAfter){
  if(currentSaleLines.length===0){ alert('لا توجد بنود للحفظ'); return }
  const invoiceNo = formatInvoicePrefix('sale', nextSaleNo)
  const source = document.getElementById('sale_source').value.trim() || ''
  const date = document.getElementById('sale_date').value || new Date().toISOString().slice(0,10)
  const note = document.getElementById('sale_note').value || ''

  let sale = {id:uid('sale'),invoiceNo,source,date,note,lines:[],total:0,costTotal:0}
  currentSaleLines.forEach(l=>{
    let remaining = l.qty
    let costForLine = 0
    if(settings.mode==='batch'){
      const itemBatches = batches.filter(b=>b.itemId===l.itemId && b.remainingQty>0).sort((a,b)=> new Date(a.date) - new Date(b.date))
      for(const b of itemBatches){
        if(remaining<=0) break
        const take = Math.min(b.remainingQty, remaining)
        b.remainingQty -= take
        remaining -= take
        costForLine += take * b.cost
      }
      if(remaining>0){
        // Not enough stock: allow negative by creating negative batch (debt) with cost = avgCost or manualCost
        const it = items.find(x=>x.id===l.itemId)
        const fallbackCost = it.avgCost || it.manualCost || 0
        // create negative batch to reflect shortage
        const neg = {id:uid('batch'),itemId:l.itemId,qty:-remaining,remainingQty:-remaining,cost:fallbackCost,type:'negative',date:new Date().toISOString(),note:`short:${invoiceNo}`}
        batches.push(neg)
        costForLine += remaining * fallbackCost
        remaining = 0
      }
      sale.lines.push({...l, costForThisLine: costForLine})
      sale.costTotal += costForLine
    }else{
      const it = items.find(x=>x.id===l.itemId)
      const avg = it.avgCost || it.manualCost || 0
      costForLine = l.qty * avg
      // decrement from batches if present (to keep records consistent)
      let rem = l.qty
      const itemBatches = batches.filter(b=>b.itemId===l.itemId && b.remainingQty>0).sort((a,b)=> new Date(a.date) - new Date(b.date))
      for(const b of itemBatches){
        if(rem<=0) break
        const take = Math.min(b.remainingQty, rem)
        b.remainingQty -= take
        rem -= take
      }
      if(rem>0){
        // create negative batch
        const neg = {id:uid('batch'),itemId:l.itemId,qty:-rem,remainingQty:-rem,cost:avg,type:'negative',date:new Date().toISOString(),note:`short:${invoiceNo}`}
        batches.push(neg)
      }
      sale.lines.push({...l, costForThisLine: costForLine})
      sale.costTotal += costForLine
    }
    sale.total += l.total
  })

  sales.push(sale)
  nextSaleNo += 1
  persistAll()
  currentSaleLines = []
  renderSaleLines()
  renderSales()
  renderItems()
  fillItemSelects()
  clearSaleFields()
  setInvoiceNumbers()
  if(printAfter) printSale(sale.id)
  alert('حفظت فاتورة المبيعات: ' + invoiceNo)
}

/* Sales list */
function renderSales(){
  const tbody = document.querySelector('#sales_table tbody'); tbody.innerHTML=''
  const from = document.getElementById('sale_filter_from').value
  const to = document.getElementById('sale_filter_to').value
  const q = document.getElementById('sale_search').value.trim().toLowerCase()
  let list = sales.filter(p=>{
    if(q && !(p.invoiceNo.toLowerCase().includes(q) || (p.source||'').toLowerCase().includes(q))) return false
    if(from && p.date < from) return false
    if(to && p.date > to) return false
    return true
  })
  let sum=0
  list.forEach(p=>{
    sum += p.total
    const profit = p.total - p.costTotal
    const tr = document.createElement('tr')
    tr.innerHTML = `<td>${p.invoiceNo}</td><td>${p.date}</td><td>${p.source}</td><td>${formatNumber(p.total)}</td><td>${formatNumber(profit)}</td><td><button onclick="viewSale('${p.id}')" class="btn-secondary">عرض</button></td><td><button onclick="printSale('${p.id}')" class="btn-secondary">طباعة</button></td>`
    tbody.appendChild(tr)
  })
  document.getElementById('sale_count').textContent = list.length
  document.getElementById('sale_sum').textContent = formatNumber(sum)
}
function viewSale(id){
  const p = sales.find(x=>x.id===id)
  if(!p) return alert('غير موجود')
  let txt = `فاتورة مبيعات #${p.invoiceNo}\nالتاريخ: ${p.date}\nالمصدر: ${p.source}\nإجمالي: ${formatNumber(p.total)}\nتكلفة الفاتورة: ${formatNumber(p.costTotal)}\nالربح: ${formatNumber(p.total - p.costTotal)}\nبنود:\n`
  p.lines.forEach(l=> txt += `${items.find(it=>it.id===l.itemId).name} | سعر:${formatNumber(l.price)} | كمية:${l.qty} | إجمالي:${formatNumber(l.total)}\n`)
  alert(txt)
}

/* Sales report */
function renderSalesReport(){
  const from = document.getElementById('rep_sale_from').value
  const to = document.getElementById('rep_sale_to').value
  const sort = document.getElementById('rep_sale_sort').value
  let map = {}
  sales.forEach(s=>{
    if(from && s.date < from) return
    if(to && s.date > to) return
    s.lines.forEach(l=>{
      if(!map[l.itemId]) map[l.itemId] = {qty:0,total:0, price: l.price, item: items.find(it=>it.id===l.itemId)}
      map[l.itemId].qty += l.qty
      map[l.itemId].total += l.total
    })
  })
  let arr = Object.values(map)
  arr.sort((a,b)=>{
    const [k,d] = sort.split('.')
    if(k==='name') return a.item.name.localeCompare(b.item.name)
    if(k==='qty') return d==='desc'? b.qty-a.qty: a.qty-b.qty
    if(k==='price') return d==='desc'? b.price-a.price: a.price-b.price
    if(k==='total') return d==='desc'? b.total-a.total: a.total-b.total
    return 0
  })
  const tbody = document.querySelector('#rep_sale_table tbody'); tbody.innerHTML=''
  let sum=0, costSum=0
  arr.forEach(r=>{
    const tr = document.createElement('tr')
    tr.innerHTML = `<td>${r.item.name}</td><td>${r.item.unit}</td><td>${formatNumber(r.price)}</td><td>${r.qty}</td><td>${formatNumber(r.total)}</td>`
    tbody.appendChild(tr)
    sum += r.total
  })
  sales.forEach(s=>{
    if(from && s.date < from) return
    if(to && s.date > to) return
    costSum += s.costTotal
  })
  document.getElementById('rep_sale_count').textContent = arr.length
  document.getElementById('rep_sale_sum').textContent = formatNumber(sum)
  document.getElementById('rep_sale_cost_sum').textContent = formatNumber(costSum)
  document.getElementById('rep_sale_profit').textContent = formatNumber(sum - costSum)
}

/* Utilities */
function formatNumber(x){ return Number(x || 0).toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2}) }

/* export/import/clear */
function exportData(){
  const data = {settings,items,batches,purchases,sales,nextSaleNo,nextPurNo}
  const blob = new Blob([JSON.stringify(data,null,2)],{type:'application/json'})
  const url = URL.createObjectURL(blob)
  const a = document.createElement('a'); a.href=url; a.download='sunmi_pos_export.json'; a.click(); URL.revokeObjectURL(url)
}
function promptImport(){
  const txt = prompt('الصق JSON هنا لاستيراد (سيستبدل البيانات الحالية).')
  if(!txt) return
  try{
    const obj = JSON.parse(txt)
    if(confirm('هل أنت متأكد؟ سيتم استبدال البيانات الحالية.')) {
      settings = obj.settings || settings
      items = obj.items || []
      batches = obj.batches || []
      purchases = obj.purchases || []
      sales = obj.sales || []
      nextSaleNo = obj.nextSaleNo || nextSaleNo
      nextPurNo = obj.nextPurNo || nextPurNo
      persistAll(); renderAll(); alert('تم الاستيراد')
    }
  }catch(e){
    alert('JSON غير صحيح: ' + e.message)
  }
}
function clearAll(){
  if(confirm('سيتم مسح كل البيانات من localStorage. التأكيد؟')){
    localStorage.clear()
    settings = {mode:'batch'}
    items = []; batches = []; purchases = []; sales = []
    nextSaleNo = 1; nextPurNo = 1
    persistAll(); renderAll(); setInvoiceNumbers()
  }
}

/* Clear fields */
function clearPurchaseFields(){ document.getElementById('pur_source').value=''; document.getElementById('pur_date').value=''; document.getElementById('pur_note').value=''; document.getElementById('pur_item_cost').value=''; document.getElementById('pur_item_qty').value=''; currentPurLines = []; renderPurLines() }
function clearSaleFields(){ document.getElementById('sale_source').value=''; document.getElementById('sale_date').value=''; document.getElementById('sale_note').value=''; document.getElementById('sale_item_price').value=''; document.getElementById('sale_item_qty').value=''; currentSaleLines = []; renderSaleLines() }

/* Modal for items */
let modalMode = null
function openItemModal(mode){
  modalMode = mode // 'pur' or 'sale'
  document.getElementById('item_modal').style.display = 'flex'
  document.getElementById('modal_search').value = ''
  renderModalItems()
}
function closeModal(e){ if(e.target.id==='item_modal') closeItemModal() }
function closeItemModal(){ document.getElementById('item_modal').style.display = 'none' }
function renderModalItems(){
  const tbody = document.querySelector('#modal_items_table tbody'); tbody.innerHTML=''
  const q = document.getElementById('modal_search').value.trim().toLowerCase()
  let list = items.filter(it=> it.name.toLowerCase().includes(q) || it.id.toLowerCase().includes(q))
  list.forEach(it=>{
    const tr = document.createElement('tr')
    const stockQty = itemStockQty(it.id)
    tr.innerHTML = `<td>${it.id}</td><td>${it.name}</td><td>${it.unit}</td><td>${formatNumber(it.manualCost)}</td><td>${formatNumber(it.price)}</td><td>${stockQty}</td><td><button class="btn-primary" onclick="selectItemFromModal('${it.id}')">اختيار</button></td>`
    tbody.appendChild(tr)
  })
}
function selectItemFromModal(itemId){
  const it = items.find(x=>x.id===itemId)
  if(!it) return
  if(modalMode==='pur'){
    document.getElementById('pur_item_select').value = it.id
    document.getElementById('pur_item_unit').value = it.unit
    document.getElementById('pur_item_cost').value = it.manualCost || ''
    document.getElementById('pur_item_qty').value = 1
  }else{
    document.getElementById('sale_item_select').value = it.id
    document.getElementById('sale_item_unit').value = it.unit
    document.getElementById('sale_item_price').value = it.price || ''
    document.getElementById('sale_item_qty').value = 1
  }
  closeItemModal()
}

/* Printing */
function printSale(saleId){
  const sale = sales.find(s=>s.id===saleId); if(!sale) return
  // Print without costs or profit
  const w = window.open('','_blank','width=700,height=900')
  let html = `<html><head><meta charset="utf-8"><title>فاتورة مبيعات ${sale.invoiceNo}</title><style>body{font-family:Arial, Helvetica, sans-serif; direction:rtl}table{width:100%;border-collapse:collapse}th,td{padding:6px;border:1px solid #ccc;text-align:center}</style></head><body>`
  html += `<h2>فاتورة مبيعات #${sale.invoiceNo}</h2><div>التاريخ: ${sale.date} — المصدر: ${sale.source}</div><table><thead><tr><th>الصنف</th><th>الوحدة</th><th>السعر</th><th>الكمية</th><th>الإجمالي</th></tr></thead><tbody>`
  sale.lines.forEach(l=>{
    const it = items.find(x=>x.id===l.itemId)
    html += `<tr><td>${it?it.name:l.itemId}</td><td>${l.unit}</td><td>${formatNumber(l.price)}</td><td>${l.qty}</td><td>${formatNumber(l.total)}</td></tr>`
  })
  html += `</tbody></table><h3>الإجمالي: ${formatNumber(sale.total)}</h3></body></html>`
  w.document.write(html); w.document.close(); w.focus(); setTimeout(()=>{ w.print(); },300)
}

function printPurchase(purId){
  const p = purchases.find(x=>x.id===purId); if(!p) return
  const w = window.open('','_blank','width=700,height=900')
  let html = `<html><head><meta charset="utf-8"><title>فاتورة مشتريات ${p.invoiceNo}</title><style>body{font-family:Arial, Helvetica, sans-serif; direction:rtl}table{width:100%;border-collapse:collapse}th,td{padding:6px;border:1px solid #ccc;text-align:center}</style></head><body>`
  html += `<h2>فاتورة مشتريات #${p.invoiceNo}</h2><div>التاريخ: ${p.date} — المورد: ${p.source}</div><table><thead><tr><th>الصنف</th><th>الوحدة</th><th>التكلفة</th><th>الكمية</th><th>الإجمالي</th></tr></thead><tbody>`
  p.lines.forEach(l=>{
    const it = items.find(x=>x.id===l.itemId)
    html += `<tr><td>${it?it.name:l.itemId}</td><td>${l.unit}</td><td>${formatNumber(l.cost)}</td><td>${l.qty}</td><td>${formatNumber(l.total)}</td></tr>`
  })
  html += `</tbody></table><h3>الإجمالي: ${formatNumber(p.total)}</h3></body></html>`
  w.document.write(html); w.document.close(); w.focus(); setTimeout(()=>{ w.print(); },300)
}

/* helpers */
function scrollTo(id){ document.getElementById(id).scrollIntoView({behavior:'smooth', block:'start'}) }
function scrollToTop(){ window.scrollTo({top:0,behavior:'smooth'}) }

function renderAll(){ fillItemSelects(); renderItems(); renderPurLines(); renderPurchases(); renderPurchaseReport(); renderSaleLines(); renderSales(); renderSalesReport(); setInvoiceNumbers() }
function renderPurLines(){ // used in renderAll, show currentPurLines
  const tbody = document.querySelector('#pur_lines_table tbody'); tbody.innerHTML=''
  currentPurLines.forEach((l,i)=>{
    const tr = document.createElement('tr')
    tr.innerHTML = `<td>${i+1}</td><td>${items.find(it=>it.id===l.itemId).name}</td><td>${l.unit}</td><td>${formatNumber(l.cost)}</td><td>${l.qty}</td><td>${formatNumber(l.total)}</td><td><button onclick="removePurLine('${l.id}')" class="btn-secondary">حذف</button></td>`
    tbody.appendChild(tr)
  })
  document.getElementById('pur_lines_count').textContent = currentPurLines.length
  document.getElementById('pur_total').textContent = formatNumber(currentPurLines.reduce((s,l)=>s+l.total,0))
}
function renderSaleLines(){ // used in renderAll
  const tbody = document.querySelector('#sale_lines_table tbody'); tbody.innerHTML=''
  currentSaleLines.forEach((l,i)=>{
    const tr = document.createElement('tr')
    tr.innerHTML = `<td>${i+1}</td><td>${items.find(it=>it.id===l.itemId).name}</td><td>${l.unit}</td><td>${formatNumber(l.price)}</td><td>${l.qty}</td><td>${formatNumber(l.total)}</td><td><button onclick="removeSaleLine('${l.id}')" class="btn-secondary">حذف</button></td>`
    tbody.appendChild(tr)
  })
  document.getElementById('sale_lines_count').textContent = currentSaleLines.length
  document.getElementById('sale_total').textContent = formatNumber(currentSaleLines.reduce((s,l)=>s+l.total,0))
}

renderAll()
persistAll()

</script>
</body>
</html>
