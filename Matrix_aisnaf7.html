<!doctype html>
<html lang="ar">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Ù†Ø¸Ø§Ù… Ø§Ù„Ø£ØµÙ†Ø§Ù - Ù…Ø­Ù„ÙŠ (Ù…ØµÙÙˆÙØ§Øª Ø¯Ø§Ø®Ù„ Ø§Ù„ÙƒÙˆØ¯)</title>

<!-- QR, Excel, PDF libraries (Ø§Ø­ØªÙØ¸Øª Ø¨Ù‡Ø§ ÙƒÙ…Ø§ ÙÙŠ Ù…Ù„ÙÙƒ) -->
<script src="https://unpkg.com/html5-qrcode"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>

<style>
@import url('https://fonts.googleapis.com/css2?family=Tajawal&display=swap');
body{font-family:"Tajawal",sans-serif;direction:rtl;background:#f0f8ff;margin:0;padding:0;}
h2,h3{text-align:center;color:#0d6efd;margin:15px 0;}
.container{width:95%;max-width:1200px;margin:auto;padding:15px;}
input, button{padding:10px;border-radius:8px;border:1px solid #ccc;font-size:16px;}
button{cursor:pointer;background:#0d6efd;color:#fff;border:none;}
button:hover{background:#084298;}

table{width:100%;border-collapse:collapse;margin-top:15px;font-size:14px;}
th,td{border:1px solid #ccc;padding:8px;text-align:center;white-space:normal;overflow-wrap:break-word;}
th{background:#0d6efd;color:#fff;cursor:pointer;}

tr:nth-child(even){background:#e7f1ff;}
.table-container{overflow-x:auto;width:100%;}
#reader,#readerCart{width:100%;margin:10px auto;display:none;}
.autocomplete{border:1px solid #ccc;border-radius:8px;max-height:150px;overflow-y:auto;background:#fff;position:absolute;z-index:1000;width:95%;}
.autocomplete div{padding:8px;cursor:pointer;}
.autocomplete div:hover{background:#d0e4ff;}
#cartMessage{color:#155724;background:#d4edda;padding:10px;margin-top:10px;border-radius:8px;display:none;text-align:center;}

header {
Â  background: #007bff;
Â  color: white;
Â  padding: 15px;
Â  text-align: center;
}
nav {
Â  background: #e9ecef;
Â  display: flex;
Â  justify-content: space-around;
Â  padding: 10px;
}
nav button {
Â  padding: 10px 20px;
Â  border: none;
Â  background: #007bff;
Â  color: white;
Â  border-radius: 5px;
Â  cursor: pointer;
Â  transition: background 0.3s;
}
nav button:hover {
Â  background: #0056b3;
}
.content {
Â  padding: 20px;
}
.form-section {
Â  display: none;
Â  background: white;
Â  padding: 20px;
Â  border-radius: 10px;
Â  box-shadow: 0 0 5px #ccc;
Â  margin-top: 20px;
}
label {
Â  display: block;
Â  margin-top: 10px;
}
input, select {
Â  width: 100%;
Â  padding: 8px;
Â  margin-top: 5px;
Â  border: 1px solid #ccc;
Â  border-radius: 5px;
}
#syncStatus {
Â  font-weight: bold;
Â  text-align: center;
Â  margin: 8px 0;
}
button.small { padding: 8px 10px; font-size: 14px; }
</style>
</head>
<body>

<header role="banner">
Â  <h1 style="margin:0; font-size:20px;">Ù†Ø¸Ø§Ù… Ø§Ù„Ø£ØµÙ†Ø§Ù - ØªØ®Ø²ÙŠÙ† Ù…Ø­Ù„ÙŠ ÙÙŠ Ù…ØµÙÙˆÙØ§Øª</h1>
</header>

<nav role="navigation" aria-label="Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªÙ†Ù‚Ù„">
Â  <button type="button" onclick="showSection('arafat')">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£ØµÙ†Ø§Ù</button>
</nav>

<main class="container" role="main">
Â  <section id="arafat" class="form-section" aria-hidden="true">
Â Â Â  <h3>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£ØµÙ†Ø§Ù (Ù…Ø­Ù„ÙŠ - Ù…ØµÙÙˆÙØ§Øª Ø¯Ø§Ø®Ù„ Ø§Ù„ÙƒÙˆØ¯)</h3>

Â Â Â  <div id="reader" aria-hidden="true"></div>

Â Â Â  <form id="itemForm" aria-label="Ù†Ù…ÙˆØ°Ø¬ Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù">
Â Â Â Â Â  <div style="margin-top:5px; display:flex; gap:10px; flex-wrap:wrap;">
Â Â Â Â Â Â Â  <div style="flex:1 1 240px; min-width:200px;">
Â Â Â Â Â Â Â Â Â  <label for="itemName">Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù:</label>
Â Â Â Â Â Â Â Â Â  <input type="text" id="itemName" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù" required aria-required="true">
Â Â Â Â Â Â Â  </div>

Â Â Â Â Â Â Â  <div style="flex:1 1 240px; min-width:200px;">
Â Â Â Â Â Â Â Â Â  <label for="itemCode">Ø±Ù…Ø² Ø§Ù„ØµÙ†Ù:</label>
Â Â Â Â Â Â Â Â Â  <div style="display:flex; gap:8px;">
Â Â Â Â Â Â Â Â Â Â Â  <input type="text" id="itemCode" placeholder="Ø§Ù…Ø³Ø­ Ø£Ùˆ Ø§ÙƒØªØ¨ Ø§Ù„Ø±Ù…Ø²" required style="flex:1;">
Â Â Â Â Â Â Â Â Â Â Â  <button type="button" id="scanItemBtn" class="small" aria-pressed="false">ğŸ“· Ù…Ø³Ø­</button>
Â Â Â Â Â Â Â Â Â  </div>
Â Â Â Â Â Â Â  </div>

Â Â Â Â Â Â Â  <div style="flex:1 1 240px; min-width:200px;">
Â Â Â Â Â Â Â Â Â  <label for="itemUnit">Ø§Ù„ÙˆØ­Ø¯Ø©:</label>
Â Â Â Â Â Â Â Â Â  <input type="text" id="itemUnit" placeholder="Ø§Ù„ÙˆØ­Ø¯Ø© Ù…Ø«Ù„: Ø­Ø¨Ø©ØŒ ÙƒÙŠÙ„ÙˆØŒ Ù„ØªØ±" required>
Â Â Â Â Â Â Â  </div>

Â Â Â Â Â Â Â  <div style="display:flex; gap:10px; width:100%;">
Â Â Â Â Â Â Â Â Â  <div style="flex:1;">
Â Â Â Â Â Â Â Â Â Â Â  <label for="itemCost">Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡:</label>
Â Â Â Â Â Â Â Â Â Â Â  <input type="text" inputmode="decimal" id="itemCost" placeholder="Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡">
Â Â Â Â Â Â Â Â Â  </div>

Â Â Â Â Â Â Â Â Â  <div style="flex:1;">
Â Â Â Â Â Â Â Â Â Â Â  <label for="itemPrice">Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹:</label>
Â Â Â Â Â Â Â Â Â Â Â  <input type="text" inputmode="decimal" id="itemPrice" placeholder="Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹">
Â Â Â Â Â Â Â Â Â  </div>
Â Â Â Â Â Â Â  </div>

Â Â Â Â Â Â Â  <div style="display:flex; gap:10px; justify-content:center; margin-top:10px; width:100%;">
Â Â Â Â Â Â Â Â Â  <button type="submit" id="saveBtn">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØµÙ†Ù</button>
Â Â Â Â Â Â Â Â Â  <button type="button" id="cancelItemBtn" style="background:#dc3545;">âŒ Ø¥Ù„ØºØ§Ø¡</button>
Â Â Â Â Â Â Â  </div>

Â Â Â Â Â  </div>
Â Â Â  </form>

Â Â Â  <div id="itemMessage" role="status" aria-live="polite" style="
Â Â Â Â Â  display:none;
Â Â Â Â Â  color:#856404;
Â Â Â Â Â  background:#fff3cd;
Â Â Â Â Â  padding:15px 20px;
Â Â Â Â Â  margin:20px auto;
Â Â Â Â Â  border-radius:10px;
Â Â Â Â Â  text-align:center;
Â Â Â Â Â  font-size:18px;
Â Â Â Â Â  font-weight:bold;
Â Â Â Â Â  width:fit-content;
Â Â Â Â Â  box-shadow: 0 0 10px rgba(0,0,3,0.2);
Â Â Â  "></div>

Â Â Â  <div id="syncStatus">Ù…Ø®Ø²Ù† Ù…Ø­Ù„ÙŠ ÙÙ‚Ø· (Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø²Ø§Ù…Ù†Ø© Ø³Ø­Ø§Ø¨ÙŠØ©)</div>

Â Â Â  <div style="margin-top:5px; display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
Â Â Â Â Â  <select id="sortSelect" aria-label="ÙØ±Ø² Ø§Ù„Ø£ØµÙ†Ø§Ù">
Â Â Â Â Â Â Â  <option value="">-- ÙØ±Ø² Ø­Ø³Ø¨ --</option>
Â Â Â Â Â Â Â  <option value="name-asc">Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù ØªØµØ§Ø¹Ø¯ÙŠ</option>
Â Â Â Â Â Â Â  <option value="name-desc">Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù ØªÙ†Ø§Ø²Ù„ÙŠ</option>
Â Â Â Â Â Â Â  <option value="code-asc">Ø±Ù…Ø² Ø§Ù„ØµÙ†Ù ØªØµØ§Ø¹Ø¯ÙŠ</option>
Â Â Â Â Â Â Â  <option value="code-desc">Ø±Ù…Ø² Ø§Ù„ØµÙ†Ù ØªÙ†Ø§Ø²Ù„ÙŠ</option>
Â Â Â Â Â Â Â  <option value="cost-asc">Ø£Ù‚Ù„ Ø³Ø¹Ø± Ø´Ø±Ø§Ø¡</option>
Â Â Â Â Â Â Â  <option value="cost-desc">Ø£Ø¹Ù„Ù‰ Ø³Ø¹Ø± Ø´Ø±Ø§Ø¡</option>
Â Â Â Â Â Â Â  <option value="price-asc">Ø£Ù‚Ù„ Ø³Ø¹Ø± Ø¨ÙŠØ¹</option>
Â Â Â Â Â Â Â  <option value="price-desc">Ø£Ø¹Ù„Ù‰ Ø³Ø¹Ø± Ø¨ÙŠØ¹</option>
Â Â Â Â Â  </select>
Â Â Â Â Â  <button id="exportExcelBtn" class="small">ğŸ“¤ Excel</button>
Â Â Â Â Â  <input type="file" id="importExcel" accept=".xlsx,.xls" aria-label="Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ù„Ù Excel">
Â Â Â Â Â  <input type="text" id="searchInput" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¹Ù† Ø£ÙŠ ØµÙ†Ù" style="flex:1;">
Â Â Â  </div>

Â Â Â  <div id="itemsCount" style="text-align:center; font-weight:bold; margin-bottom:10px;">
Â Â Â Â Â  Ø¹Ø¯Ø¯ Ø§Ù„Ø£ØµÙ†Ø§Ù: 0
Â Â Â  </div>

Â Â Â  <div class="table-container" role="region" aria-label="Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£ØµÙ†Ø§Ù">
Â Â Â Â Â  <table id="itemsTable" role="table">
Â Â Â Â Â Â Â  <thead>
Â Â Â Â Â Â Â Â Â  <tr>
Â Â Â Â Â Â Â Â Â Â Â  <th scope="col">Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù</th>
Â Â Â Â Â Â Â Â Â Â Â  <th scope="col">Ø±Ù…Ø² Ø§Ù„ØµÙ†Ù</th>
Â Â Â Â Â Â Â Â Â Â Â  <th scope="col">Ø§Ù„ÙˆØ­Ø¯Ø©</th>
Â Â Â Â Â Â Â Â Â Â Â  <th scope="col">Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡</th>
Â Â Â Â Â Â Â Â Â Â Â  <th scope="col">Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹</th>
Â Â Â Â Â Â Â Â Â Â Â  <th scope="col">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
Â Â Â Â Â Â Â Â Â  </tr>
Â Â Â Â Â Â Â  </thead>
Â Â Â Â Â Â Â  <tbody></tbody>
Â Â Â Â Â  </table>
Â Â Â  </div>
Â Â Â  <hr>
Â  </section>
</main>

<div id="saveMessage" role="status" aria-live="polite" style="
Â  display:none;
Â  position:fixed;
Â  top:50%;
Â  left:50%;
Â  transform:translate(-50%, -50%);
Â  background:#d4edda;
Â  color:#155724;
Â  border:2px solid #28a745;
Â  padding:20px 40px;
Â  font-size:24px;
Â  font-weight:bold;
Â  border-radius:10px;
Â  box-shadow:0 0 15px rgba(0,0,0,0.2);
Â  z-index:9999;
Â  text-align:center;
">
Â  ØªÙ… Ø§Ù„Ø­ÙØ¸ âœ…
</div>

<script>
/*
Â  Ù‡Ø°Ø§ Ø§Ù„Ù…Ù„Ù ÙŠØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ Ù…Ø­Ù„ÙŠ: Ø§Ù„Ø£ØµÙ†Ø§Ù Ù…Ø­ÙÙˆØ¸Ø© ÙÙŠ Ù…ØµÙÙˆÙØ© Ø¯Ø§Ø®Ù„ Ø§Ù„ÙƒÙˆØ¯ (itemsCache)
Â  ÙˆØªÙØ®Ø²Ù† Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© ÙÙŠ localStorage ÙƒÙŠ ØªØ¨Ù‚Ù‰ Ø¹Ø¨Ø± Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„.
Â  Ø¨Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ Ø°Ù„Ùƒ ØªÙØ¨Ù†Ù‰ Ù…ØµÙÙˆÙØ§Øª Ù…Ù†ÙØµÙ„Ø© Ù„ÙƒÙ„ Ø­Ù‚Ù„ (namesArr, codesArr, unitsArr, costsArr, pricesArr)
Â  Ù„ØªÙ„Ø¨ÙŠØ© Ù…Ø·Ù„Ø¨ "ØªÙƒÙˆÙ† Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø¯Ø§Ø®Ù„ Ø§Ù„ÙƒÙˆØ¯ ÙƒÙ…ØµÙÙˆÙØ§Øª".
*/

/* ====== Ø¹Ù†Ø§ØµØ± DOM ====== */
const itemsTableBody = document.querySelector("#itemsTable tbody");
const itemForm = document.getElementById("itemForm");
const itemName = document.getElementById("itemName");
const itemCode = document.getElementById("itemCode");
const itemUnit = document.getElementById("itemUnit");
const itemCost = document.getElementById("itemCost");
const itemPrice = document.getElementById("itemPrice");
const itemMessage = document.getElementById("itemMessage");
const syncStatus = document.getElementById("syncStatus");
const importExcelInput = document.getElementById("importExcel");
const scanItemBtn = document.getElementById("scanItemBtn");

/* ====== Ø§Ù„Ù…ØµÙÙˆÙØ§Øª Ø¯Ø§Ø®Ù„ "Ø§Ù„ÙƒÙˆØ¯" (Ø°Ø§ÙƒØ±Ø© + Ù†Ø³ØªØ®Ø¯Ù… localStorage Ù„Ù„Ø­ÙØ¸ Ø¹Ø¨Ø± ØµÙØ­Ø©) ====== */
let itemsCache = []; // Ù…ØµÙÙˆÙØ© ÙƒØ§Ø¦Ù†Ø§Øª: [{name, code, unit, cost, price}]
let namesArr = [];
let codesArr = [];
let unitsArr = [];
let costsArr = [];
let pricesArr = [];

/* Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: null => Ø¥Ø¶Ø§ÙØ© Ø¬Ø¯ÙŠØ¯ØŒ Ø±Ù‚Ù… => ØªØ¹Ø¯ÙŠÙ„ Ø¹Ù†ØµØ± Ø¨Ø­Ø³Ø¨ Ø§Ù„ÙÙ‡Ø±Ø³ */
let editingIndex = null;

/* ====== ÙˆØ¸Ø§Ø¦Ù Ù…Ø³Ø§Ø¹Ø¯Ø© ====== */
function stripCommas(val) {
Â  if (val === undefined || val === null) return "";
Â  return String(val).replace(/,/g, "").trim();
}
function formatWithCommas(val) {
Â  if (val === undefined || val === null || val === "") return "";
Â  const s = String(val).replace(/,/g, "");
Â  const n = Number(s);
Â  if (isNaN(n)) return String(val);
Â  return n.toLocaleString();
}
function escapeHtml(text) {
Â  if (!text && text !== 0) return "";
Â  return String(text).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;');
}

/* ====== Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø¨ÙŠÙ† itemsCache ÙˆØ§Ù„Ù…ØµÙÙˆÙØ§Øª Ø§Ù„Ù…Ù†ÙØµÙ„Ø© (ÙŠÙˆÙØ± "Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙƒÙ…ØªØºÙŠØ±Ø§Øª ÙÙŠ Ø§Ù„ÙƒÙˆØ¯") ====== */
function syncParallelArrays() {
Â  namesArr = itemsCache.map(i => i.name || "");
Â  codesArr = itemsCache.map(i => i.code || "");
Â  unitsArr = itemsCache.map(i => i.unit || "");
Â  costsArr = itemsCache.map(i => i.cost || "");
Â  pricesArr = itemsCache.map(i => i.price || "");
Â  // Ù†ÙØ¨Ù‚ÙŠ Ù†Ø³Ø®Ø© ÙÙŠ localStorage Ø£ÙŠØ¶Ø§Ù‹
Â  try {
Â Â Â  localStorage.setItem('itemsList', JSON.stringify(itemsCache));
Â Â Â  localStorage.setItem('itemsParallel', JSON.stringify({
Â Â Â Â Â  namesArr, codesArr, unitsArr, costsArr, pricesArr
Â Â Â  }));
Â  } catch (e) {
Â Â Â  console.warn('localStorage save failed', e);
Â  }
}

/* ====== ØªØ­Ù…ÙŠÙ„ Ù…Ù† Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ Ø£Ùˆ Ø¥Ù†Ø´Ø§Ø¡ Ù…ØµÙÙˆÙØ© ÙØ§Ø±ØºØ© (Ø£Ùˆ Ø¹ÙŠÙ†Ø§Øª Ø¥Ù† Ø£Ø±Ø¯Øª) ====== */
function loadItemsFromLocalStorage() {
Â  try {
Â Â Â  const raw = localStorage.getItem('itemsList');
Â Â Â  if (raw) {
Â Â Â Â Â  itemsCache = JSON.parse(raw);
Â Â Â  } else {
Â Â Â Â Â  // Ø¥Ù† Ø£Ø±Ø¯Øª Ø£Ù…Ø«Ù„Ø© Ù…Ø¨Ø¯Ø¦ÙŠØ© ÙŠÙ…ÙƒÙ†Ùƒ ØªØ¹Ø¯ÙŠÙ„ Ù‡Ø°Ø§ Ø§Ù„Ø¬Ø²Ø¡ Ù„ÙŠØ­ÙˆÙŠ Ø¹Ù†Ø§ØµØ± Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
Â Â Â Â Â  itemsCache = [];
Â Â Â  }
Â  } catch (e) {
Â Â Â  console.warn('local load failed', e);
Â Â Â  itemsCache = [];
Â  }
Â  syncParallelArrays();
Â  renderItemsFromCache();
}

/* ====== Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„ ====== */
function renderItemsFromCache() {
Â  const sortValue = document.getElementById("sortSelect").value;
Â  let items = [...itemsCache];
Â  if (sortValue) {
Â Â Â  const [field, order] = sortValue.split("-");
Â Â Â  items.sort((a,b) => {
Â Â Â Â Â  if (field === "name" || field === "code") {
Â Â Â Â Â Â Â  return order === "asc" ? (a[field]||"").localeCompare(b[field]||"") : (b[field]||"").localeCompare(a[field]||"");
Â Â Â Â Â  }
Â Â Â Â Â  const an = Number(stripCommas(a[field] || 0));
Â Â Â Â Â  const bn = Number(stripCommas(b[field] || 0));
Â Â Â Â Â  return order === "asc" ? an - bn : bn - an;
Â Â Â  });
Â  }

Â  itemsTableBody.innerHTML = "";
Â  items.forEach((it, i) => {
Â Â Â  const costDisplay = formatWithCommas(it.cost);
Â Â Â  const priceDisplay = formatWithCommas(it.price);
Â Â Â  const tr = document.createElement('tr');
Â Â Â  tr.innerHTML = `<td>${escapeHtml(it.name)}</td><td>${escapeHtml(it.code)}</td><td>${escapeHtml(it.unit)}</td><td>${costDisplay||''}</td><td>${priceDisplay||''}</td>
Â Â Â Â Â  <td><div style="display:flex; gap:4px; justify-content:center;">
Â Â Â Â Â  <button type="button" onclick="editItem(${i})">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
Â Â Â Â Â  <button type="button" onclick="deleteItem(${i})" style="background:#dc3545;">ğŸ—‘ï¸ Ø­Ø°Ù</button>
Â Â Â Â Â  </div></td>`;
Â Â Â  itemsTableBody.appendChild(tr);
Â  });
Â  updateItemsCount();
}

/* ====== ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯ ====== */
function updateItemsCount() {
Â  const n = itemsCache.length;
Â  document.getElementById("itemsCount").textContent = `Ø¹Ø¯Ø¯ Ø§Ù„Ø£ØµÙ†Ø§Ù: ${n}`;
}

/* ====== Ø¥Ø¶Ø§ÙØ© / ØªØ¹Ø¯ÙŠÙ„ (ÙŠØ¹Ù…Ù„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ØµÙÙˆÙØ§Øª Ø¯Ø§Ø®Ù„ Ø§Ù„ÙƒÙˆØ¯) ====== */
itemForm.addEventListener("submit", (e) => {
Â  e.preventDefault();

Â  if (!itemName.value.trim() || !itemCode.value.trim() || !itemUnit.value.trim()) {
Â Â Â  alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©: Ø§Ø³Ù… Ø§Ù„ØµÙ†ÙØŒ Ø±Ù…Ø² Ø§Ù„ØµÙ†ÙØŒ Ø§Ù„ÙˆØ­Ø¯Ø©');
Â Â Â  return;
Â  }

Â  const name = itemName.value.trim();
Â  const code = itemCode.value.trim();
Â  const unit = itemUnit.value.trim();
Â  const cost = stripCommas(itemCost.value);
Â  const price = stripCommas(itemPrice.value);

Â  const newItem = { name, code, unit, cost, price };

Â  // Ø¥Ø°Ø§ ÙÙŠ ÙˆØ¶Ø¹ ØªØ¹Ø¯ÙŠÙ„
Â  if (editingIndex !== null && editingIndex >= 0 && editingIndex < itemsCache.length) {
Â Â Â  // ØªØ­Ù‚Ù‚ Ø¥Ù† ÙƒØ§Ù† Ø§Ù„Ø±Ù…Ø² ÙŠØªØ¹Ø§Ø±Ø¶ Ù…Ø¹ ØµÙ†Ù Ø¢Ø®Ø±
Â Â Â  const conflictIndex = itemsCache.findIndex((it, idx) => it.code === code && idx !== editingIndex);
Â Â Â  if (conflictIndex !== -1) {
Â Â Â Â Â  if (!confirm('Ø±Ù…Ø² Ø§Ù„ØµÙ†Ù Ù‡Ø°Ø§ Ù…Ø³ØªØ®Ø¯Ù… Ø¨ÙˆØ§Ø³Ø·Ø© Ø¹Ù†ØµØ± Ø¢Ø®Ø±. Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ø³ØªØ¨Ø¯Ø§Ù„Ù‡ØŸ')) {
Â Â Â Â Â Â Â  return;
Â Â Â Â Â  }
Â Â Â Â Â  // Ø³Ù†Ø­Ø°Ù Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„Ù…ØªØ¹Ø§Ø±Ø¶ Ø«Ù… Ù†Ø­Ø¯Ø« Ø§Ù„Ø­Ø§Ù„ÙŠ
Â Â Â Â Â  itemsCache.splice(conflictIndex, 1);
Â Â Â Â Â  // Ø¥Ø°Ø§ ÙƒØ§Ù† conflictIndex < editingIndex ÙØ¥Ù† Ø§Ù„ÙÙ‡Ø±Ø³ ÙŠØªØºÙŠØ±
Â Â Â Â Â  if (conflictIndex < editingIndex) editingIndex--;
Â Â Â  }
Â Â Â  itemsCache[editingIndex] = newItem;
Â Â Â  editingIndex = null;
Â  } else {
Â Â Â  // ÙˆØ¶Ø¹ Ø¥Ø¶Ø§ÙØ© Ø¬Ø¯ÙŠØ¯: ØªØ­Ù‚Ù‚ Ø¥Ù† ÙƒØ§Ù† Ø§Ù„Ø±Ù…Ø² Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹
Â Â Â  const existing = itemsCache.findIndex(it => it.code === code);
Â Â Â  if (existing !== -1) {
Â Â Â Â Â  if (!confirm('Ø±Ù…Ø² Ø§Ù„ØµÙ†Ù Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ù‹Ø§. Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙ†Ù Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ØŸ')) return;
Â Â Â Â Â  itemsCache[existing] = newItem;
Â Â Â  } else {
Â Â Â Â Â  itemsCache.push(newItem);
Â Â Â  }
Â  }

Â  syncParallelArrays();
Â  renderItemsFromCache();
Â  itemForm.reset();
Â  document.getElementById("saveMessage").style.display = 'block';
Â  setTimeout(()=> document.getElementById("saveMessage").style.display = 'none', 1200);
});

/* ====== ØªØ¹Ø¯ÙŠÙ„ / Ø­Ø°Ù Ø¹Ù†Ø§ØµØ± Ù…Ù† Ø§Ù„Ù…ØµÙÙˆÙØ© Ø§Ù„Ù…Ø­Ù„ÙŠØ© ====== */
window.editItem = function(i) {
Â  const it = itemsCache[i];
Â  if (!it) return;
Â  itemName.value = it.name || "";
Â  itemCode.value = it.code || "";
Â  itemUnit.value = it.unit || "";
Â  itemCost.value = formatWithCommas(it.cost || "");
Â  itemPrice.value = formatWithCommas(it.price || "");
Â  editingIndex = i;
Â  // Scroll to form for UX
Â  window.scrollTo({ top: 0, behavior: 'smooth' });
};

window.deleteItem = function(i) {
Â  const it = itemsCache[i];
Â  if (!it) return;
Â  if (!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„ØµÙ†Ù Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ')) return;
Â  itemsCache.splice(i, 1);
Â  syncParallelArrays();
Â  renderItemsFromCache();
};

/* ====== QR Scanner (ÙŠØ¹Ø¨ÙŠ Ø§Ù„Ø­Ù‚Ù„ ÙÙ‚Ø·) ====== */
let isScanning = false;
const qrReaderEl = document.getElementById("reader");
let qrScanner = null;
async function ensureQrScanner() {
Â  if (!qrScanner) qrScanner = new Html5Qrcode("reader");
Â  return qrScanner;
}
scanItemBtn.onclick = async () => {
Â  try {
Â Â Â  if (!isScanning) {
Â Â Â Â Â  const scanner = await ensureQrScanner();
Â Â Â Â Â  let cams = [];
Â Â Â Â Â  try { cams = await Html5Qrcode.getCameras(); } catch (err) { cams = []; }
Â Â Â Â Â  if (!cams.length) return alert("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ÙƒØ§Ù…ÙŠØ±Ø§");
Â Â Â Â Â  let cam = cams.find(c => c.label && c.label.toLowerCase().includes("back"))?.id || cams[0].id;
Â Â Â Â Â  qrReaderEl.style.display = "block";
Â Â Â Â Â  scanItemBtn.textContent = "â¹ï¸ Ø¥ÙŠÙ‚Ø§Ù";
Â Â Â Â Â  scanItemBtn.setAttribute("aria-pressed", "true");
Â Â Â Â Â  isScanning = true;

Â Â Â Â Â  await scanner.start(cam, { fps: 15, qrbox: { width: 280, height: 160 } },
Â Â Â Â Â Â Â  async (decoded) => {
Â Â Â Â Â Â Â Â Â  // Ø¶Ø¹ Ø§Ù„Ù‚ÙŠÙ…Ø© ÙÙŠ Ø­Ù‚Ù„ Ø§Ù„Ø±Ù…Ø² ÙˆØªÙˆÙ‚Ù
Â Â Â Â Â Â Â Â Â  itemCode.value = String(decoded);
Â Â Â Â Â Â Â Â Â  stopScanner().catch(()=>{});
Â Â Â Â Â Â Â  },
Â Â Â Â Â Â Â  (err) => { /* ØªØ¬Ø§Ù‡Ù„ Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© */ }
Â Â Â Â Â  );
Â Â Â  } else {
Â Â Â Â Â  await stopScanner();
Â Â Â  }
Â  } catch (err) {
Â Â Â  console.error(err);
Â Â Â  alert('Ø®Ø·Ø£ ÙÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ø§Ø³Ø­: ' + (err && err.message || err));
Â Â Â  try { await stopScanner(); } catch(e){}
Â  }
};
async function stopScanner() {
Â  if (!qrScanner) return;
Â  try { await qrScanner.stop(); } catch(e){}
Â  qrReaderEl.style.display = "none";
Â  scanItemBtn.textContent = "ğŸ“· Ù…Ø³Ø­";
Â  scanItemBtn.setAttribute("aria-pressed", "false");
Â  isScanning = false;
}

/* ====== Ø§Ø³ØªÙŠØ±Ø§Ø¯ Excel ====== */
function getCellValue(obj, keys) {
Â  for (let k of keys) {
Â Â Â  if (obj[k] !== undefined && obj[k] !== null) return String(obj[k]).trim();
Â  }
Â  return "";
}
importExcelInput.addEventListener("change", function(e) {
Â  const file = e.target.files[0];
Â  if (!file) return;
Â  const reader = new FileReader();
Â  reader.onload = async function(evt) {
Â Â Â  let workbook;
Â Â Â  try { workbook = XLSX.read(evt.target.result, { type: "binary" }); }
Â Â Â  catch { workbook = XLSX.read(new Uint8Array(evt.target.result), { type: "array" }); }
Â Â Â  const sheet = workbook.Sheets[workbook.SheetNames[0]];
Â Â Â  if (!sheet) return alert("âŒ Ø§Ù„Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­");
Â Â Â  let rows = XLSX.utils.sheet_to_json(sheet, { defval: "" });
Â Â Â  if (!rows.length) return alert("âŒ Ù…Ù„Ù Excel ÙØ§Ø±Øº");

Â Â Â  const mapped = rows.map(row => {
Â Â Â Â Â  if (Array.isArray(row)) {
Â Â Â Â Â Â Â  return {
Â Â Â Â Â Â Â Â Â  name: String(row[0] || "").trim(),
Â Â Â Â Â Â Â Â Â  code: String(row[1] || "").trim(),
Â Â Â Â Â Â Â Â Â  unit: String(row[2] || "").trim(),
Â Â Â Â Â Â Â Â Â  cost: String(row[3] || "").trim(),
Â Â Â Â Â Â Â Â Â  price: String(row[4] || "").trim(),
Â Â Â Â Â Â Â  };
Â Â Â Â Â  } else {
Â Â Â Â Â Â Â  return {
Â Â Â Â Â Â Â Â Â  name: getCellValue(row, ["name","Ø§Ø³Ù…","Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù"]),
Â Â Â Â Â Â Â Â Â  code: getCellValue(row, ["code","Ø±Ù…Ø²","Ø±Ù…Ø² Ø§Ù„ØµÙ†Ù"]),
Â Â Â Â Â Â Â Â Â  unit: getCellValue(row, ["unit","Ø§Ù„ÙˆØ­Ø¯Ø©"]),
Â Â Â Â Â Â Â Â Â  cost: getCellValue(row, ["cost","Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡"]),
Â Â Â Â Â Â Â Â Â  price: getCellValue(row, ["price","Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹"]),
Â Â Â Â Â Â Â  };
Â Â Â Â Â  }
Â Â Â  }).filter(r => r.code);

Â Â Â  // Ø¯Ù…Ø¬ Ù…Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©: Ø¥Ø°Ø§ Ø§Ù„Ø±Ù…Ø² Ù…ÙˆØ¬ÙˆØ¯ Ø­Ø¯Ø«ØŒ ÙˆØ¥Ù„Ø§ Ø£Ø¶Ù
Â Â Â  mapped.forEach(im => {
Â Â Â Â Â  const idx = itemsCache.findIndex(it => it.code === im.code);
Â Â Â Â Â  const newItem = { name: im.name, code: im.code, unit: im.unit, cost: im.cost, price: im.price };
Â Â Â Â Â  if (idx !== -1) itemsCache[idx] = newItem;
Â Â Â Â Â  else itemsCache.push(newItem);
Â Â Â  });

Â Â Â  syncParallelArrays();
Â Â Â  renderItemsFromCache();
Â Â Â  showImportMessage('âœ”ï¸ ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù…Ù„Ù ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£ØµÙ†Ø§Ù Ù…Ø­Ù„ÙŠØ§Ù‹');
Â Â Â  importExcelInput.value = '';
Â  };
Â  reader.readAsBinaryString(file);
});

function showImportMessage(text) {
Â  const msg = document.createElement("div");
Â  msg.textContent = text;
Â  msg.style = `
Â Â Â  position: fixed;
Â Â Â  bottom: 20px;
Â Â Â  left: 50%;
Â Â Â  transform: translateX(-50%);
Â Â Â  background: #28a745;
Â Â Â  color: white;
Â Â Â  padding: 12px 20px;
Â Â Â  border-radius: 8px;
Â Â Â  font-size: 16px;
Â Â Â  z-index: 9999;
Â  `;
Â  document.body.appendChild(msg);
Â  setTimeout(() => msg.remove(), 3000);
}

/* ====== ØªØµØ¯ÙŠØ± Excel ====== */
document.getElementById("exportExcelBtn").addEventListener("click", function () {
Â  if (!itemsCache.length) return alert('âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±');
Â  const worksheet = XLSX.utils.json_to_sheet(itemsCache.map(i => ({ name: i.name, code: i.code, unit: i.unit, cost: i.cost, price: i.price })));
Â  const workbook = XLSX.utils.book_new();
Â  XLSX.utils.book_append_sheet(workbook, worksheet, "Items");
Â  XLSX.writeFile(workbook, "items.xlsx");
Â  showExportMessage("âœ”ï¸ ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø¥Ù„Ù‰ Excel");
});
function showExportMessage(text) {
Â  const msg = document.createElement("div");
Â  msg.textContent = text;
Â  msg.style = `
Â Â Â  position: fixed;
Â Â Â  bottom: 20px;
Â Â Â  left: 50%;
Â Â Â  transform: translateX(-50%);
Â Â Â  background: #007bff;
Â Â Â  color: white;
Â Â Â  padding: 12px 20px;
Â Â Â  border-radius: 8px;
Â Â Â  font-size: 16px;
Â Â Â  z-index: 9999;
Â  `;
Â  document.body.appendChild(msg);
Â  setTimeout(() => msg.remove(), 3000);
}

/* ====== ÙˆØ¸Ø§Ø¦Ù ÙˆØ§Ø¬Ù‡Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© ====== */
function clearItemFields() {
Â  itemForm.reset();
Â  editingIndex = null;
Â  itemMessage.style.display = 'none';
Â  [itemName, itemCode, itemUnit, itemCost, itemPrice].forEach(inp => inp.style.background = '');
}
document.getElementById("cancelItemBtn").addEventListener("click", clearItemFields);

/* ØªÙ„ÙˆÙŠÙ† Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø¹Ù†Ø¯ Ø§Ù„ÙƒØªØ§Ø¨Ø© */
const fields = ["itemName","itemCode","itemUnit","itemCost","itemPrice"];
fields.forEach(id => {
Â  const input = document.getElementById(id);
Â  input.addEventListener("input", () => {
Â Â Â  if (input.value.trim() !== "") { input.style.background = "#d4edda"; input.style.border = "2px solid #28a745"; }
Â Â Â  else { input.style.background = ""; input.style.border = ""; }
Â  });
});

/* Ø±Ø¨Ø· Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„ÙØ±Ø² */
document.getElementById("searchInput").addEventListener("input", ()=>{
Â  const val = document.getElementById("searchInput").value.trim().toLowerCase();
Â  document.querySelectorAll("#itemsTable tbody tr").forEach(r=>{
Â Â Â  r.style.display = r.innerText.toLowerCase().includes(val) ? "" : "none";
Â  });
});
document.getElementById("sortSelect").addEventListener("change", renderItemsFromCache);

/* Ø¥Ø¨Ù‚Ø§Ø¡ Ø§Ù„Ù‚Ø³Ù… Ø¸Ø§Ù‡Ø±Ù‹Ø§ */
function showSection(id) {
Â  document.querySelectorAll('.form-section').forEach(s => s.style.display='none');
Â  const el = document.getElementById(id);
Â  if (el) el.style.display='block';
}
showSection('arafat');

/* Ø­Ù…Ø§ÙŠØ© Ù…Ù† Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù…Ø³Ø­ */
window.addEventListener('beforeunload', (e) => {
Â  if (isScanning) {
Â Â Â  e.preventDefault(); e.returnValue = '';
Â  }
});

/* ====== Ø¨ÙØ¯Ù’Ø¡: Ø­Ù…Ù‘Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ ÙˆØ¹Ø±ÙØ¶Ù‡Ø§ ====== */
loadItemsFromLocalStorage();
</script>
</body>
</html>

