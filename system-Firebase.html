<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Ù†Ø¸Ø§Ù… Ø§Ù„Ø£ØµÙ†Ø§Ù - Ø¹Ø±ÙØ§Øª ğŸ–¥</title>
<script src="https://unpkg.com/html5-qrcode"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Tajawal&display=swap');
body{font-family:"Tajawal",sans-serif;direction:rtl;background:#f0f8ff;margin:0;padding:0;}
h2,h3{text-align:center;color:#0d6efd;margin:15px 0;}
.container{width:95%;max-width:1200px;margin:auto;padding:15px;}
input, button{padding:10px;border-radius:8px;border:1px solid #ccc;font-size:16px;}
button{cursor:pointer;background:#0d6efd;color:#fff;border:none;}
button:hover{background:#084298;}

table{width:100%;border-collapse:collapse;margin-top:15px;font-size:14px;}
th,td{border:1px solid #ccc;padding:8px;text-align:center;white-space:normal;overflow-wrap:break-word;}
th{background:#0d6efd;color:#fff;cursor:pointer;}

tr:nth-child(even){background:#e7f1ff;}
.table-container{overflow-x:auto;width:100%;}
#reader,#readerCart{width:100%;margin:10px auto;display:none;}
.autocomplete{border:1px solid #ccc;border-radius:8px;max-height:150px;overflow-y:auto;background:#fff;position:absolute;z-index:1000;width:95%;}
.autocomplete div{padding:8px;cursor:pointer;}
.autocomplete div:hover{background:#d0e4ff;}
#cartMessage{color:#155724;background:#d4edda;padding:10px;margin-top:10px;border-radius:8px;display:none;text-align:center;}

header {
  background: #007bff;
  color: white;
  padding: 15px;
  text-align: center;
}
nav {
  background: #e9ecef;
  display: flex;
  justify-content: space-around;
  padding: 10px;
}
nav button {
  padding: 10px 20px;
  border: none;
  background: #007bff;
  color: white;
  border-radius: 5px;
  cursor: pointer;
  transition: background 0.3s;
}
nav button:hover {
  background: #0056b3;
}
.content {
  padding: 20px;
}
.form-section {
  display: none;
  background: white;
  padding: 20px;
  border-radius: 10px;
  box-shadow: 0 0 5px #ccc;
  margin-top: 20px;
}
label {
  display: block;
  margin-top: 10px;
}
input, select {
  width: 100%;
  padding: 8px;
  margin-top: 5px;
  border: 1px solid #ccc;
  border-radius: 5px;
}
button.small { padding: 8px 10px; font-size: 14px; }
</style>
</head>
<body>
<header role="banner">
  <h1 style="margin:0; font-size:20px;">Ù†Ø¸Ø§Ù… Ø§Ù„Ø£ØµÙ†Ø§Ù - Ø¹Ø±ÙØ§Øª ğŸ–¥</h1>
</header>

<nav role="navigation" aria-label="Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªÙ†Ù‚Ù„">
  <button type="button" onclick="showSection('ahmad2')">Ø¯Ø®ÙˆÙ„ ğŸ›¸</button>
  <button type="button" onclick="showSection('arafat')">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£ØµÙ†Ø§Ù</button>
</nav>

<main class="container" role="main">
  <section id="ahmad2" class="form-section" aria-hidden="true">
    <h2>ğŸ“¦ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£ØµÙ†Ø§Ù ğŸ›’ Ø§Ù„Ø³Ù„Ø©</h2>
    <nav>
      <button onclick="showSection('arafat')">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£ØµÙ†Ø§Ù</button>
    </nav>
  </section>

  <section id="arafat" class="form-section" aria-hidden="true">
    <h3>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£ØµÙ†Ø§Ù</h3>

    <div id="reader" aria-hidden="true"></div> <!-- Ù…Ø§Ø³Ø­ QR Ù„Ù„Ø£ØµÙ†Ø§Ù -->

    <form id="itemForm" aria-label="Ù†Ù…ÙˆØ°Ø¬ Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù">
      <div style="margin-top:5px; display:flex; gap:10px; flex-wrap:wrap;">
        <div style="flex:1 1 240px; min-width:200px;">
          <label for="itemName">Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù:</label>
          <input type="text" id="itemName" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù" required aria-required="true">
        </div>

        <div style="flex:1 1 240px; min-width:200px;">
          <label for="itemCode">Ø±Ù…Ø² Ø§Ù„ØµÙ†Ù:</label>
          <div style="display:flex; gap:8px;">
            <input type="text" id="itemCode" placeholder="Ø§Ù…Ø³Ø­ Ø£Ùˆ Ø§ÙƒØªØ¨ Ø§Ù„Ø±Ù…Ø²" required style="flex:1;">
            <button type="button" id="scanItemBtn" class="small" aria-pressed="false">ğŸ“· Ù…Ø³Ø­</button>
          </div>
        </div>

        <div style="flex:1 1 240px; min-width:200px;">
          <label for="itemUnit">Ø§Ù„ÙˆØ­Ø¯Ø©:</label>
          <input type="text" id="itemUnit" placeholder="Ø§Ù„ÙˆØ­Ø¯Ø© Ù…Ø«Ù„: Ø­Ø¨Ø©ØŒ ÙƒÙŠÙ„ÙˆØŒ Ù„ØªØ±" required>
        </div>

        <div style="display:flex; gap:10px; width:100%;">
          <div style="flex:1;">
            <label for="itemCost">Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡:</label>
            <input type="text" inputmode="decimal" id="itemCost" placeholder="Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡">
          </div>

          <div style="flex:1;">
            <label for="itemPrice">Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹:</label>
            <input type="text" inputmode="decimal" id="itemPrice" placeholder="Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹">
          </div>
        </div>

        <div style="display:flex; gap:10px; justify-content:center; margin-top:10px; width:100%;">
          <button type="submit">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØµÙ†Ù</button>
          <button type="button" id="cancelItemBtn" style="background:#dc3545;">âŒ Ø¥Ù„ØºØ§Ø¡</button>
        </div>

      </div>
    </form>

    <div id="itemMessage" role="status" aria-live="polite" style="
      display:none;
      color:#856404;
      background:#fff3cd;
      padding:15px 20px;
      margin:20px auto;
      border-radius:10px;
      text-align:center;
      font-size:18px;
      font-weight:bold;
      width:fit-content;
      box-shadow: 0 0 10px rgba(0,0,3,0.2);
    "></div>

    <div style="margin-top:5px; display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
      <select id="sortSelect" aria-label="ÙØ±Ø² Ø§Ù„Ø£ØµÙ†Ø§Ù">
        <option value="">-- ÙØ±Ø² Ø­Ø³Ø¨ --</option>
        <option value="name-asc">Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù ØªØµØ§Ø¹Ø¯ÙŠ</option>
        <option value="name-desc">Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù ØªÙ†Ø§Ø²Ù„ÙŠ</option>
        <option value="code-asc">Ø±Ù…Ø² Ø§Ù„ØµÙ†Ù ØªØµØ§Ø¹Ø¯ÙŠ</option>
        <option value="code-desc">Ø±Ù…Ø² Ø§Ù„ØµÙ†Ù ØªÙ†Ø§Ø²Ù„ÙŠ</option>
        <option value="cost-asc">Ø£Ù‚Ù„ Ø³Ø¹Ø± Ø´Ø±Ø§Ø¡</option>
        <option value="cost-desc">Ø£Ø¹Ù„Ù‰ Ø³Ø¹Ø± Ø´Ø±Ø§Ø¡</option>
        <option value="price-asc">Ø£Ù‚Ù„ Ø³Ø¹Ø± Ø¨ÙŠØ¹</option>
        <option value="price-desc">Ø£Ø¹Ù„Ù‰ Ø³Ø¹Ø± Ø¨ÙŠØ¹</option>
      </select>
      <button id="exportExcelBtn" class="small">ğŸ“¤ Excel</button>
      <input type="file" id="importExcel" accept=".xlsx,.xls" aria-label="Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ù„Ù Excel">
      <input type="text" id="searchInput" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¹Ù† Ø£ÙŠ ØµÙ†Ù" style="flex:1;">
    </div>

    <div id="itemsCount" style="text-align:center; font-weight:bold; margin-bottom:10px;">
      Ø¹Ø¯Ø¯ Ø§Ù„Ø£ØµÙ†Ø§Ù: 0
    </div>

    <div class="table-container" role="region" aria-label="Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£ØµÙ†Ø§Ù">
      <table id="itemsTable" role="table">
        <thead>
          <tr>
            <th scope="col">Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù</th>
            <th scope="col">Ø±Ù…Ø² Ø§Ù„ØµÙ†Ù</th>
            <th scope="col">Ø§Ù„ÙˆØ­Ø¯Ø©</th>
            <th scope="col">Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡</th>
            <th scope="col">Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹</th>
            <th scope="col">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <hr>
  </section>
</main>

<!-- Ø±Ø³Ø§Ù„Ø© ØªÙ… Ø­ÙØ¶ Ø§Ù„ØµÙ†Ù Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ -->
<div id="saveMessage" role="status" aria-live="polite" style="
  display:none;
  position:fixed;
  top:50%;
  left:50%;
  transform:translate(-50%, -50%);
  background:#d4edda;
  color:#155724;
  border:2px solid #28a745;
  padding:20px 40px;
  font-size:24px;
  font-weight:bold;
  border-radius:10px;
  box-shadow:0 0 15px rgba(0,0,0,0.2);
  z-index:9999;
  text-align:center;
">
  ØªÙ… Ø§Ù„Ø­ÙØ¸ âœ…
</div>

<script>
// ================ Ø¹Ø±Ø¶ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… =================
function showSection(id) {
  document.querySelectorAll('.form-section').forEach(s => {
    s.style.display = 'none';
    s.setAttribute('aria-hidden', 'true');
  });
  const el = document.getElementById(id);
  if (el) {
    el.style.display = 'block';
    el.setAttribute('aria-hidden', 'false');
  }
}

// Ø¹Ø±Ø¶ Ø§ÙØªØ±Ø§Ø¶ÙŠ Ù„Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ù†Ø§Ø³Ø¨ Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
showSection('arafat');

// ================= Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£ØµÙ†Ø§Ù =================
const itemForm = document.getElementById("itemForm");
const itemMessage = document.getElementById("itemMessage");
const itemName = document.getElementById("itemName");
const itemCode = document.getElementById("itemCode");
const itemUnit = document.getElementById("itemUnit");
const itemCost = document.getElementById("itemCost");
const itemPrice = document.getElementById("itemPrice");
const itemsTableBody = document.querySelector("#itemsTable tbody");
let editIndex = null;

// ---------- Ø¯ÙˆØ§Ù„ ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… ----------
function formatWithCommas(val) {
  if (val === undefined || val === null || val === "") return "";
  const s = String(val).replace(/,/g, "");
  if (s === "") return "";
  const n = Number(s);
  if (isNaN(n)) return String(val);
  return n.toLocaleString(); // Ø³ÙŠØ³ØªØ®Ø¯Ù… ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù„ØºØ© Ø§Ù„Ù…Ø­Ù„ÙŠØ©
}

function stripCommas(val) {
  if (val === undefined || val === null) return "";
  return String(val).replace(/,/g, "").trim();
}

// ØªÙ‡ÙŠØ¦Ø© Ø³Ù„ÙˆÙƒ Ø§Ù„Ø­Ù‚ÙˆÙ„ (Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡ØŒ Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹) Ù„Ø¹Ø±Ø¶ ÙÙˆØ§ØµÙ„ Ø§Ù„Ø¢Ù„Ø§Ù Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„
function bindNumberFormatting(input) {
  input.addEventListener('input', () => {
    const original = input.value;
    let cleaned = String(original).replace(/[^\d\.\-]/g, "");
    const parts = cleaned.split('.');
    if (parts.length > 2) {
      cleaned = parts.shift() + '.' + parts.join('');
    }
    const [intPart, decPart] = cleaned.split('.');
    let intClean = intPart ? intPart.replace(/^0+(?=\d)/, '') : '';
    if (intClean === "") intClean = intPart && intPart.includes('0') ? "0" : "";
    const formattedInt = intClean === "" ? "" : Number(intClean).toLocaleString();
    input.value = decPart !== undefined ? (formattedInt + '.' + decPart) : formattedInt;
  });
  input.addEventListener('blur', () => {
    if (input.value.trim() === "") return;
    const raw = stripCommas(input.value);
    input.value = formatWithCommas(raw);
  });
}

bindNumberFormatting(itemCost);
bindNumberFormatting(itemPrice);

// ================= ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£ØµÙ†Ø§Ù ÙˆØ¹Ø±Ø¶Ù‡Ø§ =================
function loadItems() {
  let items = JSON.parse(localStorage.getItem("itemsList") || "[]");
  const sortValue = document.getElementById("sortSelect").value;
  if (sortValue) {
    const [field,order] = sortValue.split("-");
    items.sort((a,b) => {
      if (field === "name" || field === "code") {
        return order === "asc" ? (a[field]||"").localeCompare(b[field]||"") : (b[field]||"").localeCompare(a[field]||"");
      }
      const an = Number(stripCommas(a[field] || 0));
      const bn = Number(stripCommas(b[field] || 0));
      return order === "asc" ? an - bn : bn - an;
    });
  }
  itemsTableBody.innerHTML = "";
  items.forEach((it,i) => {
    const tr = document.createElement("tr");
    const costDisplay = formatWithCommas(it.cost);
    const priceDisplay = formatWithCommas(it.price);
    tr.innerHTML = `<td>${escapeHtml(it.name)}</td><td>${escapeHtml(it.code)}</td><td>${escapeHtml(it.unit)}</td><td>${costDisplay||''}</td><td>${priceDisplay||''}</td>
      <td><div style="display:flex; gap:4px; justify-content:center;">
      <button type="button" onclick="editItem(${i})">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
      <button type="button" onclick="deleteItem(${i})" style="background:#dc3545;">ğŸ—‘ï¸ Ø­Ø°Ù</button>
      </div></td>`;
    itemsTableBody.appendChild(tr);
  });
  updateItemsCount();
}
loadItems();

// Ù‡Ø±ÙˆØ¨ Ø¨Ø³ÙŠØ· Ù„Ø­Ù…Ø§ÙŠØ© Ø¥Ø¯Ø±Ø§Ø¬ HTML ÙÙŠ Ø§Ù„Ø®Ù„Ø§ÙŠØ§
function escapeHtml(text) {
  if (!text && text !== 0) return "";
  return String(text)
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#039;");
}

// ---------- ØªÙˆØ¬ÙŠÙ‡ Ø§Ù„ØªØ±ÙƒÙŠØ² Ù„Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„ÙØ§Ø±ØºØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© ----------
function focusFirstEmptyField() {
  const required = [
    {el: itemName, name: "Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù"},
    {el: itemCode, name: "Ø±Ù…Ø² Ø§Ù„ØµÙ†Ù"},
    {el: itemUnit, name: "Ø§Ù„ÙˆØ­Ø¯Ø©"}
  ];
  for (let f of required) {
    if (!f.el.value || !String(f.el.value).trim()) {
      f.el.focus();
      f.el.style.border = "2px solid #dc3545";
      f.el.style.background = "#f8d7da";
      return {found:true, name:f.name};
    }
  }
  return {found:false};
}

itemForm.addEventListener("submit", e=>{
  e.preventDefault();

  // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
  const emptyCheck = focusFirstEmptyField();
  if (emptyCheck.found) {
    alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø­Ù‚Ù„: " + emptyCheck.name);
    return;
  }

  let items = JSON.parse(localStorage.getItem("itemsList") || "[]");
  const nameExists = items.some((it,i)=>it.name===itemName.value && i!==editIndex);
  if (nameExists && !confirm("âš ï¸ Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹! Ø§Ø³ØªÙ…Ø± Ø£Ù… Ø±Ø¬ÙˆØ¹ØŸ")) return;
  const codeExists = items.some((it,i)=>it.code===itemCode.value && i!==editIndex);
  if (codeExists){ alert("âš ï¸ Ø§Ù„Ø±Ù…Ø² Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ù‹Ø§!"); return; }

  // Ø­Ø°Ù Ø§Ù„ÙÙˆØ§ØµÙ„ Ù…Ù† Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø±Ù‚Ù…ÙŠØ©
  const rawCost = stripCommas(itemCost.value);
  const rawPrice = stripCommas(itemPrice.value);

  const newItem = {
    name: itemName.value.trim(),
    code: itemCode.value.trim(),
    unit: itemUnit.value.trim(),
    cost: rawCost,
    price: rawPrice
  };

  if (editIndex !== null && editIndex !== undefined) { items[editIndex] = newItem; editIndex = null; }
  else { items.push(newItem); }
  localStorage.setItem("itemsList", JSON.stringify(items));
  itemForm.reset();
  [itemName, itemCode, itemUnit, itemCost, itemPrice].forEach(inp=>{
    inp.style.background = "";
    inp.style.border = "";
  });
  loadItems();

  const saveMessage = document.getElementById("saveMessage");
  saveMessage.style.display = "block";
  setTimeout(() => { saveMessage.style.display = "none"; }, 2000);
});

// ================= Ø¹Ø¯Ø§Ø¯ Ø¹Ø¯Ø¯ Ø§Ù„Ø§ØµÙ†Ø§Ù ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„ =================
function updateItemsCount() {
  const items = JSON.parse(localStorage.getItem("itemsList") || "[]");
  document.getElementById("itemsCount").textContent = `Ø¹Ø¯Ø¯ Ø§Ù„Ø£ØµÙ†Ø§Ù: ${items.length}`;
}

window.editItem = i => {
  let items = JSON.parse(localStorage.getItem("itemsList") || "[]");
  const it = items[i];
  if (it) showItem(it);
  editIndex = i;
};

window.deleteItem = i => {
  let items = JSON.parse(localStorage.getItem("itemsList") || "[]");
  if (confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„ØµÙ†ÙØŸ")) {
    items.splice(i,1);
    localStorage.setItem("itemsList", JSON.stringify(items));
    loadItems();
  }
};

document.getElementById("searchInput").addEventListener("input", ()=>{
  const val = document.getElementById("searchInput").value.trim().toLowerCase();
  document.querySelectorAll("#itemsTable tbody tr").forEach(r=>{
    r.style.display = r.innerText.toLowerCase().includes(val) ? "" : "none";
  });
});
document.getElementById("sortSelect").addEventListener("change", loadItems);

// ================= ØªØ¹Ø¨Ø¦Ø© Ø­Ù‚ÙˆÙ„ Ø§Ù„ØµÙ†Ù Ø¹Ù†Ø¯ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ =================
function showItem(item) {
  itemName.value = item.name || "";
  itemCode.value = item.code || "";
  itemUnit.value = item.unit || "";
  itemCost.value = formatWithCommas(item.cost || "");
  itemPrice.value = formatWithCommas(item.price || "");
  editIndex = null;
}

// ================= Ù…Ø§Ø³Ø­ QR Ù„Ù„Ø£ØµÙ†Ø§Ù =================
let isScanning = false;
const qrReaderEl = document.getElementById("reader");
const scanItemBtn = document.getElementById("scanItemBtn");
let qrScanner = null;

async function ensureQrScanner() {
  if (!qrScanner) {
    qrScanner = new Html5Qrcode("reader");
  }
  return qrScanner;
}

scanItemBtn.onclick = async () => {
  try {
    if (!isScanning) {
      const scanner = await ensureQrScanner();
      let cams = [];
      try { cams = await Html5Qrcode.getCameras(); } catch (err) { cams = []; }
      if (!cams.length) return alert("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ÙƒØ§Ù…ÙŠØ±Ø§");
      let cam = cams.find(c => c.label && c.label.toLowerCase().includes("back"))?.id || cams[0].id;
      qrReaderEl.style.display = "block";
      scanItemBtn.textContent = "â¹ï¸ Ø¥ÙŠÙ‚Ø§Ù";
      scanItemBtn.setAttribute("aria-pressed", "true");
      isScanning = true;

      await scanner.start(
        cam,
        { fps: 15, qrbox: { width: 280, height: 160 } },
        (decoded) => {
          const itemsList = JSON.parse(localStorage.getItem("itemsList") || "[]");
          const item = itemsList.find(i => String(i.code) === String(decoded));

          if (item) {
            showItem(item);
            itemMessage.style.display = "block";
            itemMessage.textContent = "âš ï¸ Ø§Ù„ØµÙ†Ù Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹!";
            setTimeout(()=>{ itemMessage.style.display = "none"; }, 2500);
          } else {
            itemCode.value = decoded;
            itemName.value = "";
            itemUnit.value = "";
            itemCost.value = "";
            itemPrice.value = "";
            itemMessage.style.display = "none";
          }

          // ØªÙˆÙ‚Ù Ø¢Ù„ÙŠ Ø¨Ø¹Ø¯ Ù‚Ø±Ø§Ø¡Ø© Ù†Ø§Ø¬Ø­Ø©
          stopScanner().catch(()=>{});
        },
        (errorMessage) => {
          // ÙŠÙ…ÙƒÙ† ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ø·ÙÙŠÙØ© Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù…Ø³Ø­
        }
      );
    } else {
      await stopScanner();
    }
  } catch (err) {
    console.error(err);
    alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ø§Ø³Ø­: " + (err && err.message ? err.message : err));
    // Ø­Ø§ÙˆÙ„ Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø§Ø³Ø­ Ù„Ùˆ ÙƒØ§Ù† ÙŠØ¹Ù…Ù„ Ø¬Ø²Ø¦ÙŠØ§Ù‹
    try { await stopScanner(); } catch(e){}
  }
};

async function stopScanner() {
  if (!qrScanner) return;
  try {
    await qrScanner.stop();
  } catch (e) {
    // Ù‚Ø¯ ÙŠØ­Ø¯Ø« Ø®Ø·Ø£ Ù„Ùˆ Ø§Ù„Ù…Ø§Ø³Ø­ ØºÙŠØ± Ù†Ø´Ù‘Ø·
  }
  qrReaderEl.style.display = "none";
  scanItemBtn.textContent = "ğŸ“· Ù…Ø³Ø­";
  scanItemBtn.setAttribute("aria-pressed", "false");
  isScanning = false;
}

// ================= Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© =================
function clearItemFields() {
  itemName.value = "";
  itemCode.value = "";
  itemUnit.value = "";
  itemCost.value = "";
  itemPrice.value = "";
  editIndex = null;
  itemMessage.style.display = "none";
  [itemName, itemCode, itemUnit, itemCost, itemPrice].forEach(inp=>{
    inp.style.background = "";
    inp.style.border = "";
  });
}

const cancelItemBtn = document.getElementById("cancelItemBtn");
cancelItemBtn.addEventListener("click", clearItemFields);

// ================= Ø§Ø³ØªÙŠØ±Ø§Ø¯ Excel =================
const importExcelInput = document.getElementById("importExcel");

function getCellValue(obj, keys) {
  for (let k of keys) {
    if (obj[k] !== undefined && obj[k] !== null) {
      return String(obj[k]).trim();
    }
  }
  return "";
}

importExcelInput.addEventListener("change", function (e) {
  const file = e.target.files[0];
  if (!file) return;

  const fileReader = new FileReader();

  fileReader.onload = function (evt) {
    let workbook;
    try {
      workbook = XLSX.read(evt.target.result, { type: "binary" });
    } catch {
      workbook = XLSX.read(new Uint8Array(evt.target.result), { type: "array" });
    }

    const sheet = workbook.Sheets[workbook.SheetNames[0]];
    if (!sheet) return alert("âŒ Ø§Ù„Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­");

    let rows = XLSX.utils.sheet_to_json(sheet, { defval: "" });
    if (!rows.length) return alert("âŒ Ù…Ù„Ù Excel ÙØ§Ø±Øº");

    const mapped = rows.map(row => {
      if (Array.isArray(row)) {
        return {
          name: String(row[0] || "").trim(),
          code: String(row[1] || "").trim(),
          unit: String(row[2] || "").trim(),
          cost: String(row[3] || "").trim(),
          price: String(row[4] || "").trim(),
        };
      } else {
        return {
          name: getCellValue(row, ["name","Ø§Ø³Ù…","Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù"]),
          code: getCellValue(row, ["code","Ø±Ù…Ø²","Ø±Ù…Ø² Ø§Ù„ØµÙ†Ù"]),
          unit: getCellValue(row, ["unit","Ø§Ù„ÙˆØ­Ø¯Ø©"]),
          cost: getCellValue(row, ["cost","Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡"]),
          price: getCellValue(row, ["price","Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹"]),
        };
      }
    });

    let items = JSON.parse(localStorage.getItem("itemsList") || "[]");

    mapped.forEach(im => {
      if (!im.code) return;
      const code = String(im.code).trim();
      const idx = items.findIndex(it => String(it.code).trim() === code);
      const newItem = {
        name: im.name,
        code: code,
        unit: im.unit,
        cost: im.cost,
        price: im.price
      };
      if (idx !== -1) items[idx] = newItem;
      else items.push(newItem);
    });

    localStorage.setItem("itemsList", JSON.stringify(items));
    loadItems();

    showImportMessage("âœ”ï¸ ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù…Ù„Ù ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£ØµÙ†Ø§Ù");
    importExcelInput.value = "";
  };

  fileReader.readAsBinaryString(file);
});

function showImportMessage(text) {
  const msg = document.createElement("div");
  msg.textContent = text;
  msg.style = `
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: #28a745;
    color: white;
    padding: 12px 20px;
    border-radius: 8px;
    font-size: 16px;
    z-index: 9999;
  `;
  document.body.appendChild(msg);
  setTimeout(() => msg.remove(), 3000);
}

// ================= ØªØµØ¯ÙŠØ± Excel =================
document.getElementById("exportExcelBtn").addEventListener("click", function () {
  let items = JSON.parse(localStorage.getItem("itemsList") || "[]");
  if (items.length === 0) {
    alert("âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù„Ù„ØªØµØ¯ÙŠØ±");
    return;
  }
  const worksheet = XLSX.utils.json_to_sheet(items);
  const workbook = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(workbook, worksheet, "Items");
  XLSX.writeFile(workbook, "items.xlsx");
  showExportMessage("âœ”ï¸ ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø¥Ù„Ù‰ Excel");
});

function showExportMessage(text) {
  const msg = document.createElement("div");
  msg.textContent = text;
  msg.style = `
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: #007bff;
    color: white;
    padding: 12px 20px;
    border-radius: 8px;
    font-size: 16px;
    z-index: 9999;
  `;
  document.body.appendChild(msg);
  setTimeout(() => msg.remove(), 3000);
}

// ØªØ­Ø³ÙŠÙ† ØªÙ„ÙˆÙŠÙ† Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø¹Ù†Ø¯ Ø§Ù„ÙƒØªØ§Ø¨Ø©
const fields = ["itemName", "itemCode", "itemUnit", "itemCost", "itemPrice"];
fields.forEach(id => {
  const input = document.getElementById(id);
  input.addEventListener("input", () => {
    if (input.value.trim() !== "") {
      input.style.background = "#d4edda";
      input.style.border = "2px solid #28a745";
    } else {
      input.style.background = "";
      input.style.border = "";
    }
  });
});

// Ù…Ù†Ø¹ ÙÙ‚Ø¯Ø§Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù†Ø¯ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…Ø§Ø³Ø­ Ø£Ùˆ Ø§Ù„ØªÙ†Ù‚Ù„ ØºÙŠØ± Ø§Ù„Ù…ØªÙˆÙ‚Ø¹
window.addEventListener('beforeunload', (e) => {
  if (isScanning) {
    // Ø§Ù…Ù†Ø¹ Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø³Ø±ÙŠØ¹ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù…Ø³Ø­
    e.preventDefault();
    e.returnValue = '';
  }
});
</script>
</body>
</html>
